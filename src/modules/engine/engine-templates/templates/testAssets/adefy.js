function microAjax(e,t){if(this.bindFunction=function(e,t){return function(){return e.apply(t,[t])}},this.stateChange=function(){4==this.request.readyState&&this.callbackFunction(this.request.responseText)},this.getRequest=function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:!1},this.postBody=arguments[2]||"",this.callbackFunction=t,this.url=e,this.request=this.getRequest(),this.request){var n=this.request;n.onreadystatechange=this.bindFunction(this.stateChange,this),""!==this.postBody?(n.open("POST",e,!0),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.setRequestHeader("Connection","close")):n.open("GET",e,!0),n.send(this.postBody)}}function mht(e){var t="";if(16==e.length)for(var n=0;4>n;n++)t+="<span style='font-family: monospace'>["+e[4*n+0].toFixed(4)+","+e[4*n+1].toFixed(4)+","+e[4*n+2].toFixed(4)+","+e[4*n+3].toFixed(4)+"]</span><br>";else{if(9!=e.length)return e.toString();for(var n=0;3>n;n++)t+="<span style='font-family: monospace'>["+e[3*n+0].toFixed(4)+","+e[3*n+1].toFixed(4)+","+e[3*n+2].toFixed(4)+"]</font><br>"}return t}function makeLookAt(e,t,n,r,i,s,o,u,a){var f=$V([e,t,n]),l=$V([r,i,s]),c=$V([o,u,a]),h=f.subtract(l).toUnitVector(),p=c.cross(h).toUnitVector(),d=h.cross(p).toUnitVector(),v=$M([[p.e(1),p.e(2),p.e(3),0],[d.e(1),d.e(2),d.e(3),0],[h.e(1),h.e(2),h.e(3),0],[0,0,0,1]]),m=$M([[1,0,0,-e],[0,1,0,-t],[0,0,1,-n],[0,0,0,1]]);return v.x(m)}function makeOrtho(e,t,n,r,i,s){var o=-(t+e)/(t-e),u=-(r+n)/(r-n),a=-(s+i)/(s-i);return $M([[2/(t-e),0,0,o],[0,2/(r-n),0,u],[0,0,-2/(s-i),a],[0,0,0,1]])}function makePerspective(e,t,n,r){var i=n*Math.tan(e*Math.PI/360),s=-i,o=s*t,u=i*t;return makeFrustum(o,u,s,i,n,r)}function makeFrustum(e,t,n,r,i,s){var o=2*i/(t-e),u=2*i/(r-n),a=(t+e)/(t-e),f=(r+n)/(r-n),l=-(s+i)/(s-i),c=-2*s*i/(s-i);return $M([[o,0,a,0],[0,u,f,0],[0,0,l,c],[0,0,-1,0]])}function makeOrtho(e,t,n,r,i,s){var o=-(t+e)/(t-e),u=-(r+n)/(r-n),a=-(s+i)/(s-i);return $M([[2/(t-e),0,0,o],[0,2/(r-n),0,u],[0,0,-2/(s-i),a],[0,0,0,1]])}!function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return e instanceof x?e:this instanceof x?(this._wrapped=e,void 0):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.5.0";var T=x.each=x.forEach=function(e,t,r){if(null!=e)if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r.push(t.call(n,e,i,s))}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)}),!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}if(T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)}),!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){return t.call(n,e,i,s)?(r=e,!0):void 0}),r},x.filter=x.select=function(e,t,n){var r=[];return null==e?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&r.push(e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return null==e?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){return(i=i&&t.call(r,e,s,o))?void 0:n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return null==e?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){return i||(i=t.call(r,e,s,o))?n:void 0}),!!i)};x.contains=x.include=function(e,t){return null==e?!1:y&&e.indexOf===y?-1!=e.indexOf(t):C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t,n){return x.isEmpty(t)?n?void 0:[]:x[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.findWhere=function(e,t){return x.where(e,t,!0)},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-1/0;var r={computed:-1/0,value:-1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return 1/0;var r={computed:1/0,value:1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(null==t?x.identity:t);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=null==n?x.identity:k(n);for(var i=n.call(r,t),s=0,o=e.length;o>s;){var u=s+o>>>1;n.call(r,e[u])<i?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(null==t||n?1:t))},x.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return t&&x.every(e,x.isArray)?a.apply(n,e):(T(e,function(e){x.isArray(e)||x.isArguments(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n)};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){(t?r&&o[o.length-1]===n:x.contains(o,n))||(o.push(n),s.push(e[r]))}),s},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){return x.unzip.apply(x,u.call(arguments))},x.unzip=function(){for(var e=x.max(x.pluck(arguments,"length").concat(0)),t=new Array(e),n=0;e>n;n++)t[n]=x.pluck(arguments,""+n);return t},x.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;i>r;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=null!=n;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=r?n:e.length;i--;)if(e[i]===t)return i;return-1},x.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);r>i;)s[i++]=e,e+=n;return s};var O=function(){};x.bind=function(e,t){var n,r;if(S&&e.bind===S)return S.apply(e,u.call(arguments,1));if(!x.isFunction(e))throw new TypeError;return n=u.call(arguments,2),r=function(){if(!(this instanceof r))return e.apply(t,n.concat(u.call(arguments)));O.prototype=e.prototype;var i=new O;O.prototype=null;var s=e.apply(i,n.concat(u.call(arguments)));return Object(s)===s?s:i}},x.partial=function(e){var t=u.call(arguments,1);return function(){return e.apply(this,t.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t,n){var r,i,s,o=null,u=0;n||(n={});var a=function(){u=new Date,o=null,s=e.apply(r,i)};return function(){var f=new Date;u||n.leading!==!1||(u=f);var l=t-(f-u);return r=this,i=arguments,0>=l?(clearTimeout(o),o=null,u=f,s=e.apply(r,i)):o||n.trailing===!1||(o=setTimeout(a,l)),s}},x.debounce=function(e,t,n){var r,i=null;return function(){var s=this,o=arguments,u=function(){i=null,n||(r=e.apply(s,o))},a=n&&!i;return clearTimeout(i),i=setTimeout(u,t),a&&(r=e.apply(s,o)),r}},x.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&t.push(n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)void 0===e[n]&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var M=function(e,t,n,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=n.length;s--;)if(n[s]==e)return r[s]==t;var o=e.constructor,u=t.constructor;if(o!==u&&!(x.isFunction(o)&&o instanceof o&&x.isFunction(u)&&u instanceof u))return!1;n.push(e),r.push(t);var a=0,l=!0;if("[object Array]"==i){if(a=e.length,l=a==t.length)for(;a--&&(l=M(e[a],t[a],n,r)););}else{for(var c in e)if(x.has(e,c)&&(a++,!(l=x.has(t,c)&&M(e[c],t[c],n,r))))break;if(l){for(c in t)if(x.has(t,c)&&!(a--))break;l=!a}}return n.pop(),r.pop(),l};x.isEqual=function(e,t){return M(e,t,[],[])},x.isEmpty=function(e){if(null==e)return!0;if(x.isArray(e)||x.isString(e))return 0===e.length;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!(!e||1!==e.nodeType)},x.isArray=w||function(e){return"[object Array]"==f.call(e)},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!(!e||!x.has(e,"callee"))}),"function"!=typeof /./&&(x.isFunction=function(e){return"function"==typeof e}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==f.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return void 0===e},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=Array(Math.max(0,e)),i=0;e>i;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var _={escape:{"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};_.unescape=x.invert(_.escape);var D={escape:new RegExp("["+x.keys(_.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(_.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return null==t?"":(""+t).replace(D[e],function(t){return _[e][t]})}}),x.result=function(e,t){if(null==e)return void 0;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),F.call(this,n.apply(x,e))}})};var P=0;x.uniqueId=function(e){var t=++P+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","  ":"t","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=new RegExp([(n.escape||H).source,(n.interpolate||H).source,(n.evaluate||H).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(j,function(e){return"\\"+B[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=new Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var F=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],F.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return F.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),eval(function(e,t,n,r,i,s){if(i=function(e){return(t>e?"":i(parseInt(e/t)))+((e%=t)>35?String.fromCharCode(e+29):e.toString(36))},!"".replace(/^/,String)){for(;n--;)s[i(n)]=r[n]||i(n);r=[function(e){return s[e]}],i=function(){return"\\w+"},n=1}for(;n--;)r[n]&&(e=e.replace(new RegExp("\\b"+i(n)+"\\b","g"),r[n]));return e}("9 17={3i:'0.1.3',16:1e-6};l v(){}v.23={e:l(i){8(i<1||i>7.4.q)?w:7.4[i-1]},2R:l(){8 7.4.q},1u:l(){8 F.1x(7.2u(7))},24:l(a){9 n=7.4.q;9 V=a.4||a;o(n!=V.q){8 1L}J{o(F.13(7.4[n-1]-V[n-1])>17.16){8 1L}}H(--n);8 2x},1q:l(){8 v.u(7.4)},1b:l(a){9 b=[];7.28(l(x,i){b.19(a(x,i))});8 v.u(b)},28:l(a){9 n=7.4.q,k=n,i;J{i=k-n;a(7.4[i],i+1)}H(--n)},2q:l(){9 r=7.1u();o(r===0){8 7.1q()}8 7.1b(l(x){8 x/r})},1C:l(a){9 V=a.4||a;9 n=7.4.q,k=n,i;o(n!=V.q){8 w}9 b=0,1D=0,1F=0;7.28(l(x,i){b+=x*V[i-1];1D+=x*x;1F+=V[i-1]*V[i-1]});1D=F.1x(1D);1F=F.1x(1F);o(1D*1F===0){8 w}9 c=b/(1D*1F);o(c<-1){c=-1}o(c>1){c=1}8 F.37(c)},1m:l(a){9 b=7.1C(a);8(b===w)?w:(b<=17.16)},34:l(a){9 b=7.1C(a);8(b===w)?w:(F.13(b-F.1A)<=17.16)},2k:l(a){9 b=7.2u(a);8(b===w)?w:(F.13(b)<=17.16)},2j:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x+V[i-1]})},2C:l(a){9 V=a.4||a;o(7.4.q!=V.q){8 w}8 7.1b(l(x,i){8 x-V[i-1]})},22:l(k){8 7.1b(l(x){8 x*k})},x:l(k){8 7.22(k)},2u:l(a){9 V=a.4||a;9 i,2g=0,n=7.4.q;o(n!=V.q){8 w}J{2g+=7.4[n-1]*V[n-1]}H(--n);8 2g},2f:l(a){9 B=a.4||a;o(7.4.q!=3||B.q!=3){8 w}9 A=7.4;8 v.u([(A[1]*B[2])-(A[2]*B[1]),(A[2]*B[0])-(A[0]*B[2]),(A[0]*B[1])-(A[1]*B[0])])},2A:l(){9 m=0,n=7.4.q,k=n,i;J{i=k-n;o(F.13(7.4[i])>F.13(m)){m=7.4[i]}}H(--n);8 m},2Z:l(x){9 a=w,n=7.4.q,k=n,i;J{i=k-n;o(a===w&&7.4[i]==x){a=i+1}}H(--n);8 a},3g:l(){8 S.2X(7.4)},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(y){8(F.13(y-x)<=17.16)?x:y})},1o:l(a){o(a.K){8 a.1o(7)}9 V=a.4||a;o(V.q!=7.4.q){8 w}9 b=0,2b;7.28(l(x,i){2b=x-V[i-1];b+=2b*2b});8 F.1x(b)},3a:l(a){8 a.1h(7)},2T:l(a){8 a.1h(7)},1V:l(t,a){9 V,R,x,y,z;2S(7.4.q){27 2:V=a.4||a;o(V.q!=2){8 w}R=S.1R(t).4;x=7.4[0]-V[0];y=7.4[1]-V[1];8 v.u([V[0]+R[0][0]*x+R[0][1]*y,V[1]+R[1][0]*x+R[1][1]*y]);1I;27 3:o(!a.U){8 w}9 C=a.1r(7).4;R=S.1R(t,a.U).4;x=7.4[0]-C[0];y=7.4[1]-C[1];z=7.4[2]-C[2];8 v.u([C[0]+R[0][0]*x+R[0][1]*y+R[0][2]*z,C[1]+R[1][0]*x+R[1][1]*y+R[1][2]*z,C[2]+R[2][0]*x+R[2][1]*y+R[2][2]*z]);1I;2P:8 w}},1t:l(a){o(a.K){9 P=7.4.2O();9 C=a.1r(P).4;8 v.u([C[0]+(C[0]-P[0]),C[1]+(C[1]-P[1]),C[2]+(C[2]-(P[2]||0))])}1d{9 Q=a.4||a;o(7.4.q!=Q.q){8 w}8 7.1b(l(x,i){8 Q[i-1]+(Q[i-1]-x)})}},1N:l(){9 V=7.1q();2S(V.4.q){27 3:1I;27 2:V.4.19(0);1I;2P:8 w}8 V},2n:l(){8'['+7.4.2K(', ')+']'},26:l(a){7.4=(a.4||a).2O();8 7}};v.u=l(a){9 V=25 v();8 V.26(a)};v.i=v.u([1,0,0]);v.j=v.u([0,1,0]);v.k=v.u([0,0,1]);v.2J=l(n){9 a=[];J{a.19(F.2F())}H(--n);8 v.u(a)};v.1j=l(n){9 a=[];J{a.19(0)}H(--n);8 v.u(a)};l S(){}S.23={e:l(i,j){o(i<1||i>7.4.q||j<1||j>7.4[0].q){8 w}8 7.4[i-1][j-1]},33:l(i){o(i>7.4.q){8 w}8 v.u(7.4[i-1])},2E:l(j){o(j>7.4[0].q){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][j-1])}H(--n);8 v.u(a)},2R:l(){8{2D:7.4.q,1p:7.4[0].q}},2D:l(){8 7.4.q},1p:l(){8 7.4[0].q},24:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(7.4.q!=M.q||7.4[0].q!=M[0].q){8 1L}9 b=7.4.q,15=b,i,G,10=7.4[0].q,j;J{i=15-b;G=10;J{j=10-G;o(F.13(7.4[i][j]-M[i][j])>17.16){8 1L}}H(--G)}H(--b);8 2x},1q:l(){8 S.u(7.4)},1b:l(a){9 b=[],12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;b[i]=[];J{j=10-G;b[i][j]=a(7.4[i][j],i+1,j+1)}H(--G)}H(--12);8 S.u(b)},2i:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4.q==M.q&&7.4[0].q==M[0].q)},2j:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x+M[i-1][j-1]})},2C:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2i(M)){8 w}8 7.1b(l(x,i,j){8 x-M[i-1][j-1]})},2B:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}8(7.4[0].q==M.q)},22:l(a){o(!a.4){8 7.1b(l(x){8 x*a})}9 b=a.1u?2x:1L;9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}o(!7.2B(M)){8 w}9 d=7.4.q,15=d,i,G,10=M[0].q,j;9 e=7.4[0].q,4=[],21,20,c;J{i=15-d;4[i]=[];G=10;J{j=10-G;21=0;20=e;J{c=e-20;21+=7.4[i][c]*M[c][j]}H(--20);4[i][j]=21}H(--G)}H(--d);9 M=S.u(4);8 b?M.2E(1):M},x:l(a){8 7.22(a)},32:l(a,b,c,d){9 e=[],12=c,i,G,j;9 f=7.4.q,1p=7.4[0].q;J{i=c-12;e[i]=[];G=d;J{j=d-G;e[i][j]=7.4[(a+i-1)%f][(b+j-1)%1p]}H(--G)}H(--12);8 S.u(e)},31:l(){9 a=7.4.q,1p=7.4[0].q;9 b=[],12=1p,i,G,j;J{i=1p-12;b[i]=[];G=a;J{j=a-G;b[i][j]=7.4[j][i]}H(--G)}H(--12);8 S.u(b)},1y:l(){8(7.4.q==7.4[0].q)},2A:l(){9 m=0,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(F.13(7.4[i][j])>F.13(m)){m=7.4[i][j]}}H(--G)}H(--12);8 m},2Z:l(x){9 a=w,12=7.4.q,15=12,i,G,10=7.4[0].q,j;J{i=15-12;G=10;J{j=10-G;o(7.4[i][j]==x){8{i:i+1,j:j+1}}}H(--G)}H(--12);8 w},30:l(){o(!7.1y){8 w}9 a=[],n=7.4.q,k=n,i;J{i=k-n;a.19(7.4[i][i])}H(--n);8 v.u(a)},1K:l(){9 M=7.1q(),1c;9 n=7.4.q,k=n,i,1s,1n=7.4[0].q,p;J{i=k-n;o(M.4[i][i]==0){2e(j=i+1;j<k;j++){o(M.4[j][i]!=0){1c=[];1s=1n;J{p=1n-1s;1c.19(M.4[i][p]+M.4[j][p])}H(--1s);M.4[i]=1c;1I}}}o(M.4[i][i]!=0){2e(j=i+1;j<k;j++){9 a=M.4[j][i]/M.4[i][i];1c=[];1s=1n;J{p=1n-1s;1c.19(p<=i?0:M.4[j][p]-M.4[i][p]*a)}H(--1s);M.4[j]=1c}}}H(--n);8 M},3h:l(){8 7.1K()},2z:l(){o(!7.1y()){8 w}9 M=7.1K();9 a=M.4[0][0],n=M.4.q-1,k=n,i;J{i=k-n+1;a=a*M.4[i][i]}H(--n);8 a},3f:l(){8 7.2z()},2y:l(){8(7.1y()&&7.2z()===0)},2Y:l(){o(!7.1y()){8 w}9 a=7.4[0][0],n=7.4.q-1,k=n,i;J{i=k-n+1;a+=7.4[i][i]}H(--n);8 a},3e:l(){8 7.2Y()},1Y:l(){9 M=7.1K(),1Y=0;9 a=7.4.q,15=a,i,G,10=7.4[0].q,j;J{i=15-a;G=10;J{j=10-G;o(F.13(M.4[i][j])>17.16){1Y++;1I}}H(--G)}H(--a);8 1Y},3d:l(){8 7.1Y()},2W:l(a){9 M=a.4||a;o(1g(M[0][0])=='1f'){M=S.u(M).4}9 T=7.1q(),1p=T.4[0].q;9 b=T.4.q,15=b,i,G,10=M[0].q,j;o(b!=M.q){8 w}J{i=15-b;G=10;J{j=10-G;T.4[i][1p+j]=M[i][j]}H(--G)}H(--b);8 T},2w:l(){o(!7.1y()||7.2y()){8 w}9 a=7.4.q,15=a,i,j;9 M=7.2W(S.I(a)).1K();9 b,1n=M.4[0].q,p,1c,2v;9 c=[],2c;J{i=a-1;1c=[];b=1n;c[i]=[];2v=M.4[i][i];J{p=1n-b;2c=M.4[i][p]/2v;1c.19(2c);o(p>=15){c[i].19(2c)}}H(--b);M.4[i]=1c;2e(j=0;j<i;j++){1c=[];b=1n;J{p=1n-b;1c.19(M.4[j][p]-M.4[i][p]*M.4[j][i])}H(--b);M.4[j]=1c}}H(--a);8 S.u(c)},3c:l(){8 7.2w()},2d:l(){8 7.1b(l(x){8 F.2d(x)})},2V:l(x){8 7.1b(l(p){8(F.13(p-x)<=17.16)?x:p})},2n:l(){9 a=[];9 n=7.4.q,k=n,i;J{i=k-n;a.19(v.u(7.4[i]).2n())}H(--n);8 a.2K('\\n')},26:l(a){9 i,4=a.4||a;o(1g(4[0][0])!='1f'){9 b=4.q,15=b,G,10,j;7.4=[];J{i=15-b;G=4[i].q;10=G;7.4[i]=[];J{j=10-G;7.4[i][j]=4[i][j]}H(--G)}H(--b);8 7}9 n=4.q,k=n;7.4=[];J{i=k-n;7.4.19([4[i]])}H(--n);8 7}};S.u=l(a){9 M=25 S();8 M.26(a)};S.I=l(n){9 a=[],k=n,i,G,j;J{i=k-n;a[i]=[];G=k;J{j=k-G;a[i][j]=(i==j)?1:0}H(--G)}H(--n);8 S.u(a)};S.2X=l(a){9 n=a.q,k=n,i;9 M=S.I(n);J{i=k-n;M.4[i][i]=a[i]}H(--n);8 M};S.1R=l(b,a){o(!a){8 S.u([[F.1H(b),-F.1G(b)],[F.1G(b),F.1H(b)]])}9 d=a.1q();o(d.4.q!=3){8 w}9 e=d.1u();9 x=d.4[0]/e,y=d.4[1]/e,z=d.4[2]/e;9 s=F.1G(b),c=F.1H(b),t=1-c;8 S.u([[t*x*x+c,t*x*y-s*z,t*x*z+s*y],[t*x*y+s*z,t*y*y+c,t*y*z-s*x],[t*x*z-s*y,t*y*z+s*x,t*z*z+c]])};S.3b=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[1,0,0],[0,c,-s],[0,s,c]])};S.39=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,0,s],[0,1,0],[-s,0,c]])};S.38=l(t){9 c=F.1H(t),s=F.1G(t);8 S.u([[c,-s,0],[s,c,0],[0,0,1]])};S.2J=l(n,m){8 S.1j(n,m).1b(l(){8 F.2F()})};S.1j=l(n,m){9 a=[],12=n,i,G,j;J{i=n-12;a[i]=[];G=m;J{j=m-G;a[i][j]=0}H(--G)}H(--12);8 S.u(a)};l 14(){}14.23={24:l(a){8(7.1m(a)&&7.1h(a.K))},1q:l(){8 14.u(7.K,7.U)},2U:l(a){9 V=a.4||a;8 14.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.U)},1m:l(a){o(a.W){8 a.1m(7)}9 b=7.U.1C(a.U);8(F.13(b)<=17.16||F.13(b-F.1A)<=17.16)},1o:l(a){o(a.W){8 a.1o(7)}o(a.U){o(7.1m(a)){8 7.1o(a.K)}9 N=7.U.2f(a.U).2q().4;9 A=7.K.4,B=a.K.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,D=7.U.4;9 b=P[0]-A[0],2a=P[1]-A[1],29=(P[2]||0)-A[2];9 c=F.1x(b*b+2a*2a+29*29);o(c===0)8 0;9 d=(b*D[0]+2a*D[1]+29*D[2])/c;9 e=1-d*d;8 F.13(c*F.1x(e<0?0:e))}},1h:l(a){9 b=7.1o(a);8(b!==w&&b<=17.16)},2T:l(a){8 a.1h(7)},1v:l(a){o(a.W){8 a.1v(7)}8(!7.1m(a)&&7.1o(a)<=17.16)},1U:l(a){o(a.W){8 a.1U(7)}o(!7.1v(a)){8 w}9 P=7.K.4,X=7.U.4,Q=a.K.4,Y=a.U.4;9 b=X[0],1z=X[1],1B=X[2],1T=Y[0],1S=Y[1],1M=Y[2];9 c=P[0]-Q[0],2s=P[1]-Q[1],2r=P[2]-Q[2];9 d=-b*c-1z*2s-1B*2r;9 e=1T*c+1S*2s+1M*2r;9 f=b*b+1z*1z+1B*1B;9 g=1T*1T+1S*1S+1M*1M;9 h=b*1T+1z*1S+1B*1M;9 k=(d*g/f+h*e)/(g-h*h);8 v.u([P[0]+k*b,P[1]+k*1z,P[2]+k*1B])},1r:l(a){o(a.U){o(7.1v(a)){8 7.1U(a)}o(7.1m(a)){8 w}9 D=7.U.4,E=a.U.4;9 b=D[0],1l=D[1],1k=D[2],1P=E[0],1O=E[1],1Q=E[2];9 x=(1k*1P-b*1Q),y=(b*1O-1l*1P),z=(1l*1Q-1k*1O);9 N=v.u([x*1Q-y*1O,y*1P-z*1Q,z*1O-x*1P]);9 P=11.u(a.K,N);8 P.1U(7)}1d{9 P=a.4||a;o(7.1h(P)){8 v.u(P)}9 A=7.K.4,D=7.U.4;9 b=D[0],1l=D[1],1k=D[2],1w=A[0],18=A[1],1a=A[2];9 x=b*(P[1]-18)-1l*(P[0]-1w),y=1l*((P[2]||0)-1a)-1k*(P[1]-18),z=1k*(P[0]-1w)-b*((P[2]||0)-1a);9 V=v.u([1l*x-1k*z,1k*y-b*x,b*z-1l*y]);9 k=7.1o(P)/V.1u();8 v.u([P[0]+V.4[0]*k,P[1]+V.4[1]*k,(P[2]||0)+V.4[2]*k])}},1V:l(t,a){o(1g(a.U)=='1f'){a=14.u(a.1N(),v.k)}9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,D=7.U.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 14.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*D[0]+R[0][1]*D[1]+R[0][2]*D[2],R[1][0]*D[0]+R[1][1]*D[1]+R[1][2]*D[2],R[2][0]*D[0]+R[2][1]*D[1]+R[2][2]*D[2]])},1t:l(a){o(a.W){9 A=7.K.4,D=7.U.4;9 b=A[0],18=A[1],1a=A[2],2N=D[0],1l=D[1],1k=D[2];9 c=7.K.1t(a).4;9 d=b+2N,2h=18+1l,2o=1a+1k;9 Q=a.1r([d,2h,2o]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2h)-c[1],Q[2]+(Q[2]-2o)-c[2]];8 14.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 14.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.U)}},1Z:l(a,b){a=v.u(a);b=v.u(b);o(a.4.q==2){a.4.19(0)}o(b.4.q==2){b.4.19(0)}o(a.4.q>3||b.4.q>3){8 w}9 c=b.1u();o(c===0){8 w}7.K=a;7.U=v.u([b.4[0]/c,b.4[1]/c,b.4[2]/c]);8 7}};14.u=l(a,b){9 L=25 14();8 L.1Z(a,b)};14.X=14.u(v.1j(3),v.i);14.Y=14.u(v.1j(3),v.j);14.Z=14.u(v.1j(3),v.k);l 11(){}11.23={24:l(a){8(7.1h(a.K)&&7.1m(a))},1q:l(){8 11.u(7.K,7.W)},2U:l(a){9 V=a.4||a;8 11.u([7.K.4[0]+V[0],7.K.4[1]+V[1],7.K.4[2]+(V[2]||0)],7.W)},1m:l(a){9 b;o(a.W){b=7.W.1C(a.W);8(F.13(b)<=17.16||F.13(F.1A-b)<=17.16)}1d o(a.U){8 7.W.2k(a.U)}8 w},2k:l(a){9 b=7.W.1C(a.W);8(F.13(F.1A/2-b)<=17.16)},1o:l(a){o(7.1v(a)||7.1h(a)){8 0}o(a.K){9 A=7.K.4,B=a.K.4,N=7.W.4;8 F.13((A[0]-B[0])*N[0]+(A[1]-B[1])*N[1]+(A[2]-B[2])*N[2])}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;8 F.13((A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2])}},1h:l(a){o(a.W){8 w}o(a.U){8(7.1h(a.K)&&7.1h(a.K.2j(a.U)))}1d{9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=F.13(N[0]*(A[0]-P[0])+N[1]*(A[1]-P[1])+N[2]*(A[2]-(P[2]||0)));8(b<=17.16)}},1v:l(a){o(1g(a.U)=='1f'&&1g(a.W)=='1f'){8 w}8!7.1m(a)},1U:l(a){o(!7.1v(a)){8 w}o(a.U){9 A=a.K.4,D=a.U.4,P=7.K.4,N=7.W.4;9 b=(N[0]*(P[0]-A[0])+N[1]*(P[1]-A[1])+N[2]*(P[2]-A[2]))/(N[0]*D[0]+N[1]*D[1]+N[2]*D[2]);8 v.u([A[0]+D[0]*b,A[1]+D[1]*b,A[2]+D[2]*b])}1d o(a.W){9 c=7.W.2f(a.W).2q();9 N=7.W.4,A=7.K.4,O=a.W.4,B=a.K.4;9 d=S.1j(2,2),i=0;H(d.2y()){i++;d=S.u([[N[i%3],N[(i+1)%3]],[O[i%3],O[(i+1)%3]]])}9 e=d.2w().4;9 x=N[0]*A[0]+N[1]*A[1]+N[2]*A[2];9 y=O[0]*B[0]+O[1]*B[1]+O[2]*B[2];9 f=[e[0][0]*x+e[0][1]*y,e[1][0]*x+e[1][1]*y];9 g=[];2e(9 j=1;j<=3;j++){g.19((i==j)?0:f[(j+(5-i)%3)%3])}8 14.u(g,c)}},1r:l(a){9 P=a.4||a;9 A=7.K.4,N=7.W.4;9 b=(A[0]-P[0])*N[0]+(A[1]-P[1])*N[1]+(A[2]-(P[2]||0))*N[2];8 v.u([P[0]+N[0]*b,P[1]+N[1]*b,(P[2]||0)+N[2]*b])},1V:l(t,a){9 R=S.1R(t,a.U).4;9 C=a.1r(7.K).4;9 A=7.K.4,N=7.W.4;9 b=C[0],1E=C[1],1J=C[2],1w=A[0],18=A[1],1a=A[2];9 x=1w-b,y=18-1E,z=1a-1J;8 11.u([b+R[0][0]*x+R[0][1]*y+R[0][2]*z,1E+R[1][0]*x+R[1][1]*y+R[1][2]*z,1J+R[2][0]*x+R[2][1]*y+R[2][2]*z],[R[0][0]*N[0]+R[0][1]*N[1]+R[0][2]*N[2],R[1][0]*N[0]+R[1][1]*N[1]+R[1][2]*N[2],R[2][0]*N[0]+R[2][1]*N[1]+R[2][2]*N[2]])},1t:l(a){o(a.W){9 A=7.K.4,N=7.W.4;9 b=A[0],18=A[1],1a=A[2],2M=N[0],2L=N[1],2Q=N[2];9 c=7.K.1t(a).4;9 d=b+2M,2p=18+2L,2m=1a+2Q;9 Q=a.1r([d,2p,2m]).4;9 e=[Q[0]+(Q[0]-d)-c[0],Q[1]+(Q[1]-2p)-c[1],Q[2]+(Q[2]-2m)-c[2]];8 11.u(c,e)}1d o(a.U){8 7.1V(F.1A,a)}1d{9 P=a.4||a;8 11.u(7.K.1t([P[0],P[1],(P[2]||0)]),7.W)}},1Z:l(a,b,c){a=v.u(a);a=a.1N();o(a===w){8 w}b=v.u(b);b=b.1N();o(b===w){8 w}o(1g(c)=='1f'){c=w}1d{c=v.u(c);c=c.1N();o(c===w){8 w}}9 d=a.4[0],18=a.4[1],1a=a.4[2];9 e=b.4[0],1W=b.4[1],1X=b.4[2];9 f,1i;o(c!==w){9 g=c.4[0],2l=c.4[1],2t=c.4[2];f=v.u([(1W-18)*(2t-1a)-(1X-1a)*(2l-18),(1X-1a)*(g-d)-(e-d)*(2t-1a),(e-d)*(2l-18)-(1W-18)*(g-d)]);1i=f.1u();o(1i===0){8 w}f=v.u([f.4[0]/1i,f.4[1]/1i,f.4[2]/1i])}1d{1i=F.1x(e*e+1W*1W+1X*1X);o(1i===0){8 w}f=v.u([b.4[0]/1i,b.4[1]/1i,b.4[2]/1i])}7.K=a;7.W=f;8 7}};11.u=l(a,b,c){9 P=25 11();8 P.1Z(a,b,c)};11.2I=11.u(v.1j(3),v.k);11.2H=11.u(v.1j(3),v.i);11.2G=11.u(v.1j(3),v.j);11.36=11.2I;11.35=11.2H;11.3j=11.2G;9 $V=v.u;9 $M=S.u;9 $L=14.u;9 $P=11.u;",62,206,"||||elements|||this|return|var||||||||||||function|||if||length||||create|Vector|null|||||||||Math|nj|while||do|anchor||||||||Matrix||direction||normal||||kj|Plane|ni|abs|Line|ki|precision|Sylvester|A2|push|A3|map|els|else||undefined|typeof|contains|mod|Zero|D3|D2|isParallelTo|kp|distanceFrom|cols|dup|pointClosestTo|np|reflectionIn|modulus|intersects|A1|sqrt|isSquare|X2|PI|X3|angleFrom|mod1|C2|mod2|sin|cos|break|C3|toRightTriangular|false|Y3|to3D|E2|E1|E3|Rotation|Y2|Y1|intersectionWith|rotate|v12|v13|rank|setVectors|nc|sum|multiply|prototype|eql|new|setElements|case|each|PA3|PA2|part|new_element|round|for|cross|product|AD2|isSameSizeAs|add|isPerpendicularTo|v22|AN3|inspect|AD3|AN2|toUnitVector|PsubQ3|PsubQ2|v23|dot|divisor|inverse|true|isSingular|determinant|max|canMultiplyFromLeft|subtract|rows|col|random|ZX|YZ|XY|Random|join|N2|N1|D1|slice|default|N3|dimensions|switch|liesIn|translate|snapTo|augment|Diagonal|trace|indexOf|diagonal|transpose|minor|row|isAntiparallelTo|ZY|YX|acos|RotationZ|RotationY|liesOn|RotationX|inv|rk|tr|det|toDiagonalMatrix|toUpperTriangular|version|XZ".split("|"),0,{})),Matrix.Translation=function(e){if(2==e.elements.length){var t=Matrix.I(3);return t.elements[2][0]=e.elements[0],t.elements[2][1]=e.elements[1],t}if(3==e.elements.length){var t=Matrix.I(4);return t.elements[0][3]=e.elements[0],t.elements[1][3]=e.elements[1],t.elements[2][3]=e.elements[2],t}throw"Invalid length for Translation"},Matrix.prototype.flatten=function(){var e=[];if(0==this.elements.length)return[];for(var t=0;t<this.elements[0].length;t++)for(var n=0;n<this.elements.length;n++)e.push(this.elements[n][t]);return e},Matrix.prototype.ensure4x4=function(){if(4==this.elements.length&&4==this.elements[0].length)return this;if(this.elements.length>4||this.elements[0].length>4)return null;for(var e=0;e<this.elements.length;e++)for(var t=this.elements[e].length;4>t;t++)e==t?this.elements[e].push(1):this.elements[e].push(0);for(var e=this.elements.length;4>e;e++)0==e?this.elements.push([1,0,0,0]):1==e?this.elements.push([0,1,0,0]):2==e?this.elements.push([0,0,1,0]):3==e&&this.elements.push([0,0,0,1]);return this},Matrix.prototype.make3x3=function(){return 4!=this.elements.length||4!=this.elements[0].length?null:Matrix.create([[this.elements[0][0],this.elements[0][1],this.elements[0][2]],[this.elements[1][0],this.elements[1][1],this.elements[1][2]],[this.elements[2][0],this.elements[2][1],this.elements[2][2]]])},Vector.prototype.flatten=function(){return this.elements},function(e){"use strict";var t={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(t.exports={},define(function(){return t.exports})):t.exports="undefined"!=typeof window?window:e:t.exports=exports,function(e){if(!t)var t=1e-6;if(!n)var n="undefined"!=typeof Float32Array?Float32Array:Array;if(!r)var r=Math.random;var i={};i.setMatrixArrayType=function(e){n=e},"undefined"!=typeof e&&(e.glMatrix=i);var s={};s.create=function(){var e=new n(2);return e[0]=0,e[1]=0,e},s.clone=function(e){var t=new n(2);return t[0]=e[0],t[1]=e[1],t},s.fromValues=function(e,t){var r=new n(2);return r[0]=e,r[1]=t,r},s.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},s.set=function(e,t,n){return e[0]=t,e[1]=n,e},s.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},s.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},s.sub=s.subtract,s.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},s.mul=s.multiply,s.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},s.div=s.divide,s.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},s.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},s.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},s.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},s.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)},s.dist=s.distance,s.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r},s.sqrDist=s.squaredDistance,s.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},s.len=s.length,s.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},s.sqrLen=s.squaredLength,s.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},s.normalize=function(e,t){var n=t[0],r=t[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e},s.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},s.cross=function(e,t,n){var r=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=r,e},s.lerp=function(e,t,n,r){var i=t[0],s=t[1];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},s.random=function(e,t){t=t||1;var n=2*r()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},s.transformMat2=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i,e[1]=n[1]*r+n[3]*i,e},s.transformMat2d=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i+n[4],e[1]=n[1]*r+n[3]*i+n[5],e},s.transformMat3=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[3]*i+n[6],e[1]=n[1]*r+n[4]*i+n[7],e},s.transformMat4=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e},s.forEach=function(){var e=s.create();return function(t,n,r,i,s,o){var u,a;for(n||(n=2),r||(r=0),a=i?Math.min(i*n+r,t.length):t.length,u=r;a>u;u+=n)e[0]=t[u],e[1]=t[u+1],s(e,e,o),t[u]=e[0],t[u+1]=e[1];return t}}(),s.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},"undefined"!=typeof e&&(e.vec2=s);var o={};o.create=function(){var e=new n(3);return e[0]=0,e[1]=0,e[2]=0,e},o.clone=function(e){var t=new n(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.fromValues=function(e,t,r){var i=new n(3);return i[0]=e,i[1]=t,i[2]=r,i},o.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},o.set=function(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e},o.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},o.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e},o.sub=o.subtract,o.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e},o.mul=o.multiply,o.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e},o.div=o.divide,o.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},o.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},o.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},o.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e},o.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)},o.dist=o.distance,o.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return n*n+r*r+i*i},o.sqrDist=o.squaredDistance,o.length=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)},o.len=o.length,o.squaredLength=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r},o.sqrLen=o.squaredLength,o.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},o.normalize=function(e,t){var n=t[0],r=t[1],i=t[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s),e},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},o.cross=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2];return e[0]=i*a-s*u,e[1]=s*o-r*a,e[2]=r*u-i*o,e},o.lerp=function(e,t,n,r){var i=t[0],s=t[1],o=t[2];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e[2]=o+r*(n[2]-o),e},o.random=function(e,t){t=t||1;var n=2*r()*Math.PI,i=2*r()-1,s=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(n)*s,e[1]=Math.sin(n)*s,e[2]=i*t,e},o.transformMat4=function(e,t,n){var r=t[0],i=t[1],s=t[2];return e[0]=n[0]*r+n[4]*i+n[8]*s+n[12],e[1]=n[1]*r+n[5]*i+n[9]*s+n[13],e[2]=n[2]*r+n[6]*i+n[10]*s+n[14],e},o.transformMat3=function(e,t,n){var r=t[0],i=t[1],s=t[2];return e[0]=r*n[0]+i*n[3]+s*n[6],e[1]=r*n[1]+i*n[4]+s*n[7],e[2]=r*n[2]+i*n[5]+s*n[8],e},o.transformQuat=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2],f=n[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return e[0]=l*f+p*-o+c*-a-h*-u,e[1]=c*f+p*-u+h*-o-l*-a,e[2]=h*f+p*-a+l*-u-c*-o,e},o.forEach=function(){var e=o.create();return function(t,n,r,i,s,o){var u,a;for(n||(n=3),r||(r=0),a=i?Math.min(i*n+r,t.length):t.length,u=r;a>u;u+=n)e[0]=t[u],e[1]=t[u+1],e[2]=t[u+2],s(e,e,o),t[u]=e[0],t[u+1]=e[1],t[u+2]=e[2];return t}}(),o.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},"undefined"!=typeof e&&(e.vec3=o);var u={};u.create=function(){var e=new n(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},u.clone=function(e){var t=new n(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},u.fromValues=function(e,t,r,i){var s=new n(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s},u.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},u.set=function(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e},u.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},u.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e},u.sub=u.subtract,u.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e},u.mul=u.multiply,u.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e},u.div=u.divide,u.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},u.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},u.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},u.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},u.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return Math.sqrt(n*n+r*r+i*i+s*s)},u.dist=u.distance,u.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return n*n+r*r+i*i+s*s},u.sqrDist=u.squaredDistance,u.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},u.len=u.length,u.squaredLength=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i},u.sqrLen=u.squaredLength,u.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},u.normalize=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*n+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o),e},u.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},u.lerp=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=t[3];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e[2]=o+r*(n[2]-o),e[3]=u+r*(n[3]-u),e},u.random=function(e,t){return t=t||1,e[0]=r(),e[1]=r(),e[2]=r(),e[3]=r(),u.normalize(e,e),u.scale(e,e,t),e},u.transformMat4=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3];return e[0]=n[0]*r+n[4]*i+n[8]*s+n[12]*o,e[1]=n[1]*r+n[5]*i+n[9]*s+n[13]*o,e[2]=n[2]*r+n[6]*i+n[10]*s+n[14]*o,e[3]=n[3]*r+n[7]*i+n[11]*s+n[15]*o,e},u.transformQuat=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2],f=n[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return e[0]=l*f+p*-o+c*-a-h*-u,e[1]=c*f+p*-u+h*-o-l*-a,e[2]=h*f+p*-a+l*-u-c*-o,e},u.forEach=function(){var e=u.create();return function(t,n,r,i,s,o){var u,a;for(n||(n=4),r||(r=0),a=i?Math.min(i*n+r,t.length):t.length,u=r;a>u;u+=n)e[0]=t[u],e[1]=t[u+1],e[2]=t[u+2],e[3]=t[u+3],s(e,e,o),t[u]=e[0],t[u+1]=e[1],t[u+2]=e[2],t[u+3]=e[3];return t}}(),u.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},"undefined"!=typeof e&&(e.vec4=u);var a={};a.create=function(){var e=new n(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},a.clone=function(e){var t=new n(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},a.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},a.transpose=function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},a.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*s-i*r;return o?(o=1/o,e[0]=s*o,e[1]=-r*o,e[2]=-i*o,e[3]=n*o,e):null},a.adjoint=function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},a.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},a.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1],f=n[2],l=n[3];return e[0]=r*u+i*f,e[1]=r*a+i*l,e[2]=s*u+o*f,e[3]=s*a+o*l,e},a.mul=a.multiply,a.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+i*u,e[1]=r*-u+i*a,e[2]=s*a+o*u,e[3]=s*-u+o*a,e},a.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1];return e[0]=r*u,e[1]=i*a,e[2]=s*u,e[3]=o*a,e},a.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},"undefined"!=typeof e&&(e.mat2=a);var f={};f.create=function(){var e=new n(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},f.clone=function(e){var t=new n(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},f.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},f.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},f.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=n*s-r*i;return a?(a=1/a,e[0]=s*a,e[1]=-r*a,e[2]=-i*a,e[3]=n*a,e[4]=(i*u-s*o)*a,e[5]=(r*o-n*u)*a,e):null},f.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},f.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5];return e[0]=r*f+i*c,e[1]=r*l+i*h,e[2]=s*f+o*c,e[3]=s*l+o*h,e[4]=f*u+c*a+p,e[5]=l*u+h*a+d,e},f.mul=f.multiply,f.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=Math.sin(n),l=Math.cos(n);return e[0]=r*l+i*f,e[1]=-r*f+i*l,e[2]=s*l+o*f,e[3]=-s*f+l*o,e[4]=l*u+f*a,e[5]=l*a-f*u,e},f.scale=function(e,t,n){var r=n[0],i=n[1];return e[0]=t[0]*r,e[1]=t[1]*i,e[2]=t[2]*r,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*i,e},f.translate=function(e,t,n){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4]+n[0],e[5]=t[5]+n[1],e},f.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},"undefined"!=typeof e&&(e.mat2d=f);var l={};l.create=function(){var e=new n(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},l.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},l.clone=function(e){var t=new n(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},l.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},l.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},l.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},l.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p;return d?(d=1/d,e[0]=c*d,e[1]=(-l*r+i*f)*d,e[2]=(u*r-i*o)*d,e[3]=h*d,e[4]=(l*n-i*a)*d,e[5]=(-u*n+i*s)*d,e[6]=p*d,e[7]=(-f*n+r*a)*d,e[8]=(o*n-r*s)*d,e):null},l.adjoint=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return e[0]=o*l-u*f,e[1]=i*f-r*l,e[2]=r*u-i*o,e[3]=u*a-s*l,e[4]=n*l-i*a,e[5]=i*s-n*u,e[6]=s*f-o*a,e[7]=r*a-n*f,e[8]=n*o-r*s,e},l.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*(f*s-o*a)+n*(-f*i+o*u)+r*(a*i-s*u)},l.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1],d=n[2],v=n[3],m=n[4],g=n[5],y=n[6],b=n[7],w=n[8];return e[0]=h*r+p*o+d*f,e[1]=h*i+p*u+d*l,e[2]=h*s+p*a+d*c,e[3]=v*r+m*o+g*f,e[4]=v*i+m*u+g*l,e[5]=v*s+m*a+g*c,e[6]=y*r+b*o+w*f,e[7]=y*i+b*u+w*l,e[8]=y*s+b*a+w*c,e},l.mul=l.multiply,l.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1];return e[0]=r,e[1]=i,e[2]=s,e[3]=o,e[4]=u,e[5]=a,e[6]=h*r+p*o+f,e[7]=h*i+p*u+l,e[8]=h*s+p*a+c,e},l.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=Math.sin(n),p=Math.cos(n);return e[0]=p*r+h*o,e[1]=p*i+h*u,e[2]=p*s+h*a,e[3]=p*o-h*r,e[4]=p*u-h*i,e[5]=p*a-h*s,e[6]=f,e[7]=l,e[8]=c,e},l.scale=function(e,t,n){var r=n[0],i=n[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},l.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},l.fromQuat=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return e[0]=1-(h+d),e[3]=l+g,e[6]=c-m,e[1]=l-g,e[4]=1-(f+d),e[7]=p+v,e[2]=c+m,e[5]=p-v,e[8]=1-(f+h),e},l.normalFromMat4=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T;return O?(O=1/O,e[0]=(u*A-a*L+f*k)*O,e[1]=(a*C-o*A-f*N)*O,e[2]=(o*L-u*C+f*T)*O,e[3]=(i*L-r*A-s*k)*O,e[4]=(n*A-i*C+s*N)*O,e[5]=(r*C-n*L-s*T)*O,e[6]=(v*x-m*S+g*E)*O,e[7]=(m*w-d*x-g*b)*O,e[8]=(d*S-v*w+g*y)*O,e):null},l.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},"undefined"!=typeof e&&(e.mat3=l);var c={};c.create=function(){var e=new n(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},c.clone=function(e){var t=new n(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},c.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},c.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},c.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],s=t[6],o=t[7],u=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=s,e[11]=t[14],e[12]=i,e[13]=o,e[14]=u}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},c.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T;return O?(O=1/O,e[0]=(u*A-a*L+f*k)*O,e[1]=(i*L-r*A-s*k)*O,e[2]=(v*x-m*S+g*E)*O,e[3]=(h*S-c*x-p*E)*O,e[4]=(a*C-o*A-f*N)*O,e[5]=(n*A-i*C+s*N)*O,e[6]=(m*w-d*x-g*b)*O,e[7]=(l*x-h*w+p*b)*O,e[8]=(o*L-u*C+f*T)*O,e[9]=(r*C-n*L-s*T)*O,e[10]=(d*S-v*w+g*y)*O,e[11]=(c*w-l*S-p*y)*O,e[12]=(u*N-o*k-a*T)*O,e[13]=(n*k-r*N+i*T)*O,e[14]=(v*b-d*E-m*y)*O,e[15]=(l*E-c*b+h*y)*O,e):null},c.adjoint=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15];return e[0]=u*(h*g-p*m)-c*(a*g-f*m)+v*(a*p-f*h),e[1]=-(r*(h*g-p*m)-c*(i*g-s*m)+v*(i*p-s*h)),e[2]=r*(a*g-f*m)-u*(i*g-s*m)+v*(i*f-s*a),e[3]=-(r*(a*p-f*h)-u*(i*p-s*h)+c*(i*f-s*a)),e[4]=-(o*(h*g-p*m)-l*(a*g-f*m)+d*(a*p-f*h)),e[5]=n*(h*g-p*m)-l*(i*g-s*m)+d*(i*p-s*h),e[6]=-(n*(a*g-f*m)-o*(i*g-s*m)+d*(i*f-s*a)),e[7]=n*(a*p-f*h)-o*(i*p-s*h)+l*(i*f-s*a),e[8]=o*(c*g-p*v)-l*(u*g-f*v)+d*(u*p-f*c),e[9]=-(n*(c*g-p*v)-l*(r*g-s*v)+d*(r*p-s*c)),e[10]=n*(u*g-f*v)-o*(r*g-s*v)+d*(r*f-s*u),e[11]=-(n*(u*p-f*c)-o*(r*p-s*c)+l*(r*f-s*u)),e[12]=-(o*(c*m-h*v)-l*(u*m-a*v)+d*(u*h-a*c)),e[13]=n*(c*m-h*v)-l*(r*m-i*v)+d*(r*h-i*c),e[14]=-(n*(u*m-a*v)-o*(r*m-i*v)+d*(r*a-i*u)),e[15]=n*(u*h-a*c)-o*(r*h-i*c)+l*(r*a-i*u),e},c.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15],g=t*o-n*s,y=t*u-r*s,b=t*a-i*s,w=n*u-r*o,E=n*a-i*o,S=r*a-i*u,x=f*d-l*p,T=f*v-c*p,N=f*m-h*p,C=l*v-c*d,k=l*m-h*d,L=c*m-h*v;return g*L-y*k+b*C+w*N-E*T+S*x},c.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15],b=n[0],w=n[1],E=n[2],S=n[3];return e[0]=b*r+w*u+E*c+S*v,e[1]=b*i+w*a+E*h+S*m,e[2]=b*s+w*f+E*p+S*g,e[3]=b*o+w*l+E*d+S*y,b=n[4],w=n[5],E=n[6],S=n[7],e[4]=b*r+w*u+E*c+S*v,e[5]=b*i+w*a+E*h+S*m,e[6]=b*s+w*f+E*p+S*g,e[7]=b*o+w*l+E*d+S*y,b=n[8],w=n[9],E=n[10],S=n[11],e[8]=b*r+w*u+E*c+S*v,e[9]=b*i+w*a+E*h+S*m,e[10]=b*s+w*f+E*p+S*g,e[11]=b*o+w*l+E*d+S*y,b=n[12],w=n[13],E=n[14],S=n[15],e[12]=b*r+w*u+E*c+S*v,e[13]=b*i+w*a+E*h+S*m,e[14]=b*s+w*f+E*p+S*g,e[15]=b*o+w*l+E*d+S*y,e},c.mul=c.multiply,c.translate=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v=n[0],m=n[1],g=n[2];return t===e?(e[12]=t[0]*v+t[4]*m+t[8]*g+t[12],e[13]=t[1]*v+t[5]*m+t[9]*g+t[13],e[14]=t[2]*v+t[6]*m+t[10]*g+t[14],e[15]=t[3]*v+t[7]*m+t[11]*g+t[15]):(r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],e[0]=r,e[1]=i,e[2]=s,e[3]=o,e[4]=u,e[5]=a,e[6]=f,e[7]=l,e[8]=c,e[9]=h,e[10]=p,e[11]=d,e[12]=r*v+u*m+c*g+t[12],e[13]=i*v+a*m+h*g+t[13],e[14]=s*v+f*m+p*g+t[14],e[15]=o*v+l*m+d*g+t[15]),e},c.scale=function(e,t,n){var r=n[0],i=n[1],s=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},c.rotate=function(e,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,w,E,S,x,T,N,C,k,L,A,O=i[0],M=i[1],_=i[2],D=Math.sqrt(O*O+M*M+_*_);return Math.abs(D)<t?null:(D=1/D,O*=D,M*=D,_*=D,s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=n[3],h=n[4],p=n[5],d=n[6],v=n[7],m=n[8],g=n[9],y=n[10],w=n[11],E=O*O*u+o,S=M*O*u+_*s,x=_*O*u-M*s,T=O*M*u-_*s,N=M*M*u+o,C=_*M*u+O*s,k=O*_*u+M*s,L=M*_*u-O*s,A=_*_*u+o,e[0]=a*E+h*S+m*x,e[1]=f*E+p*S+g*x,e[2]=l*E+d*S+y*x,e[3]=c*E+v*S+w*x,e[4]=a*T+h*N+m*C,e[5]=f*T+p*N+g*C,e[6]=l*T+d*N+y*C,e[7]=c*T+v*N+w*C,e[8]=a*k+h*L+m*A,e[9]=f*k+p*L+g*A,e[10]=l*k+d*L+y*A,e[11]=c*k+v*L+w*A,n!==e&&(e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15]),e)},c.rotateX=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[4],o=t[5],u=t[6],a=t[7],f=t[8],l=t[9],c=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*i+f*r,e[5]=o*i+l*r,e[6]=u*i+c*r,e[7]=a*i+h*r,e[8]=f*i-s*r,e[9]=l*i-o*r,e[10]=c*i-u*r,e[11]=h*i-a*r,e},c.rotateY=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[0],o=t[1],u=t[2],a=t[3],f=t[8],l=t[9],c=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i-f*r,e[1]=o*i-l*r,e[2]=u*i-c*r,e[3]=a*i-h*r,e[8]=s*r+f*i,e[9]=o*r+l*i,e[10]=u*r+c*i,e[11]=a*r+h*i,e},c.rotateZ=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+f*r,e[1]=o*i+l*r,e[2]=u*i+c*r,e[3]=a*i+h*r,e[4]=f*i-s*r,e[5]=l*i-o*r,e[6]=c*i-u*r,e[7]=h*i-a*r,e},c.fromRotationTranslation=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=r+r,a=i+i,f=s+s,l=r*u,c=r*a,h=r*f,p=i*a,d=i*f,v=s*f,m=o*u,g=o*a,y=o*f;return e[0]=1-(p+v),e[1]=c+y,e[2]=h-g,e[3]=0,e[4]=c-y,e[5]=1-(l+v),e[6]=d+m,e[7]=0,e[8]=h+g,e[9]=d-m,e[10]=1-(l+p),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},c.fromQuat=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return e[0]=1-(h+d),e[1]=l+g,e[2]=c-m,e[3]=0,e[4]=l-g,e[5]=1-(f+d),e[6]=p+v,e[7]=0,e[8]=c+m,e[9]=p-v,e[10]=1-(f+h),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},c.frustum=function(e,t,n,r,i,s,o){var u=1/(n-t),a=1/(i-r),f=1/(s-o);return e[0]=2*s*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*a,e[6]=0,e[7]=0,e[8]=(n+t)*u,e[9]=(i+r)*a,e[10]=(o+s)*f,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*s*2*f,e[15]=0,e},c.perspective=function(e,t,n,r,i){var s=1/Math.tan(t/2),o=1/(r-i);return e[0]=s/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+r)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*r*o,e[15]=0,e},c.ortho=function(e,t,n,r,i,s,o){var u=1/(t-n),a=1/(r-i),f=1/(s-o);return e[0]=-2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+n)*u,e[13]=(i+r)*a,e[14]=(o+s)*f,e[15]=1,e},c.lookAt=function(e,n,r,i){var s,o,u,a,f,l,h,p,d,v,m=n[0],g=n[1],y=n[2],w=i[0],E=i[1],S=i[2],x=r[0],T=r[1],N=r[2];return Math.abs(m-x)<t&&Math.abs(g-T)<t&&Math.abs(y-N)<t?c.identity(e):(h=m-x,p=g-T,d=y-N,v=1/Math.sqrt(h*h+p*p+d*d),h*=v,p*=v,d*=v,s=E*d-S*p,o=S*h-w*d,u=w*p-E*h,v=Math.sqrt(s*s+o*o+u*u),v?(v=1/v,s*=v,o*=v,u*=v):(s=0,o=0,u=0),a=p*u-d*o,f=d*s-h*u,l=h*o-p*s,v=Math.sqrt(a*a+f*f+l*l),v?(v=1/v,a*=v,f*=v,l*=v):(a=0,f=0,l=0),e[0]=s,e[1]=a,e[2]=h,e[3]=0,e[4]=o,e[5]=f,e[6]=p,e[7]=0,e[8]=u,e[9]=l,e[10]=d,e[11]=0,e[12]=-(s*m+o*g+u*y),e[13]=-(a*m+f*g+l*y),e[14]=-(h*m+p*g+d*y),e[15]=1,e)},c.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},"undefined"!=typeof e&&(e.mat4=c);var h={};h.create=function(){var e=new n(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},h.rotationTo=function(){var e=o.create(),t=o.fromValues(1,0,0),n=o.fromValues(0,1,0);return function(r,i,s){var u=o.dot(i,s);return-.999999>u?(o.cross(e,t,i),o.length(e)<1e-6&&o.cross(e,n,i),o.normalize(e,e),h.setAxisAngle(r,e,Math.PI),r):u>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(o.cross(e,i,s),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=1+u,h.normalize(r,r))}}(),h.setAxes=function(){var e=l.create();return function(t,n,r,i){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=n[0],e[5]=n[1],e[8]=n[2],h.normalize(t,h.fromMat3(t,e))}}(),h.clone=u.clone,h.fromValues=u.fromValues,h.copy=u.copy,h.set=u.set,h.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},h.setAxisAngle=function(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e},h.add=u.add,h.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1],f=n[2],l=n[3];return e[0]=r*l+o*u+i*f-s*a,e[1]=i*l+o*a+s*u-r*f,e[2]=s*l+o*f+r*a-i*u,e[3]=o*l-r*u-i*a-s*f,e},h.mul=h.multiply,h.scale=u.scale,h.rotateX=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+o*u,e[1]=i*a+s*u,e[2]=s*a-i*u,e[3]=o*a-r*u,e},h.rotateY=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a-s*u,e[1]=i*a+o*u,e[2]=s*a+r*u,e[3]=o*a-i*u,e},h.rotateZ=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+i*u,e[1]=i*a-r*u,e[2]=s*a+o*u,e[3]=o*a-s*u,e},h.calculateW=function(e,t){var n=t[0],r=t[1],i=t[2];return e[0]=n,e[1]=r,e[2]=i,e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e},h.dot=u.dot,h.lerp=u.lerp,h.slerp=function(e,t,n,r){var i,s,o,u,a,f=t[0],l=t[1],c=t[2],h=t[3],p=n[0],d=n[1],v=n[2],m=n[3];return s=f*p+l*d+c*v+h*m,0>s&&(s=-s,p=-p,d=-d,v=-v,m=-m),1-s>1e-6?(i=Math.acos(s),o=Math.sin(i),u=Math.sin((1-r)*i)/o,a=Math.sin(r*i)/o):(u=1-r,a=r),e[0]=u*f+a*p,e[1]=u*l+a*d,e[2]=u*c+a*v,e[3]=u*h+a*m,e},h.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*n+r*r+i*i+s*s,u=o?1/o:0;return e[0]=-n*u,e[1]=-r*u,e[2]=-i*u,e[3]=s*u,e},h.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},h.length=u.length,h.len=h.length,h.squaredLength=u.squaredLength,h.sqrLen=h.squaredLength,h.normalize=u.normalize,h.fromMat3=function(){var e="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(t,n){var r,i=n[0]+n[4]+n[8];if(i>0)r=Math.sqrt(i+1),t[3]=.5*r,r=.5/r,t[0]=(n[7]-n[5])*r,t[1]=(n[2]-n[6])*r,t[2]=(n[3]-n[1])*r;else{var s=0;n[4]>n[0]&&(s=1),n[8]>n[3*s+s]&&(s=2);var o=e[s],u=e[o];r=Math.sqrt(n[3*s+s]-n[3*o+o]-n[3*u+u]+1),t[s]=.5*r,r=.5/r,t[3]=(n[3*u+o]-n[3*o+u])*r,t[o]=(n[3*o+s]+n[3*s+o])*r,t[u]=(n[3*u+s]+n[3*s+u])*r}return t}}(),h.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},"undefined"!=typeof e&&(e.quat=h)}(t.exports)}(this),function(){Object.create=Object.create||function(e){function t(){}return t.prototype=e,new t};var e;"undefined"==typeof exports?(e={},"object"==typeof window&&(window.cp=e)):e=exports;var t,n,r=function(e,t){if(!e)throw new Error("Assertion failed: "+t)},i=function(e,t){!e&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+t),console.trace&&console.trace())},s=function(e,t){return t>e?e:t},o=function(e,t){return e>t?e:t};"object"==typeof window&&window.navigator.userAgent.indexOf("Firefox")>-1?(t=Math.min,n=Math.max):(t=s,n=o);var u=function(e,t){return t>e?e+" "+t:t+" "+e},a=function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return e[n]=e[e.length-1],e.length--,void 0},f=function(e,t,n){var r=T(t,n),i=m(b(r,T(e,n))/D(r));return x(n,C(r,i))},l=function(e,t,n,r,i,s){var o=n-i,u=r-s,a=m(w(o,u,e-i,t-s)/P(o,u));return new g(i+o*a,s+u*a)};e.momentForCircle=function(e,t,n,r){return e*(.5*(t*t+n*n)+D(r))},e.areaForCircle=function(e,t){return Math.PI*Math.abs(e*e-t*t)},e.momentForSegment=function(e,t,n){var r=C(x(t,n),.5);return e*(q(n,t)/12+D(r))},e.areaForSegment=function(e,t,n){return n*(Math.PI*n+2*I(e,t))},e.momentForPoly=function(e,t,n){for(var r=0,i=0,s=t.length,o=0;s>o;o+=2){var u=t[o]+n.x,a=t[o+1]+n.y,f=t[(o+2)%s]+n.x,l=t[(o+3)%s]+n.y,c=L(f,l,u,a),h=w(u,a,u,a)+w(u,a,f,l)+w(f,l,f,l);r+=c*h,i+=c}return e*r/(6*i)},e.areaForPoly=function(e){for(var t=0,n=0,r=e.length;r>n;n+=2)t+=k(new g(e[n],e[n+1]),new g(e[(n+2)%r],e[(n+3)%r]));return-t/2},e.centroidForPoly=function(e){for(var t=0,n=new g(0,0),r=0,i=e.length;i>r;r+=2){var s=new g(e[r],e[r+1]),o=new g(e[(r+2)%i],e[(r+3)%i]),u=k(s,o);t+=u,n=x(n,C(x(s,o),u))}return C(n,1/(3*t))},e.recenterPoly=function(t){for(var n=e.centroidForPoly(t),r=0;r<t.length;r+=2)t[r]-=n.x,t[r+1]-=n.y},e.momentForBox=function(e,t,n){return e*(t*t+n*n)/12},e.momentForBox2=function(t,n){var r=n.r-n.l,i=n.t-n.b,s=C([n.l+n.r,n.b+n.t],.5);return e.momentForBox(t,r,i)+t*D(s)};var c=e.loopIndexes=function(e){var t,n,r,i,s=0,o=0;t=r=e[0],n=i=e[1];for(var u=e.length>>1,a=1;u>a;a++){var f=e[2*a],l=e[2*a+1];t>f||f==t&&n>l?(t=f,n=l,s=a):(f>r||f==r&&l>i)&&(r=f,i=l,o=a)}return[s,o]},h=function(e,t,n){var r=e[2*t];e[2*t]=e[2*n],e[2*n]=r,r=e[2*t+1],e[2*t+1]=e[2*n+1],e[2*n+1]=r},p=function(e,t,n,r,i,s){if(0===n)return 0;for(var o=0,u=t,a=T(i,r),f=s*E(a),l=t,c=t+n-1;c>=l;){var p=new g(e[2*l],e[2*l+1]),d=k(a,T(p,r));d>f?(d>o&&(o=d,u=l),l++):(h(e,l,c),c--)}return u!=t&&h(e,t,u),l-t},d=function(e,t,n,r,i,s,o,u){if(0>r)return 0;if(0==r)return t[2*u]=s.x,t[2*u+1]=s.y,1;var a=p(t,n,r,i,s,e),f=new g(t[2*n],t[2*n+1]),l=d(e,t,n+1,a-1,i,f,s,u),c=u+l++;t[2*c]=s.x,t[2*c+1]=s.y;var h=p(t,n+a,r-a,s,o,e),v=new g(t[2*(n+a)],t[2*(n+a)+1]);return l+d(e,t,n+a+1,h-1,s,v,o,u+l)};e.convexHull=function(e,t,n){if(t)for(var r=0;r<e.length;r++)t[r]=e[r];else t=e;var s=c(e),o=s[0],u=s[1];if(o==u)return t.length=2,t;h(t,0,o),h(t,1,0==u?o:u);var a=new g(t[0],t[1]),f=new g(t[2],t[3]),l=e.length>>1,p=d(n,t,2,l-2,a,f,a,1)+1;return t.length=2*p,i(et(t),"Internal error: cpConvexHull() and cpPolyValidate() did not agree.Please report this error with as much info as you can."),t};var v=function(e,r,i){return t(n(e,r),i)},m=function(e){return n(0,t(e,1))},g=e.Vect=function(e,t){this.x=e,this.y=t};e.v=function(e,t){return new g(e,t)};var y=e.vzero=new g(0,0),b=e.v.dot=function(e,t){return e.x*t.x+e.y*t.y},w=function(e,t,n,r){return e*n+t*r},E=e.v.len=function(e){return Math.sqrt(b(e,e))},S=e.v.len2=function(e,t){return Math.sqrt(e*e+t*t)},x=(e.v.eql=function(e,t){return e.x===t.x&&e.y===t.y},e.v.add=function(e,t){return new g(e.x+t.x,e.y+t.y)});g.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this};var T=e.v.sub=function(e,t){return new g(e.x-t.x,e.y-t.y)};g.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this};var N=e.v.neg=function(e){return new g(-e.x,-e.y)};g.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var C=e.v.mult=function(e,t){return new g(e.x*t,e.y*t)};g.prototype.mult=function(e){return this.x*=e,this.y*=e,this};var k=e.v.cross=function(e,t){return e.x*t.y-e.y*t.x},L=function(e,t,n,r){return e*r-t*n},A=e.v.perp=function(e){return new g(-e.y,e.x)},O=(e.v.pvrperp=function(e){return new g(e.y,-e.x)},e.v.project=function(e,t){return C(t,b(e,t)/D(t))});g.prototype.project=function(e){return this.mult(b(this,e)/D(e)),this};var M=e.v.rotate=function(e,t){return new g(e.x*t.x-e.y*t.y,e.x*t.y+e.y*t.x)};g.prototype.rotate=function(e){return this.x=this.x*e.x-this.y*e.y,this.y=this.x*e.y+this.y*e.x,this};var _=e.v.unrotate=function(e,t){return new g(e.x*t.x+e.y*t.y,e.y*t.x-e.x*t.y)},D=e.v.lengthsq=function(e){return b(e,e)},P=e.v.lengthsq2=function(e,t){return e*e+t*t},H=e.v.lerp=function(e,t,n){return x(C(e,1-n),C(t,n))},B=e.v.normalize=function(e){return C(e,1/E(e))},j=e.v.normalize_safe=function(e){return 0===e.x&&0===e.y?y:B(e)},F=e.v.clamp=function(e,t){return b(e,e)>t*t?C(B(e),t):e},I=(e.v.lerpconst=function(e,t,n){return x(e,F(T(t,e),n))},e.v.dist=function(e,t){return E(T(e,t))}),q=e.v.distsq=function(e,t){return D(T(e,t))},R=(e.v.near=function(e,t,n){return q(e,t)<n*n},e.v.slerp=function(e,t,n){var r=Math.acos(b(e,t));if(r){var i=1/Math.sin(r);return x(C(e,Math.sin((1-n)*r)*i),C(t,Math.sin(n*r)*i))}return e}),U=(e.v.slerpconst=function(e,n,r){var i=Math.acos(b(e,n));return R(e,n,t(r,i)/i)},e.v.forangle=function(e){return new g(Math.cos(e),Math.sin(e))},e.v.toangle=function(e){return Math.atan2(e.y,e.x)},e.v.str=function(e){return"("+e.x.toFixed(3)+", "+e.y.toFixed(3)+")"},0),z=e.BB=function(e,t,n,r){this.l=e,this.b=t,this.r=n,this.t=r,U++};e.bb=function(e,t,n,r){return new z(e,t,n,r)};var W=function(e,t){return new z(e.x-t,e.y-t,e.x+t,e.y+t)},X=function(e,t,n,r,i){return e.l<=r&&t<=e.r&&e.b<=i&&n<=e.t},V=0,$=(e.NO_GROUP=0,e.ALL_LAYERS=-1);e.resetShapeIdCounter=function(){V=0};var J=e.Shape=function(e){this.body=e,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=V++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=y,this.collision_type=0,this.group=0,this.layers=$,this.space=null,this.collisionCode=this.collisionCode};J.prototype.setElasticity=function(e){this.e=e},J.prototype.setFriction=function(e){this.body.activate(),this.u=e},J.prototype.setLayers=function(e){this.body.activate(),this.layers=e},J.prototype.setSensor=function(e){this.body.activate(),this.sensor=e},J.prototype.setCollisionType=function(e){this.body.activate(),this.collision_type=e},J.prototype.getBody=function(){return this.body},J.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},J.prototype.setBody=function(e){r(!this.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),this.body=e},J.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},J.prototype.update=function(e,t){r(!isNaN(t.x),"Rotation is NaN"),r(!isNaN(e.x),"Position is NaN"),this.cacheData(e,t)},J.prototype.pointQuery=function(e){var t=this.nearestPointQuery(e);return t.d<0?t:void 0},J.prototype.getBB=function(){return new z(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var K=function(e,t,n){this.shape=e,this.p=t,this.d=n},Q=function(e,t,n){this.shape=e,this.t=t,this.n=n};Q.prototype.hitPoint=function(e,t){return H(e,t,this.t)},Q.prototype.hitDist=function(e,t){return I(e,t)*this.t};var G=e.CircleShape=function(e,t,n){this.c=this.tc=n,this.r=t,this.type="circle",J.call(this,e)};G.prototype=Object.create(J.prototype),G.prototype.cacheData=function(e,t){var n=this.tc=M(this.c,t).add(e),r=this.r;this.bb_l=n.x-r,this.bb_b=n.y-r,this.bb_r=n.x+r,this.bb_t=n.y+r},G.prototype.nearestPointQuery=function(e){var t=e.x-this.tc.x,n=e.y-this.tc.y,r=S(t,n),i=this.r,s=new g(this.tc.x+t*i/r,this.tc.y+n*i/r);return new K(this,s,r-i)};var Y=function(e,t,n,r,i){r=T(r,t),i=T(i,t);var s=b(r,r)-2*b(r,i)+b(i,i),o=-2*b(r,r)+2*b(r,i),u=b(r,r)-n*n,a=o*o-4*s*u;if(a>=0){var f=(-o-Math.sqrt(a))/(2*s);if(f>=0&&1>=f)return new Q(e,f,B(H(r,i,f)))}};G.prototype.segmentQuery=function(e,t){return Y(this,this.tc,this.r,e,t)};var Z=e.SegmentShape=function(e,t,n,r){this.a=t,this.b=n,this.n=A(B(T(n,t))),this.ta=this.tb=this.tn=null,this.r=r,this.a_tangent=y,this.b_tangent=y,this.type="segment",J.call(this,e)};Z.prototype=Object.create(J.prototype),Z.prototype.cacheData=function(e,t){this.ta=x(e,M(this.a,t)),this.tb=x(e,M(this.b,t)),this.tn=M(this.n,t);var n,r,i,s;this.ta.x<this.tb.x?(n=this.ta.x,r=this.tb.x):(n=this.tb.x,r=this.ta.x),this.ta.y<this.tb.y?(i=this.ta.y,s=this.tb.y):(i=this.tb.y,s=this.ta.y);var o=this.r;this.bb_l=n-o,this.bb_b=i-o,this.bb_r=r+o,this.bb_t=s+o},Z.prototype.nearestPointQuery=function(e){var t=f(e,this.ta,this.tb),n=e.x-t.x,r=e.y-t.y,i=S(n,r),s=this.r,o=i?x(t,C(new g(n,r),s/i)):t;return new K(this,o,i-s)},Z.prototype.segmentQuery=function(e,t){var n=this.tn,r=b(T(this.ta,e),n),i=this.r,s=r>0?N(n):n,o=T(C(s,i),e),u=x(this.ta,o),a=x(this.tb,o),f=T(t,e);if(k(f,u)*k(f,a)<=0){var l=r+(r>0?-i:i),c=-l,h=b(f,n)-l;if(0>c*h)return new Q(this,c/(c-h),s)}else if(0!==i){var p=Y(this,this.ta,this.r,e,t),d=Y(this,this.tb,this.r,e,t);return p?d&&d.t<p.t?d:p:d}},Z.prototype.setNeighbors=function(e,t){this.a_tangent=T(e,this.a),this.b_tangent=T(t,this.b)},Z.prototype.setEndpoints=function(e,t){this.a=e,this.b=t,this.n=A(B(T(t,e)))};var et=function(e){for(var t=e.length,n=0;t>n;n+=2){var r=e[n],i=e[n+1],s=e[(n+2)%t],o=e[(n+3)%t],u=e[(n+4)%t],a=e[(n+5)%t];if(L(s-r,o-i,u-s,a-o)>0)return!1}return!0},tt=e.PolyShape=function(e,t,n){this.setVerts(t,n),this.type="poly",J.call(this,e)};tt.prototype=Object.create(J.prototype);var nt=function(e,t){this.n=e,this.d=t};nt.prototype.compare=function(e){return b(this.n,e)-this.d},tt.prototype.setVerts=function(e,t){r(e.length>=4,"Polygons require some verts"),r("number"==typeof e[0],"Polygon verticies should be specified in a flattened list (eg [x1,y1,x2,y2,x3,y3,...])"),r(et(e),"Polygon is concave or has a reversed winding. Consider using cpConvexHull()");var n=e.length,i=n>>1;this.verts=new Array(n),this.tVerts=new Array(n),this.planes=new Array(i),this.tPlanes=new Array(i);for(var s=0;n>s;s+=2){var o=e[s]+t.x,u=e[s+1]+t.y,a=e[(s+2)%n]+t.x,f=e[(s+3)%n]+t.y,l=B(A(new g(a-o,f-u)));this.verts[s]=o,this.verts[s+1]=u,this.planes[s>>1]=new nt(l,w(l.x,l.y,o,u)),this.tPlanes[s>>1]=new nt(new g(0,0),0)}};var rt=(e.BoxShape=function(e,t,n){var r=t/2,i=n/2;return rt(e,new z(-r,-i,r,i))},e.BoxShape2=function(e,t){var n=[t.l,t.b,t.l,t.t,t.r,t.t,t.r,t.b];return new tt(e,n,y)});tt.prototype.transformVerts=function(e,r){for(var i=this.verts,s=this.tVerts,o=1/0,u=-1/0,a=1/0,f=-1/0,l=0;l<i.length;l+=2){var c=i[l],h=i[l+1],p=e.x+c*r.x-h*r.y,d=e.y+c*r.y+h*r.x;s[l]=p,s[l+1]=d,o=t(o,p),u=n(u,p),a=t(a,d),f=n(f,d)}this.bb_l=o,this.bb_b=a,this.bb_r=u,this.bb_t=f},tt.prototype.transformAxes=function(e,t){for(var n=this.planes,r=this.tPlanes,i=0;i<n.length;i++){var s=M(n[i].n,t);r[i].n=s,r[i].d=b(e,s)+n[i].d}},tt.prototype.cacheData=function(e,t){this.transformAxes(e,t),this.transformVerts(e,t)},tt.prototype.nearestPointQuery=function(e){for(var t=this.tPlanes,n=this.tVerts,r=n[n.length-2],i=n[n.length-1],s=1/0,o=y,u=!1,a=0;a<t.length;a++){t[a].compare(e)>0&&(u=!0);var f=n[2*a],c=n[2*a+1],h=l(e.x,e.y,r,i,f,c),p=I(e,h);s>p&&(s=p,o=h),r=f,i=c}return new K(this,o,u?s:-s)},tt.prototype.segmentQuery=function(e,t){for(var n=this.tPlanes,r=this.tVerts,i=n.length,s=2*i,o=0;i>o;o++){var u=n[o].n,a=b(e,u);if(!(n[o].d>a)){var f=b(t,u),l=(n[o].d-a)/(f-a);if(!(0>l||l>1)){var c=H(e,t,l),h=-k(u,c),p=-L(u.x,u.y,r[2*o],r[2*o+1]),d=-L(u.x,u.y,r[(2*o+2)%s],r[(2*o+3)%s]);if(h>=p&&d>=h)return new Q(this,l,u)}}}},tt.prototype.valueOnAxis=function(e,n){for(var r=this.tVerts,i=w(e.x,e.y,r[0],r[1]),s=2;s<r.length;s+=2)i=t(i,w(e.x,e.y,r[s],r[s+1]));return i-n},tt.prototype.containsVert=function(e,t){for(var n=this.tPlanes,r=0;r<n.length;r++){var i=n[r].n,s=w(i.x,i.y,e,t)-n[r].d;if(s>0)return!1}return!0},tt.prototype.containsVertPartial=function(e,t,n){for(var r=this.tPlanes,i=0;i<r.length;i++){var s=r[i].n;if(!(b(s,n)<0)){var o=w(s.x,s.y,e,t)-r[i].d;if(o>0)return!1}}return!0},tt.prototype.getNumVerts=function(){return this.verts.length/2},tt.prototype.getVert=function(e){return new g(this.verts[2*e],this.verts[2*e+1])};var it=e.Body=function(e,t){this.p=new g(0,0),this.vx=this.vy=0,this.f=new g(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(e),this.setMoment(t),this.rot=new g(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var st=function(e,t){r(e.x==e.x&&e.y==e.y,t)},ot=function(e,t){r(1/0!==Math.abs(e.x)&&1/0!==Math.abs(e.y),t)},ut=function(e,t){st(e,t),ot(e,t)};it.prototype.sanityCheck=function(){r(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),r(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),ut(this.p,"Body's position is invalid."),ut(this.f,"Body's force is invalid."),r(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),r(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),r(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),r(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),r(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),ut(this.rot,"Body's rotation vector is invalid."),r(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),r(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else it.prototype.sanityCheck=function(){};it.prototype.getPos=function(){return this.p},it.prototype.getVel=function(){return new g(this.vx,this.vy)},it.prototype.getAngVel=function(){return this.w},it.prototype.isSleeping=function(){return null!==this.nodeRoot},it.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},it.prototype.isRogue=function(){return null===this.space},it.prototype.setMass=function(e){r(e>0,"Mass must be positive and non-zero."),this.activate(),this.m=e,this.m_inv=1/e},it.prototype.setMoment=function(e){r(e>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=e,this.i_inv=1/e},it.prototype.addShape=function(e){this.shapeList.push(e)},it.prototype.removeShape=function(e){a(this.shapeList,e)};var at=function(e,t,n){return e===n?e.next(t):(e.a===t?e.next_a=at(e.next_a,t,n):e.next_b=at(e.next_b,t,n),e)};it.prototype.removeConstraint=function(e){this.constraintList=at(this.constraintList,this,e)},it.prototype.setPos=function(t){this.activate(),this.sanityCheck(),t===y&&(t=e.v(0,0)),this.p=t},it.prototype.setVel=function(e){this.activate(),this.vx=e.x,this.vy=e.y},it.prototype.setAngVel=function(e){this.activate(),this.w=e},it.prototype.setAngleInternal=function(e){r(!isNaN(e),"Internal Error: Attempting to set body's angle to NaN"),this.a=e,this.rot.x=Math.cos(e),this.rot.y=Math.sin(e)},it.prototype.setAngle=function(e){this.activate(),this.sanityCheck(),this.setAngleInternal(e)},it.prototype.velocity_func=function(e,t,n){var r=this.vx*t+(e.x+this.f.x*this.m_inv)*n,i=this.vy*t+(e.y+this.f.y*this.m_inv)*n,s=this.v_limit,o=r*r+i*i,u=o>s*s?s/Math.sqrt(o):1;this.vx=r*u,this.vy=i*u;var a=this.w_limit;this.w=v(this.w*t+this.t*this.i_inv*n,-a,a),this.sanityCheck()},it.prototype.position_func=function(e){this.p.x+=(this.vx+this.v_biasx)*e,this.p.y+=(this.vy+this.v_biasy)*e,this.setAngleInternal(this.a+(this.w+this.w_bias)*e),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},it.prototype.resetForces=function(){this.activate(),this.f=new g(0,0),this.t=0},it.prototype.applyForce=function(e,t){this.activate(),this.f=x(this.f,e),this.t+=k(t,e)},it.prototype.applyImpulse=function(e,t){this.activate(),cn(this,e.x,e.y,t)},it.prototype.getVelAtPoint=function(e){return x(new g(this.vx,this.vy),C(A(e),this.w))},it.prototype.getVelAtWorldPoint=function(e){return this.getVelAtPoint(T(e,this.p))},it.prototype.getVelAtLocalPoint=function(e){return this.getVelAtPoint(M(e,this.rot))},it.prototype.eachShape=function(e){for(var t=0,n=this.shapeList.length;n>t;t++)e(this.shapeList[t])},it.prototype.eachConstraint=function(e){for(var t=this.constraintList;t;){var n=t.next(this);e(t),t=n}},it.prototype.eachArbiter=function(e){for(var t=this.arbiterList;t;){var n=t.next(this);t.swappedColl=this===t.body_b,e(t),t=n}},it.prototype.local2World=function(e){return x(this.p,M(e,this.rot))},it.prototype.world2Local=function(e){return _(T(e,this.p),this.rot)},it.prototype.kineticEnergy=function(){var e=this.vx*this.vx+this.vy*this.vy,t=this.w*this.w;return(e?e*this.m:0)+(t?t*this.i:0)};var ft=e.SpatialIndex=function(e){if(this.staticIndex=e,e){if(e.dynamicIndex)throw new Error("This static index is already associated with a dynamic index.");e.dynamicIndex=this}};ft.prototype.collideStatic=function(e,t){if(e.count>0){var n=e.query;this.each(function(e){n(e,new z(e.bb_l,e.bb_b,e.bb_r,e.bb_t),t)})}};var lt=e.BBTree=function(e){ft.call(this,e),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};lt.prototype=Object.create(ft.prototype);var ct=0,ht=function(e,r,i){this.obj=null,this.bb_l=t(r.bb_l,i.bb_l),this.bb_b=t(r.bb_b,i.bb_b),this.bb_r=n(r.bb_r,i.bb_r),this.bb_t=n(r.bb_t,i.bb_t),this.parent=null,this.setA(r),this.setB(i)};lt.prototype.makeNode=function(e,t){var n=this.pooledNodes;return n?(this.pooledNodes=n.parent,n.constructor(this,e,t),n):(ct++,new ht(this,e,t))};var pt=0,dt=function(e,t){this.obj=t,e.getBB(t,this),this.parent=null,this.stamp=1,this.pairs=null,pt++};lt.prototype.getBB=function(e,r){var i=this.velocityFunc;if(i){var s=.1,o=(e.bb_r-e.bb_l)*s,u=(e.bb_t-e.bb_b)*s,a=C(i(e),.1);r.bb_l=e.bb_l+t(-o,a.x),r.bb_b=e.bb_b+t(-u,a.y),r.bb_r=e.bb_r+n(o,a.x),r.bb_t=e.bb_t+n(u,a.y)}else r.bb_l=e.bb_l,r.bb_b=e.bb_b,r.bb_r=e.bb_r,r.bb_t=e.bb_t},lt.prototype.getStamp=function(){var e=this.dynamicIndex;return e&&e.stamp?e.stamp:this.stamp},lt.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var vt=0,mt=function(e,t,n,r){this.prevA=null,this.leafA=e,this.nextA=t,this.prevB=null,this.leafB=n,this.nextB=r};lt.prototype.makePair=function(e,t,n,r){var i=this.pooledPairs;return i?(this.pooledPairs=i.prevA,i.prevA=null,i.leafA=e,i.nextA=t,i.prevB=null,i.leafB=n,i.nextB=r,i):(vt++,new mt(e,t,n,r))},mt.prototype.recycle=function(e){this.prevA=e.pooledPairs,e.pooledPairs=this};var gt=function(e,t,n){n&&(n.leafA===t?n.prevA=e:n.prevB=e),e?e.leafA===t?e.nextA=n:e.nextB=n:t.pairs=n};dt.prototype.clearPairs=function(e){var t,n=this.pairs;for(this.pairs=null;n;)n.leafA===this?(t=n.nextA,gt(n.prevB,n.leafB,n.nextB)):(t=n.nextB,gt(n.prevA,n.leafA,n.nextA)),n.recycle(e),n=t};var yt=function(e,t,n){var r=e.pairs,i=t.pairs,s=n.makePair(e,r,t,i);e.pairs=t.pairs=s,r&&(r.leafA===e?r.prevA=s:r.prevB=s),i&&(i.leafA===t?i.prevA=s:i.prevB=s)};ht.prototype.recycle=function(e){this.parent=e.pooledNodes,e.pooledNodes=this},dt.prototype.recycle=function(){},ht.prototype.setA=function(e){this.A=e,e.parent=this},ht.prototype.setB=function(e){this.B=e,e.parent=this},dt.prototype.isLeaf=!0,ht.prototype.isLeaf=!1,ht.prototype.otherChild=function(e){return this.A==e?this.B:this.A},ht.prototype.replaceChild=function(e,r,s){i(e==this.A||e==this.B,"Node is not a child of parent."),this.A==e?(this.A.recycle(s),this.setA(r)):(this.B.recycle(s),this.setB(r));for(var o=this;o;o=o.parent){var u=o.A,a=o.B;o.bb_l=t(u.bb_l,a.bb_l),o.bb_b=t(u.bb_b,a.bb_b),o.bb_r=n(u.bb_r,a.bb_r),o.bb_t=n(u.bb_t,a.bb_t)}},ht.prototype.bbArea=dt.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var bt=function(e,r){return(n(e.bb_r,r.bb_r)-t(e.bb_l,r.bb_l))*(n(e.bb_t,r.bb_t)-t(e.bb_b,r.bb_b))},wt=function(e,t){return Math.abs(e.bb_l+e.bb_r-t.bb_l-t.bb_r)+Math.abs(e.bb_b+e.bb_t-t.bb_b-t.bb_t)},Et=function(e,r,i){if(null==e)return r;if(e.isLeaf)return i.makeNode(r,e);var s=e.B.bbArea()+bt(e.A,r),o=e.A.bbArea()+bt(e.B,r);return s===o&&(s=wt(e.A,r),o=wt(e.B,r)),s>o?e.setB(Et(e.B,r,i)):e.setA(Et(e.A,r,i)),e.bb_l=t(e.bb_l,r.bb_l),e.bb_b=t(e.bb_b,r.bb_b),e.bb_r=n(e.bb_r,r.bb_r),e.bb_t=n(e.bb_t,r.bb_t),e};ht.prototype.intersectsBB=dt.prototype.intersectsBB=function(e){return this.bb_l<=e.r&&e.l<=this.bb_r&&this.bb_b<=e.t&&e.b<=this.bb_t};var St=function(e,t,n){e.intersectsBB(t)&&(e.isLeaf?n(e.obj):(St(e.A,t,n),St(e.B,t,n)))},xt=function(e,r,i){var s=1/(i.x-r.x),o=e.bb_l==r.x?-1/0:(e.bb_l-r.x)*s,u=e.bb_r==r.x?1/0:(e.bb_r-r.x)*s,a=t(o,u),f=n(o,u),l=1/(i.y-r.y),c=e.bb_b==r.y?-1/0:(e.bb_b-r.y)*l,h=e.bb_t==r.y?1/0:(e.bb_t-r.y)*l,p=t(c,h),d=n(c,h);if(f>=p&&d>=a){var v=n(a,p),m=t(f,d);if(m>=0&&1>=v)return n(v,0)}return 1/0},Tt=function(e,n,r,i,s){if(e.isLeaf)return s(e.obj);var o=xt(e.A,n,r),u=xt(e.B,n,r);return u>o?(i>o&&(i=t(i,Tt(e.A,n,r,i,s))),i>u&&(i=t(i,Tt(e.B,n,r,i,s)))):(i>u&&(i=t(i,Tt(e.B,n,r,i,s))),i>o&&(i=t(i,Tt(e.A,n,r,i,s)))),i};lt.prototype.subtreeRecycle=function(e){e.isLeaf&&(this.subtreeRecycle(e.A),this.subtreeRecycle(e.B),e.recycle(this))};var Nt=function(e,t,n){if(t==e)return null;var r=t.parent;if(r==e){var i=e.otherChild(t);return i.parent=e.parent,e.recycle(n),i}return r.parent.replaceChild(r,r.otherChild(t),n),e},Ct=function(e,t){return e.bb_l<=t.bb_r&&t.bb_l<=e.bb_r&&e.bb_b<=t.bb_t&&t.bb_b<=e.bb_t};dt.prototype.markLeafQuery=function(e,t,n,r){Ct(e,this)&&(t?yt(e,this,n):(this.stamp<e.stamp&&yt(this,e,n),r&&r(e.obj,this.obj)))},ht.prototype.markLeafQuery=function(e,t,n,r){Ct(e,this)&&(this.A.markLeafQuery(e,t,n,r),this.B.markLeafQuery(e,t,n,r))},dt.prototype.markSubtree=function(e,t,n){if(this.stamp==e.getStamp()){t&&t.markLeafQuery(this,!1,e,n);for(var r=this;r.parent;r=r.parent)r==r.parent.A?r.parent.B.markLeafQuery(this,!0,e,n):r.parent.A.markLeafQuery(this,!1,e,n)}else for(var i=this.pairs;i;)this===i.leafB?(n&&n(i.leafA.obj,this.obj),i=i.nextB):i=i.nextA},ht.prototype.markSubtree=function(e,t,n){this.A.markSubtree(e,t,n),this.B.markSubtree(e,t,n)},dt.prototype.containsObj=function(e){return this.bb_l<=e.bb_l&&this.bb_r>=e.bb_r&&this.bb_b<=e.bb_b&&this.bb_t>=e.bb_t},dt.prototype.update=function(e){var t=e.root,n=this.obj;return this.containsObj(n)?!1:(e.getBB(this.obj,this),t=Nt(t,this,e),e.root=Et(t,this,e),this.clearPairs(e),this.stamp=e.getStamp(),!0)},dt.prototype.addPairs=function(e){var t=e.dynamicIndex;if(t){var n=t.root;n&&n.markLeafQuery(this,!0,t,null)}else{var r=e.staticIndex.root;this.markSubtree(e,r,null)}},lt.prototype.insert=function(e,t){var n=new dt(this,e);this.leaves[t]=n,this.root=Et(this.root,n,this),this.count++,n.stamp=this.getStamp(),n.addPairs(this),this.incrementStamp()},lt.prototype.remove=function(e,t){var n=this.leaves[t];delete this.leaves[t],this.root=Nt(this.root,n,this),this.count--,n.clearPairs(this),n.recycle(this)},lt.prototype.contains=function(e,t){return null!=this.leaves[t]};var kt=function(){};lt.prototype.reindexQuery=function(e){if(this.root){var t,n=this.leaves;for(t in n)n[t].update(this);var r=this.staticIndex,i=r&&r.root;this.root.markSubtree(this,i,e),r&&!i&&this.collideStatic(this,r,e),this.incrementStamp()}},lt.prototype.reindex=function(){this.reindexQuery(kt)},lt.prototype.reindexObject=function(e,t){var n=this.leaves[t];n&&(n.update(this)&&n.addPairs(this),this.incrementStamp())},lt.prototype.pointQuery=function(e,t){this.query(new z(e.x,e.y,e.x,e.y),t)},lt.prototype.segmentQuery=function(e,t,n,r){this.root&&Tt(this.root,e,t,n,r)},lt.prototype.query=function(e,t){this.root&&St(this.root,e,t)},lt.prototype.count=function(){return this.count},lt.prototype.each=function(e){var t;for(t in this.leaves)e(this.leaves[t].obj)};var Lt=function(e,r,i,s,o){return(n(e.bb_r,s)-t(e.bb_l,r))*(n(e.bb_t,o)-t(e.bb_b,i))},At=function(e,r,i,s){if(1==s)return r[i];if(2==s)return e.makeNode(r[i],r[i+1]);for(var o=r[i],u=o.bb_l,a=o.bb_b,f=o.bb_r,l=o.bb_t,c=i+s,h=i+1;c>h;h++)o=r[h],u=t(u,o.bb_l),a=t(a,o.bb_b),f=n(f,o.bb_r),l=n(l,o.bb_t);var p=f-u>l-a,d=new Array(2*s);if(p)for(var h=i;c>h;h++)d[2*h+0]=r[h].bb_l,d[2*h+1]=r[h].bb_r;else for(var h=i;c>h;h++)d[2*h+0]=r[h].bb_b,d[2*h+1]=r[h].bb_t;d.sort(function(e,t){return e-t});var v=.5*(d[s-1]+d[s]),m=u,g=a,y=f,b=l,w=u,E=a,S=f,x=l;p?y=w=v:b=E=v;for(var T=c,N=i;T>N;){var o=r[N];Lt(o,w,E,S,x)<Lt(o,m,g,y,b)?(T--,r[N]=r[T],r[T]=o):N++}if(T==s){for(var o=null,h=i;c>h;h++)o=Et(o,r[h],e);return o}return NodeNew(e,At(e,r,i,T-i),At(e,r,T,c-T))};lt.prototype.optimize=function(){var e=new Array(this.count),t=0;for(var n in this.leaves)e[t++]=this.nodes[n];tree.subtreeRecycle(root),this.root=At(tree,e,e.length)};var Ot=function(e,t){!e.isLeaf&&10>=t&&(Ot(e.A,t+1),Ot(e.B,t+1));for(var n="",r=0;t>r;r++)n+=" ";console.log(n+e.bb_b+" "+e.bb_t)};lt.prototype.log=function(){this.root&&Ot(this.root,0)};var Mt=e.CollisionHandler=function(){this.a=this.b=0};Mt.prototype.begin=function(){return!0},Mt.prototype.preSolve=function(){return!0},Mt.prototype.postSolve=function(){},Mt.prototype.separate=function(){};var _t=function(e,t){this.e=0,this.u=0,this.surface_vr=y,this.a=e,this.body_a=e.body,this.b=t,this.body_b=t.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};_t.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},_t.prototype.totalImpulse=function(){for(var e=this.contacts,t=new g(0,0),n=0,r=e.length;r>n;n++){var i=e[n];t.add(C(i.n,i.jnAcc))}return this.swappedColl?t:t.neg()},_t.prototype.totalImpulseWithFriction=function(){for(var e=this.contacts,t=new g(0,0),n=0,r=e.length;r>n;n++){var i=e[n];t.add((new g(i.jnAcc,i.jtAcc)).rotate(i.n))}return this.swappedColl?t:t.neg()},_t.prototype.totalKE=function(){for(var e=(1-this.e)/(1+this.e),t=0,n=this.contacts,r=0,i=n.length;i>r;r++){var s=n[r],o=s.jnAcc,u=s.jtAcc;t+=e*o*o/s.nMass+u*u/s.tMass}return t},_t.prototype.ignore=function(){this.state="ignore"},_t.prototype.getA=function(){return this.swappedColl?this.b:this.a},_t.prototype.getB=function(){return this.swappedColl?this.a:this.b},_t.prototype.isFirstContact=function(){return"first coll"===this.state};var Dt=function(e,t,n){this.point=e,this.normal=t,this.dist=n};_t.prototype.getContactPointSet=function(){var e,t=new Array(this.contacts.length);for(e=0;e<t.length;e++)t[e]=new Dt(this.contacts[e].p,this.contacts[e].n,this.contacts[e].dist);return t},_t.prototype.getNormal=function(e){var t=this.contacts[e].n;return this.swappedColl?N(t):t},_t.prototype.getPoint=function(e){return this.contacts[e].p},_t.prototype.getDepth=function(e){return this.contacts[e].dist};var Pt=function(e,t,n,r){n?n.body_a===t?n.thread_a_next=r:n.thread_b_next=r:t.arbiterList=r,r&&(r.body_a===t?r.thread_a_prev=n:r.thread_b_prev=n)};_t.prototype.unthread=function(){Pt(this,this.body_a,this.thread_a_prev,this.thread_a_next),Pt(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},_t.prototype.update=function(e,t,n,r){if(this.contacts)for(var i=0;i<this.contacts.length;i++)for(var s=this.contacts[i],o=0;o<e.length;o++){var u=e[o];u.hash===s.hash&&(u.jnAcc=s.jnAcc,u.jtAcc=s.jtAcc)}this.contacts=e,this.handler=t,this.swappedColl=n.collision_type!==t.a,this.e=n.e*r.e,this.u=n.u*r.u,this.surface_vr=T(n.surface_v,r.surface_v),this.a=n,this.body_a=n.body,this.b=r,this.body_b=r.body,"cached"==this.state&&(this.state="first coll")},_t.prototype.preStep=function(e,n,r){for(var i=this.body_a,s=this.body_b,o=0;o<this.contacts.length;o++){var u=this.contacts[o];u.r1=T(u.p,i.p),u.r2=T(u.p,s.p),u.nMass=1/vn(i,s,u.r1,u.r2,u.n),u.tMass=1/vn(i,s,u.r1,u.r2,A(u.n)),u.bias=-r*t(0,u.dist+n)/e,u.jBias=0,u.bounce=ln(i,s,u.r1,u.r2,u.n)*this.e}},_t.prototype.applyCachedImpulse=function(e){if(!this.isFirstContact())for(var t=this.body_a,n=this.body_b,r=0;r<this.contacts.length;r++){var i=this.contacts[r],s=i.n.x,o=i.n.y,u=s*i.jnAcc-o*i.jtAcc,a=s*i.jtAcc+o*i.jnAcc;hn(t,n,i.r1,i.r2,u*e,a*e)}};var Ht=0,Bt=0;_t.prototype.applyImpulse=function(){Ht++;for(var e=this.body_a,t=this.body_b,r=this.surface_vr,i=this.u,s=0;s<this.contacts.length;s++){Bt++;var o=this.contacts[s],u=o.nMass,a=o.n,f=o.r1,l=o.r2,c=t.vx-l.y*t.w-(e.vx-f.y*e.w),h=t.vy+l.x*t.w-(e.vy+f.x*e.w),p=a.x*(t.v_biasx-l.y*t.w_bias-e.v_biasx+f.y*e.w_bias)+a.y*(l.x*t.w_bias+t.v_biasy-f.x*e.w_bias-e.v_biasy),d=w(c,h,a.x,a.y),m=w(c+r.x,h+r.y,-a.y,a.x),g=(o.bias-p)*u,y=o.jBias;o.jBias=n(y+g,0);var b=-(o.bounce+d)*u,E=o.jnAcc;o.jnAcc=n(E+b,0);var S=i*o.jnAcc,x=-m*o.tMass,T=o.jtAcc;o.jtAcc=v(T+x,-S,S);var N=a.x*(o.jBias-y),C=a.y*(o.jBias-y);pn(e,-N,-C,f),pn(t,N,C,l);var k=o.jnAcc-E,L=o.jtAcc-T;hn(e,t,f,l,a.x*k-a.y*L,a.x*L+a.y*k)}},_t.prototype.callSeparate=function(e){var t=e.lookupHandler(this.a.collision_type,this.b.collision_type);t.separate(this,e)},_t.prototype.next=function(e){return this.body_a==e?this.thread_a_next:this.thread_b_next};var jt=0,Ft=function(e,t,n,r){this.p=e,this.n=t,this.dist=n,this.r1=this.r2=y,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=r,jt++},It=[],qt=function(e,t,n,r){var i=n+r,s=T(t,e),o=D(s);if(!(o>=i*i)){var u=Math.sqrt(o);return new Ft(x(e,C(s,.5+(n-.5*i)/(u?u:1/0))),u?C(s,1/u):new g(1,0),u-i,0)}},Rt=function(e,t){var n=qt(e.tc,t.tc,e.r,t.r);return n?[n]:It},Ut=function(e,t){var n=t.ta,r=t.tb,i=e.tc,s=T(r,n),o=m(b(s,T(i,n))/D(s)),u=x(n,C(s,o)),a=qt(i,u,e.r,t.r);if(a){var f=a.n;return 0===o&&b(f,t.a_tangent)<0||1===o&&b(f,t.b_tangent)<0?It:[a]}return It},zt=0,Wt=function(e,t){var n=0,r=e.valueOnAxis(t[0].n,t[0].d);if(r>0)return-1;for(var i=1;i<t.length;i++){var s=e.valueOnAxis(t[i].n,t[i].d);if(s>0)return-1;s>r&&(r=s,n=i)}return zt=r,n},Xt=function(e,t,n,r){for(var i=[],s=e.tVerts,o=0;o<s.length;o+=2){var a=s[o],f=s[o+1];t.containsVertPartial(a,f,N(n))&&i.push(new Ft(new g(a,f),n,r,u(e.hashid,o)))}for(var l=t.tVerts,o=0;o<l.length;o+=2){var a=l[o],f=l[o+1];e.containsVertPartial(a,f,n)&&i.push(new Ft(new g(a,f),n,r,u(t.hashid,o)))}return i},Vt=function(e,t,n,r){for(var i=[],s=e.tVerts,o=0;o<s.length;o+=2){var a=s[o],f=s[o+1];t.containsVert(a,f)&&i.push(new Ft(new g(a,f),n,r,u(e.hashid,o>>1)))}for(var l=t.tVerts,o=0;o<l.length;o+=2){var a=l[o],f=l[o+1];e.containsVert(a,f)&&i.push(new Ft(new g(a,f),n,r,u(t.hashid,o>>1)))}return i.length?i:Xt(e,t,n,r)},$t=function(e,t){var n=Wt(t,e.tPlanes);if(-1==n)return It;var r=zt,i=Wt(e,t.tPlanes);if(-1==i)return It;var s=zt;return r>s?Vt(e,t,e.tPlanes[n].n,r):Vt(e,t,N(t.tPlanes[i].n),s)},Jt=function(e,n,r){var i=b(n,e.ta)-e.r,s=b(n,e.tb)-e.r;return t(i,s)-r},Kt=function(e,t,n,r,i){for(var s=k(t.tn,t.ta),o=k(t.tn,t.tb),a=C(t.tn,i),f=n.tVerts,l=0;l<f.length;l+=2){var c=f[l],h=f[l+1];if(w(c,h,a.x,a.y)<b(t.tn,t.ta)*i+t.r){var p=L(t.tn.x,t.tn.y,c,h);s>=p&&p>=o&&e.push(new Ft(new g(c,h),a,r,u(n.hashid,l)))}}},Qt=function(e,t){var n=[],r=t.tPlanes,i=r.length,s=b(e.tn,e.ta),o=t.valueOnAxis(e.tn,s)-e.r,a=t.valueOnAxis(N(e.tn),-s)-e.r;if(a>0||o>0)return It;var f=0,l=Jt(e,r[0].n,r[0].d);if(l>0)return It;for(var c=0;i>c;c++){var h=Jt(e,r[c].n,r[c].d);if(h>0)return It;h>l&&(l=h,f=c)}var p=N(r[f].n),d=x(e.ta,C(p,e.r)),v=x(e.tb,C(p,e.r));if(t.containsVert(d.x,d.y)&&n.push(new Ft(d,p,l,u(e.hashid,0))),t.containsVert(v.x,v.y)&&n.push(new Ft(v,p,l,u(e.hashid,1))),(o>=l||a>=l)&&(o>a?Kt(n,e,t,o,1):Kt(n,e,t,a,-1)),0===n.length){var m,y=2*f,w=t.tVerts,E=new g(w[y],w[y+1]);if(m=qt(e.ta,E,e.r,0,n))return[m];if(m=qt(e.tb,E,e.r,0,n))return[m];var S=2*i,T=new g(w[(y+2)%S],w[(y+3)%S]);if(m=qt(e.ta,T,e.r,0,n))return[m];if(m=qt(e.tb,T,e.r,0,n))return[m]}return n},Gt=function(e,t){for(var n=t.tPlanes,r=0,i=b(n[0].n,e.tc)-n[0].d-e.r,s=0;s<n.length;s++){var o=b(n[s].n,e.tc)-n[s].d-e.r;if(o>0)return It;o>i&&(i=o,r=s)}var u=n[r].n,a=t.tVerts,f=a.length,l=r<<1,c=a[l],h=a[l+1],p=a[(l+2)%f],d=a[(l+3)%f],v=L(u.x,u.y,c,h),m=L(u.x,u.y,p,d),y=k(u,e.tc);if(m>y){var w=qt(e.tc,new g(p,d),e.r,0,w);return w?[w]:It}if(v>y)return[new Ft(T(e.tc,C(u,e.r+i/2)),N(u),i,0)];var w=qt(e.tc,new g(c,h),e.r,0,w);return w?[w]:It};G.prototype.collisionCode=0,Z.prototype.collisionCode=1,tt.prototype.collisionCode=2,G.prototype.collisionTable=[Rt,Ut,Gt],Z.prototype.collisionTable=[null,function(){return It},Qt],tt.prototype.collisionTable=[null,null,$t];var Yt=e.collideShapes=function(e,t){return r(e.collisionCode<=t.collisionCode,"Collided shapes must be sorted by type"),e.collisionTable[t.collisionCode](e,t)},Zt=new Mt,en=e.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new lt(null),this.activeShapes=new lt(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Zt,this.postStepCallbacks=[],this.iterations=10,this.gravity=y,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new it(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};en.prototype.getCurrentTimeStep=function(){return this.curr_dt},en.prototype.setIterations=function(e){this.iterations=e},en.prototype.isLocked=function(){return this.locked};var tn=function(e){r(!e.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};en.prototype.addCollisionHandler=function(e,t,n,r,i,s){tn(this),this.removeCollisionHandler(e,t);var o=new Mt;o.a=e,o.b=t,n&&(o.begin=n),r&&(o.preSolve=r),i&&(o.postSolve=i),s&&(o.separate=s),this.collisionHandlers[u(e,t)]=o},en.prototype.removeCollisionHandler=function(e,t){tn(this),delete this.collisionHandlers[u(e,t)]},en.prototype.setDefaultCollisionHandler=function(e,t,n,r){tn(this);var i=new Mt;e&&(i.begin=e),t&&(i.preSolve=t),n&&(i.postSolve=n),r&&(i.separate=r),this.defaultHandler=i},en.prototype.lookupHandler=function(e,t){return this.collisionHandlers[u(e,t)]||this.defaultHandler},en.prototype.addShape=function(e){var t=e.body;return t.isStatic()?this.addStaticShape(e):(r(!e.space,"This shape is already added to a space and cannot be added to another."),tn(this),t.activate(),t.addShape(e),e.update(t.p,t.rot),this.activeShapes.insert(e,e.hashid),e.space=this,e)},en.prototype.addStaticShape=function(e){r(!e.space,"This shape is already added to a space and cannot be added to another."),tn(this);var t=e.body;return t.addShape(e),e.update(t.p,t.rot),this.staticShapes.insert(e,e.hashid),e.space=this,e},en.prototype.addBody=function(e){return r(!e.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),r(!e.space,"This body is already added to a space and cannot be added to another."),tn(this),this.bodies.push(e),e.space=this,e},en.prototype.addConstraint=function(e){r(!e.space,"This shape is already added to a space and cannot be added to another."),tn(this);var t=e.a,n=e.b;return t.activate(),n.activate(),this.constraints.push(e),e.next_a=t.constraintList,t.constraintList=e,e.next_b=n.constraintList,n.constraintList=e,e.space=this,e},en.prototype.filterArbiters=function(e,t){for(var n in this.cachedArbiters){var r=this.cachedArbiters[n];(e===r.body_a&&(t===r.a||null===t)||e===r.body_b&&(t===r.b||null===t))&&(t&&"cached"!==r.state&&r.callSeparate(this),r.unthread(),a(this.arbiters,r),delete this.cachedArbiters[n])}},en.prototype.removeShape=function(e){var t=e.body;t.isStatic()?this.removeStaticShape(e):(r(this.containsShape(e),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),tn(this),t.activate(),t.removeShape(e),this.filterArbiters(t,e),this.activeShapes.remove(e,e.hashid),e.space=null)},en.prototype.removeStaticShape=function(e){r(this.containsShape(e),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),tn(this);var t=e.body;t.isStatic()&&t.activateStatic(e),t.removeShape(e),this.filterArbiters(t,e),this.staticShapes.remove(e,e.hashid),e.space=null},en.prototype.removeBody=function(e){r(this.containsBody(e),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),tn(this),e.activate(),a(this.bodies,e),e.space=null},en.prototype.removeConstraint=function(e){r(this.containsConstraint(e),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),tn(this),e.a.activate(),e.b.activate(),a(this.constraints,e),e.a.removeConstraint(e),e.b.removeConstraint(e),e.space=null},en.prototype.containsShape=function(e){return e.space===this},en.prototype.containsBody=function(e){return e.space==this},en.prototype.containsConstraint=function(e){return e.space==this},en.prototype.uncacheArbiter=function(e){delete this.cachedArbiters[u(e.a.hashid,e.b.hashid)],a(this.arbiters,e)},en.prototype.eachBody=function(e){this.lock();for(var t=this.bodies,n=0;n<t.length;n++)e(t[n]);for(var r=this.sleepingComponents,n=0;n<r.length;n++)for(var i=r[n],s=i;s;){var o=s.nodeNext;e(s),s=o}this.unlock(!0)},en.prototype.eachShape=function(e){this.lock(),this.activeShapes.each(e),this.staticShapes.each(e),this.unlock(!0)},en.prototype.eachConstraint=function(e){this.lock();for(var t=this.constraints,n=0;n<t.length;n++)e(t[n]);this.unlock(!0)},en.prototype.reindexStatic=function(){r(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(e){var t=e.body;e.update(t.p,t.rot)}),this.staticShapes.reindex()},en.prototype.reindexShape=function(e){r(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var t=e.body;e.update(t.p,t.rot),this.activeShapes.reindexObject(e,e.hashid),this.staticShapes.reindexObject(e,e.hashid)},en.prototype.reindexShapesForBody=function(e){for(var t=e.shapeList;t;t=t.next)this.reindexShape(t)},en.prototype.useSpatialHash=function(e,t){throw new Error("Spatial Hash not implemented.")},en.prototype.activateBody=function(e){if(r(!e.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(e)&&this.rousedBodies.push(e);else{this.bodies.push(e);for(var t=0;t<e.shapeList.length;t++){var n=e.shapeList[t];this.staticShapes.remove(n,n.hashid),this.activeShapes.insert(n,n.hashid)}for(var i=e.arbiterList;i;i=i.next(e)){var s=i.body_a;if(e===s||s.isStatic()){var o=i.a,a=i.b;this.cachedArbiters[u(o.hashid,a.hashid)]=i,i.stamp=this.stamp,i.handler=this.lookupHandler(o.collision_type,a.collision_type),this.arbiters.push(i)}}for(var f=e.constraintList;f;f=f.nodeNext){var s=f.a;(e===s||s.isStatic())&&this.constraints.push(f)}}},en.prototype.deactivateBody=function(e){r(!e.isRogue(),"Internal error: Attempting to deactivate a rogue body."),a(this.bodies,e);for(var t=0;t<e.shapeList.length;t++){var n=e.shapeList[t];this.activeShapes.remove(n,n.hashid),this.staticShapes.insert(n,n.hashid)}for(var i=e.arbiterList;i;i=i.next(e)){var s=i.body_a;(e===s||s.isStatic())&&this.uncacheArbiter(i)}for(var o=e.constraintList;o;o=o.nodeNext){var s=o.a;(e===s||s.isStatic())&&a(this.constraints,o)}};var nn=function(e){return e?e.nodeRoot:null},rn=function(e){if(e&&e.isSleeping(e)){r(!e.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var t=e.space,n=e;n;){var i=n.nodeNext;n.nodeIdleTime=0,n.nodeRoot=null,n.nodeNext=null,t.activateBody(n),n=i}a(t.sleepingComponents,e)}};it.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,rn(nn(this)))},it.prototype.activateStatic=function(e){r(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var t=this.arbiterList;t;t=t.next(this))e&&e!=t.a&&e!=t.b||(t.body_a==this?t.body_b:t.body_a).activate()},it.prototype.pushArbiter=function(e){i(null===(e.body_a===this?e.thread_a_next:e.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),i(null===(e.body_a===this?e.thread_a_prev:e.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var t=this.arbiterList;i(null===t||null===(t.body_a===this?t.thread_a_prev:t.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),e.body_a===this?e.thread_a_next=t:e.thread_b_next=t,t&&(t.body_a===this?t.thread_a_prev=e:t.thread_b_prev=e),this.arbiterList=e};var sn=function(e,t){t.nodeRoot=e,t!==e&&(t.nodeNext=e.nodeNext,e.nodeNext=t)},on=function(e,t){if(!t.isRogue()){var n=nn(t);if(null==n){sn(e,t);for(var r=t.arbiterList;r;r=r.next(t))on(e,t==r.body_a?r.body_b:r.body_a);for(var s=t.constraintList;s;s=s.next(t))on(e,t==s.a?s.b:s.a)}else i(n===e,"Internal Error: Inconsistency detected in the contact graph.")}},un=function(e,t){for(var n=e;n;n=n.nodeNext)if(n.nodeIdleTime<t)return!0;return!1};en.prototype.processComponents=function(e){for(var t=1/0!==this.sleepTimeThreshold,n=this.bodies,r=0;r<n.length;r++){var s=n[r];i(null===s.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),i(null===s.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(t)for(var o=this.idleSpeedThreshold,u=o?o*o:D(this.gravity)*e*e,r=0;r<n.length;r++){var s=n[r],a=u?s.m*u:0;s.nodeIdleTime=s.kineticEnergy()>a?0:s.nodeIdleTime+e}for(var f=this.arbiters,r=0,l=f.length;l>r;r++){var c=f[r],h=c.body_a,p=c.body_b;t&&((p.isRogue()&&!p.isStatic()||h.isSleeping())&&h.activate(),(h.isRogue()&&!h.isStatic()||p.isSleeping())&&p.activate()),h.pushArbiter(c),p.pushArbiter(c)}if(t){for(var d=this.constraints,r=0;r<d.length;r++){var v=d[r],h=v.a,p=v.b;p.isRogue()&&!p.isStatic()&&h.activate(),h.isRogue()&&!h.isStatic()&&p.activate()}for(var r=0;r<n.length;){var s=n[r];if(null!==nn(s)||(on(s,s),un(s,this.sleepTimeThreshold)))r++,s.nodeRoot=null,s.nodeNext=null;else{this.sleepingComponents.push(s);for(var m=s;m;m=m.nodeNext)this.deactivateBody(m)}}}},it.prototype.sleep=function(){this.sleepWithGroup(null)},it.prototype.sleepWithGroup=function(e){r(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var t=this.space;if(r(t,"Cannot put a rogue body to sleep."),r(!t.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),r(null===e||e.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return r(nn(this)===nn(e),"The body is already sleeping and it's group cannot be reassigned."),void 0;for(var n=0;n<this.shapeList.length;n++)this.shapeList[n].update(this.p,this.rot);if(t.deactivateBody(this),e){var i=nn(e);this.nodeRoot=i,this.nodeNext=i.nodeNext,this.nodeIdleTime=0,i.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,t.sleepingComponents.push(this);a(t.bodies,this)},en.prototype.activateShapesTouchingShape=function(e){1/0!==this.sleepTimeThreshold&&this.shapeQuery(e,function(e){e.body.activate()})},en.prototype.pointQuery=function(e,t,n,r){var i=function(i){(!i.group||n!==i.group)&&t&i.layers&&i.pointQuery(e)&&r(i)},s=new z(e.x,e.y,e.x,e.y);this.lock(),this.activeShapes.query(s,i),this.staticShapes.query(s,i),this.unlock(!0)},en.prototype.pointQueryFirst=function(e,t,n){var r=null;return this.pointQuery(e,t,n,function(e){e.sensor||(r=e)}),r},en.prototype.nearestPointQuery=function(e,t,n,r,i){var s=function(s){if((!s.group||r!==s.group)&&n&s.layers){var o=s.nearestPointQuery(e);o.d<t&&i(s,o.d,o.p)}},o=W(e,t);this.lock(),this.activeShapes.query(o,s),this.staticShapes.query(o,s),this.unlock(!0)},en.prototype.nearestPointQueryNearest=function(e,t,n,r){var i,s=function(s){if((!s.group||r!==s.group)&&n&s.layers&&!s.sensor){var o=s.nearestPointQuery(e);o.d<t&&(!i||o.d<i.d)&&(i=o)}},o=W(e,t);return this.activeShapes.query(o,s),this.staticShapes.query(o,s),i},en.prototype.segmentQuery=function(e,t,n,r,i){var s=function(s){var o;return(!s.group||r!==s.group)&&n&s.layers&&(o=s.segmentQuery(e,t))&&i(s,o.t,o.n),1};this.lock(),this.staticShapes.segmentQuery(e,t,1,s),this.activeShapes.segmentQuery(e,t,1,s),this.unlock(!0)},en.prototype.segmentQueryFirst=function(e,t,n,r){var i=null,s=function(s){var o;return(!s.group||r!==s.group)&&n&s.layers&&!s.sensor&&(o=s.segmentQuery(e,t))&&(null===i||o.t<i.t)&&(i=o),i?i.t:1};return this.staticShapes.segmentQuery(e,t,1,s),this.activeShapes.segmentQuery(e,t,i?i.t:1,s),i},en.prototype.bbQuery=function(e,t,n,r){var i=function(i){(!i.group||n!==i.group)&&t&i.layers&&X(e,i.bb_l,i.bb_b,i.bb_r,i.bb_t)&&r(i)};this.lock(),this.activeShapes.query(e,i),this.staticShapes.query(e,i),this.unlock(!0)},en.prototype.shapeQuery=function(e,t){var n=e.body;n&&e.update(n.p,n.rot);var r=new z(e.bb_l,e.bb_b,e.bb_r,e.bb_t),i=!1,s=function(n){var r=e;if((!r.group||r.group!==n.group)&&r.layers&n.layers&&r!==n){var s;if(r.collisionCode<=n.collisionCode)s=Yt(r,n);else{s=Yt(n,r);for(var o=0;o<s.length;o++)s[o].n=N(s[o].n)}if(s.length&&(i=!(r.sensor||n.sensor),t)){for(var u=new Array(s.length),o=0;o<s.length;o++)u[o]=new Dt(s[o].p,s[o].n,s[o].dist);t(n,u)}}};return this.lock(),this.activeShapes.query(r,s),this.staticShapes.query(r,s),this.unlock(!0),i},en.prototype.addPostStepCallback=function(e){i(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(e)},en.prototype.runPostStepCallbacks=function(){for(var e=0;e<this.postStepCallbacks.length;e++)this.postStepCallbacks[e]();this.postStepCallbacks=[]},en.prototype.lock=function(){this.locked++},en.prototype.unlock=function(e){if(this.locked--,r(this.locked>=0,"Internal Error: Space lock underflow."),0===this.locked&&e){for(var t=this.rousedBodies,n=0;n<t.length;n++)this.activateBody(t[n]);t.length=0,this.runPostStepCallbacks()}},en.prototype.makeCollideShapes=function(){var e=this;return function(t,n){var r=e;if(t.bb_l<=n.bb_r&&n.bb_l<=t.bb_r&&t.bb_b<=n.bb_t&&n.bb_b<=t.bb_t&&t.body!==n.body&&(!t.group||t.group!==n.group)&&t.layers&n.layers){var i=r.lookupHandler(t.collision_type,n.collision_type),s=t.sensor||n.sensor;if(!s||i!==Zt){if(t.collisionCode>n.collisionCode){var o=t;t=n,n=o}var a=Yt(t,n);if(0!==a.length){var f=u(t.hashid,n.hashid),l=r.cachedArbiters[f];l||(l=r.cachedArbiters[f]=new _t(t,n)),l.update(a,i,t,n),"first coll"!=l.state||i.begin(l,r)||l.ignore(),"ignore"!==l.state&&i.preSolve(l,r)&&!s?r.arbiters.push(l):(l.contacts=null,"ignore"!==l.state&&(l.state="normal")),l.stamp=r.stamp}}}}},en.prototype.arbiterSetFilter=function(e){var t=this.stamp-e.stamp,n=e.body_a,r=e.body_b;return(n.isStatic()||n.isSleeping())&&(r.isStatic()||r.isSleeping())?!0:(t>=1&&"cached"!=e.state&&(e.callSeparate(this),e.state="cached"),t>=this.collisionPersistence?(e.contacts=null,!1):!0)};var an=function(e){var t=e.body;e.update(t.p,t.rot)};en.prototype.step=function(e){if(0!==e){r(0===y.x&&0===y.y,"vzero is invalid"),this.stamp++;var t=this.curr_dt;this.curr_dt=e;var n,i,s,o=this.bodies,u=this.constraints,a=this.arbiters;for(n=0;n<a.length;n++){var f=a[n];f.state="normal",f.body_a.isSleeping()||f.body_b.isSleeping()||f.unthread()}for(a.length=0,this.lock(),n=0;n<o.length;n++)o[n].position_func(e);this.activeShapes.each(an),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(e),this.lock();for(s in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[s])||delete this.cachedArbiters[s];var l=this.collisionSlop,c=1-Math.pow(this.collisionBias,e);for(n=0;n<a.length;n++)a[n].preStep(e,l,c);for(n=0;n<u.length;n++){var h=u[n];h.preSolve(this),h.preStep(e)}var p=Math.pow(this.damping,e),d=this.gravity;for(n=0;n<o.length;n++)o[n].velocity_func(d,p,e);var v=0===t?0:e/t;for(n=0;n<a.length;n++)a[n].applyCachedImpulse(v);for(n=0;n<u.length;n++)u[n].applyCachedImpulse(v);for(n=0;n<this.iterations;n++){for(i=0;i<a.length;i++)a[i].applyImpulse();for(i=0;i<u.length;i++)u[i].applyImpulse()}for(n=0;n<u.length;n++)u[n].postSolve(this);for(n=0;n<a.length;n++)a[n].handler.postSolve(a[n],this);this.unlock(!0)}};var fn=function(e,t,n,r){var i=e.vx+ -n.y*e.w,s=e.vy+n.x*e.w,o=t.vx+ -r.y*t.w,u=t.vy+r.x*t.w;return new g(o-i,u-s)},ln=function(e,t,n,r,i){var s=e.vx+ -n.y*e.w,o=e.vy+n.x*e.w,u=t.vx+ -r.y*t.w,a=t.vy+r.x*t.w;return w(u-s,a-o,i.x,i.y)},cn=function(e,t,n,r){e.vx+=t*e.m_inv,e.vy+=n*e.m_inv,e.w+=e.i_inv*(r.x*n-r.y*t)},hn=function(e,t,n,r,i,s){cn(e,-i,-s,n),cn(t,i,s,r)},pn=function(e,t,n,r){e.v_biasx+=t*e.m_inv,e.v_biasy+=n*e.m_inv,e.w_bias+=e.i_inv*L(r.x,r.y,t,n)},dn=function(e,t,n){var r=k(t,n);return e.m_inv+e.i_inv*r*r},vn=function(e,t,n,r,s){var o=dn(e,n,s)+dn(t,r,s);return i(0!==o,"Unsolvable collision or constraint."),o},mn=function(e,t,n,r,s,o){var u,a,f,l,c=e.m_inv+t.m_inv;u=c,a=0,f=0,l=c;var h=e.i_inv,p=n.x*n.x*h,d=n.y*n.y*h,v=-n.x*n.y*h;u+=d,a+=v,f+=v,l+=p;var m=t.i_inv,g=r.x*r.x*m,y=r.y*r.y*m,b=-r.x*r.y*m;u+=y,a+=b,f+=b,l+=g;var w=u*l-a*f;i(0!==w,"Unsolvable constraint.");var E=1/w;s.x=l*E,s.y=-a*E,o.x=-f*E,o.y=u*E},gn=function(e,t,n){return new g(b(e,t),b(e,n))},yn=function(e,t){return 1-Math.pow(e,t)},bn=e.Constraint=function(e,t){this.a=e,this.b=t,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};bn.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},bn.prototype.preStep=function(){},bn.prototype.applyCachedImpulse=function(){},bn.prototype.applyImpulse=function(){},bn.prototype.getImpulse=function(){return 0},bn.prototype.preSolve=function(){},bn.prototype.postSolve=function(){},bn.prototype.next=function(e){return this.a===e?this.next_a:this.next_b};var wn=e.PinJoint=function(e,t,n,r){bn.call(this,e,t),this.anchr1=n,this.anchr2=r;var s=e?x(e.p,M(n,e.rot)):n,o=t?x(t.p,M(r,t.rot)):r;this.dist=E(T(o,s)),i(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};wn.prototype=Object.create(bn.prototype),wn.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=M(this.anchr1,t.rot),this.r2=M(this.anchr2,n.rot);var r=T(x(n.p,this.r2),x(t.p,this.r1)),i=E(r);this.n=C(r,1/(i?i:1/0)),this.nMass=1/vn(t,n,this.r1,this.r2,this.n);var s=this.maxBias;this.bias=v(-yn(this.errorBias,e)*(i-this.dist)/e,-s,s),this.jnMax=this.maxForce*e},wn.prototype.applyCachedImpulse=function(e){var t=C(this.n,this.jnAcc*e);hn(this.a,this.b,this.r1,this.r2,t.x,t.y)},wn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.n,r=ln(e,t,this.r1,this.r2,n),i=(this.bias-r)*this.nMass,s=this.jnAcc;this.jnAcc=v(s+i,-this.jnMax,this.jnMax),i=this.jnAcc-s,hn(e,t,this.r1,this.r2,n.x*i,n.y*i)},wn.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var En=e.SlideJoint=function(e,t,n,r,i,s){bn.call(this,e,t),this.anchr1=n,this.anchr2=r,this.min=i,this.max=s,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};En.prototype=Object.create(bn.prototype),En.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=M(this.anchr1,t.rot),this.r2=M(this.anchr2,n.rot);var r=T(x(n.p,this.r2),x(t.p,this.r1)),i=E(r),s=0;i>this.max?(s=i-this.max,this.n=j(r)):i<this.min?(s=this.min-i,this.n=N(j(r))):(this.n=y,this.jnAcc=0),this.nMass=1/vn(t,n,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=v(-yn(this.errorBias,e)*s/e,-o,o),this.jnMax=this.maxForce*e},En.prototype.applyCachedImpulse=function(e){var t=this.jnAcc*e;hn(this.a,this.b,this.r1,this.r2,this.n.x*t,this.n.y*t)},En.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var e=this.a,t=this.b,n=this.n,r=this.r1,i=this.r2,s=fn(e,t,r,i),o=b(s,n),u=(this.bias-o)*this.nMass,a=this.jnAcc;this.jnAcc=v(a+u,-this.jnMax,0),u=this.jnAcc-a,hn(e,t,this.r1,this.r2,n.x*u,n.y*u)}},En.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Sn=e.PivotJoint=function(e,t,n,r){if(bn.call(this,e,t),"undefined"==typeof r){var i=n;n=e?e.world2Local(i):i,r=t?t.world2Local(i):i}this.anchr1=n,this.anchr2=r,this.r1=this.r2=y,this.k1=new g(0,0),this.k2=new g(0,0),this.jAcc=y,this.jMaxLen=0,this.bias=y};Sn.prototype=Object.create(bn.prototype),Sn.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=M(this.anchr1,t.rot),this.r2=M(this.anchr2,n.rot),mn(t,n,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*e;var r=T(x(n.p,this.r2),x(t.p,this.r1));this.bias=F(C(r,-yn(this.errorBias,e)/e),this.maxBias)},Sn.prototype.applyCachedImpulse=function(e){hn(this.a,this.b,this.r1,this.r2,this.jAcc.x*e,this.jAcc.y*e)},Sn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.r1,r=this.r2,i=fn(e,t,n,r),s=gn(T(this.bias,i),this.k1,this.k2),o=this.jAcc;this.jAcc=F(x(this.jAcc,s),this.jMaxLen),hn(e,t,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Sn.prototype.getImpulse=function(){return E(this.jAcc)};var xn=e.GrooveJoint=function(e,t,n,r,i){bn.call(this,e,t),this.grv_a=n,this.grv_b=r,this.grv_n=A(B(T(r,n))),this.anchr2=i,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new g(0,0),this.k2=new g(0,0),this.jAcc=y,this.jMaxLen=0,this.bias=null};xn.prototype=Object.create(bn.prototype),xn.prototype.preStep=function(e){var t=this.a,n=this.b,r=t.local2World(this.grv_a),i=t.local2World(this.grv_b),s=M(this.grv_n,t.rot),o=b(r,s);this.grv_tn=s,this.r2=M(this.anchr2,n.rot);var u=k(x(n.p,this.r2),s);u<=k(r,s)?(this.clamp=1,this.r1=T(r,t.p)):u>=k(i,s)?(this.clamp=-1,this.r1=T(i,t.p)):(this.clamp=0,this.r1=T(x(C(A(s),-u),C(s,o)),t.p)),mn(t,n,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*e;var a=T(x(n.p,this.r2),x(t.p,this.r1));this.bias=F(C(a,-yn(this.errorBias,e)/e),this.maxBias)},xn.prototype.applyCachedImpulse=function(e){hn(this.a,this.b,this.r1,this.r2,this.jAcc.x*e,this.jAcc.y*e)},xn.prototype.grooveConstrain=function(e){var t=this.grv_tn,n=this.clamp*k(e,t)>0?e:O(e,t);return F(n,this.jMaxLen)},xn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.r1,r=this.r2,i=fn(e,t,n,r),s=gn(T(this.bias,i),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(x(o,s)),hn(e,t,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},xn.prototype.getImpulse=function(){return E(this.jAcc)},xn.prototype.setGrooveA=function(e){this.grv_a=e,this.grv_n=A(B(T(this.grv_b,e))),this.activateBodies()},xn.prototype.setGrooveB=function(e){this.grv_b=e,this.grv_n=A(B(T(e,this.grv_a))),this.activateBodies()};var Tn=function(e,t){return(e.restLength-t)*e.stiffness},Nn=e.DampedSpring=function(e,t,n,r,i,s,o){bn.call(this,e,t),this.anchr1=n,this.anchr2=r,this.restLength=i,this.stiffness=s,this.damping=o,this.springForceFunc=Tn,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};Nn.prototype=Object.create(bn.prototype),Nn.prototype.preStep=function(e){var t=this.a,n=this.b;this.r1=M(this.anchr1,t.rot),this.r2=M(this.anchr2,n.rot);var r=T(x(n.p,this.r2),x(t.p,this.r1)),s=E(r);this.n=C(r,1/(s?s:1/0));var o=vn(t,n,this.r1,this.r2,this.n);i(0!==o,"Unsolvable this."),this.nMass=1/o,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*e*o);var u=this.springForceFunc(this,s);hn(t,n,this.r1,this.r2,this.n.x*u*e,this.n.y*u*e)},Nn.prototype.applyCachedImpulse=function(){},Nn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=this.n,r=this.r1,i=this.r2,s=ln(e,t,r,i,n),o=(this.target_vrn-s)*this.v_coef;this.target_vrn=s+o,o*=this.nMass,hn(e,t,this.r1,this.r2,this.n.x*o,this.n.y*o)},Nn.prototype.getImpulse=function(){return 0};var Cn=function(e,t){return(t-e.restAngle)*e.stiffness},kn=e.DampedRotarySpring=function(e,t,n,r,i){bn.call(this,e,t),this.restAngle=n,this.stiffness=r,this.damping=i,this.springTorqueFunc=Cn,this.target_wrn=0,this.w_coef=0,this.iSum=0};kn.prototype=Object.create(bn.prototype),kn.prototype.preStep=function(e){var t=this.a,n=this.b,r=t.i_inv+n.i_inv;i(0!==r,"Unsolvable spring."),this.iSum=1/r,this.w_coef=1-Math.exp(-this.damping*e*r),this.target_wrn=0;var s=this.springTorqueFunc(this,t.a-n.a)*e;t.w-=s*t.i_inv,n.w+=s*n.i_inv},kn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=e.w-t.w,r=(this.target_wrn-n)*this.w_coef;this.target_wrn=n+r;var i=r*this.iSum;e.w+=i*e.i_inv,t.w-=i*t.i_inv};var Ln=e.RotaryLimitJoint=function(e,t,n,r){bn.call(this,e,t),this.min=n,this.max=r,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Ln.prototype=Object.create(bn.prototype),Ln.prototype.preStep=function(e){var t=this.a,n=this.b,r=n.a-t.a,i=0;r>this.max?i=this.max-r:r<this.min&&(i=this.min-r),this.iSum=1/(1/t.i+1/n.i);var s=this.maxBias;this.bias=v(-yn(this.errorBias,e)*i/e,-s,s),this.jMax=this.maxForce*e,this.bias||(this.jAcc=0)},Ln.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},Ln.prototype.applyImpulse=function(){if(this.bias){var e=this.a,t=this.b,n=t.w-e.w,r=-(this.bias+n)*this.iSum,i=this.jAcc;this.jAcc=this.bias<0?v(i+r,0,this.jMax):v(i+r,-this.jMax,0),r=this.jAcc-i,e.w-=r*e.i_inv,t.w+=r*t.i_inv}},Ln.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var An=e.RatchetJoint=function(e,t,n,r){bn.call(this,e,t),this.angle=0,this.phase=n,this.ratchet=r,this.angle=(t?t.a:0)-(e?e.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};An.prototype=Object.create(bn.prototype),An.prototype.preStep=function(e){var t=this.a,n=this.b,r=this.angle,i=this.phase,s=this.ratchet,o=n.a-t.a,u=r-o,a=0;u*s>0?a=u:this.angle=Math.floor((o-i)/s)*s+i,this.iSum=1/(t.i_inv+n.i_inv);var f=this.maxBias;this.bias=v(-yn(this.errorBias,e)*a/e,-f,f),this.jMax=this.maxForce*e,this.bias||(this.jAcc=0)},An.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},An.prototype.applyImpulse=function(){if(this.bias){var e=this.a,t=this.b,n=t.w-e.w,r=this.ratchet,i=-(this.bias+n)*this.iSum,s=this.jAcc;this.jAcc=v((s+i)*r,0,this.jMax*Math.abs(r))/r,i=this.jAcc-s,e.w-=i*e.i_inv,t.w+=i*t.i_inv}},An.prototype.getImpulse=function(e){return Math.abs(e.jAcc)};var On=e.GearJoint=function(e,t,n,r){bn.call(this,e,t),this.phase=n,this.ratio=r,this.ratio_inv=1/r,this.jAcc=0,this.iSum=this.bias=this.jMax=0};On.prototype=Object.create(bn.prototype),On.prototype.preStep=function(e){var t=this.a,n=this.b;this.iSum=1/(t.i_inv*this.ratio_inv+this.ratio*n.i_inv);var r=this.maxBias;this.bias=v(-yn(this.errorBias,e)*(n.a*this.ratio-t.a-this.phase)/e,-r,r),this.jMax=this.maxForce*e},On.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv*this.ratio_inv,n.w+=r*n.i_inv},On.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=t.w*this.ratio-e.w,r=(this.bias-n)*this.iSum,i=this.jAcc;this.jAcc=v(i+r,-this.jMax,this.jMax),r=this.jAcc-i,e.w-=r*e.i_inv*this.ratio_inv,t.w+=r*t.i_inv},On.prototype.getImpulse=function(){return Math.abs(this.jAcc)},On.prototype.setRatio=function(e){this.ratio=e,this.ratio_inv=1/e,this.activateBodies()};var Mn=e.SimpleMotor=function(e,t,n){bn.call(this,e,t),this.rate=n,this.jAcc=0,this.iSum=this.jMax=0};Mn.prototype=Object.create(bn.prototype),Mn.prototype.preStep=function(e){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*e},Mn.prototype.applyCachedImpulse=function(e){var t=this.a,n=this.b,r=this.jAcc*e;t.w-=r*t.i_inv,n.w+=r*n.i_inv},Mn.prototype.applyImpulse=function(){var e=this.a,t=this.b,n=t.w-e.w+this.rate,r=-n*this.iSum,i=this.jAcc;this.jAcc=v(i+r,-this.jMax,this.jMax),r=this.jAcc-i,e.w-=r*e.i_inv,t.w+=r*t.i_inv},Mn.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}();var AWGLActor,AWGLActorInterface,AWGLAjax,AWGLAnimationInterface,AWGLBezAnimation,AWGLColor3,AWGLEngine,AWGLEngineInterface,AWGLInterface,AWGLLog,AWGLPhysics,AWGLPsyxAnimation,AWGLRenderer,AWGLShader,AWGLUtilParam,AWGLVertAnimation;AWGLUtilParam=function(){function e(){}return e.required=function(e,t,n){var r,i,s,o;if(null===e&&n!==!0&&(e=void 0),void 0===e)throw new Error("Required argument missing!");if(t instanceof Array&&t.length>0){for(r=!1,s=0,o=t.length;o>s;s++)if(i=t[s],e===i){r=!0;break}if(!r)throw new Error("Required argument is not of a valid value!")}return e},e.optional=function(e,t,n,r){var i,s,o,u;if(null===e&&r!==!0&&(e=void 0),void 0===e&&(e=t),n instanceof Array&&n.length>0){for(i=!1,o=0,u=n.length;u>o;o++)if(s=n[o],e===s){i=!0;break}if(!i)throw new Error("Required argument is not of a valid value!")}return e},e}(),void 0===window.param&&(window.param=AWGLUtilParam),AWGLActor=function(){function e(e,t){if(param.required(e),t=param.optional(t,null),this._gl=AWGLRenderer._gl,void 0===this._gl||null===this._gl)throw new Error("GL context is required for actor initialization!");this._color=null,this._colArray=null,this.lit=!1,this.visible=!0,this.layer=0,this._physicsLayer=-1,this._id=-1,this._position=new cp.v(0,0),this._rotation=0,this._rotV=null,this._transV=null,this._modelM=null,this._shape=null,this._body=null,this._friction=null,this._mass=null,this._elasticity=null,this._vertices=[],this._psyxVertices=[],this._vertBuffer=null,this._vertBufferFloats=null,this._sh_modelview=null,this._sh_position=null,this._sh_color=null,this._renderMode=1,this._id=AWGLRenderer._nextID++,AWGLRenderer.addActor(this),this.updateVertices(e,t),this.setColor(new AWGLColor3(255,255,255)),this._rotV=$V([0,0,1]),this._transV=$V([0,0,1]),this._modelM=Matrix.I(4),this.clearTexture(),this._attachedTexture=null,this.attachedTextureAnchor={x:0,y:0,angle:0}}return e.defaultFriction=.3,e.defaultMass=10,e.defaultElasticity=.2,e._nullV=new cp.v(0,0),e.prototype.getMaterial=function(){return this._material},e.prototype.setLayer=function(e){return this.layer=param.required(e),AWGLRenderer.removeActor(this),AWGLRenderer.addActor(this)},e.prototype.setTexture=function(e){if(param.required(e),!AWGLRenderer.hasTexture(e))throw new Error("No such texture loaded: "+e);return this._texture=AWGLRenderer.getTexture(e),this.setShader(AWGLRenderer.getMe().getTextureShader()),this._material="texture"},e.prototype.clearTexture=function(){return this._texture=void 0,this.setShader(AWGLRenderer.getMe().getDefaultShader()),this._material="flat"},e.prototype.getTexture=function(){return this._texture},e.prototype.setShader=function(e){var t;if(param.required(e),null===e.getProgram())throw new Error("Shader has to be built before it can be used!");return null===e.getHandles()&&e.generateHandles(),t=e.getHandles(),this._sh_modelview=t.ModelView,this._sh_position=t.Position,this._sh_color=t.Color,this._sh_texture=t.aTexCoord,this._sh_sampler=t.uSampler},e.prototype.createPhysicsBody=function(t,n,r){var i,s,o,u,f,l,c,h,p,d,v,m;if(this._mass=t,this._friction=n,this._elasticity=r,(null===AWGLPhysics.getWorld()||void 0===AWGLPhysics.getWorld())&&AWGLPhysics.startStepping(),this._shape!==!0){for(0===AWGLPhysics.bodyCount&&AWGLPhysics.startStepping(),AWGLPhysics.bodyCount++,(void 0===this._mass||null===this._mass)&&(this._mass=0),this._mass<0&&(this._mass=0),void 0===this._friction?this._friction=e.defaultFriction:this._friction<0&&(this._friction=0),void 0===this._elasticity?this._elasticity=e.defaultElasticity:this._elasticity<0&&(this._elasticity=0),h=[],c=0,u=null,u=this._psyxVertices.length>6?this._psyxVertices:this._vertices,s=v=0,m=u.length-1;m>v;s=v+=2)h.push(u[s]/AWGLRenderer.getPPM()),h.push(u[s+1]/AWGLRenderer.getPPM()),0===this._mass&&(p=h[h.length-2],d=h[h.length-1],i=this._rotation,h[h.length-2]=p*Math.cos(i)-d*Math.sin(i),h[h.length-1]=p*Math.sin(i)+d*Math.cos(i));return l=AWGLPhysics.getWorld(),f=AWGLRenderer.screenToWorld(this._position),0===this._mass?(this._shape=l.addShape(new cp.PolyShape(l.staticBody,h,f)),this._shape.setLayers(this._physicsLayer),this._body=null):(o=cp.momentForPoly(this._mass,h,e._nullV),this._body=l.addBody(new cp.Body(this._mass,o)),this._body.setPos(f),this._body.setAngle(this._rotation),this._shape=l.addShape(new cp.PolyShape(this._body,h,e._nullV)),this._shape.setLayers(this._physicsLayer)),this._shape.setFriction(this._friction),this._shape.setElasticity(this._elasticity)}},e.prototype.destroyPhysicsBody=function(){if(0!==AWGLPhysics.bodyCount&&null!==this._shape){if(AWGLPhysics.bodyCount--,AWGLPhysics.getWorld().removeShape(this._shape),this._body&&AWGLPhysics.getWorld().removeBody(this._body),this._shape=null,this._body=null,0===AWGLPhysics.bodyCount)return AWGLPhysics.stopStepping();if(AWGLPhysics.bodyCount<0)throw new Error("Body count is negative!")}},e.prototype.setPhysicsLayer=function(e){return this._physicsLayer=1<<param.required(e,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]),null!==this._shape?this._shape.setLayers(this._physicsLayer):void 0},e.prototype.updateVertices=function(e,t){if(this._vertices=param.required(e),this._texVerts=param.optional(t,null),this._vertices.length<6)throw new Error("At least 3 vertices make up an actor");if(null!==this._texVerts&&this._vertices.length!==this._texVerts.length)throw new Error("Vert array and texture vert array lengths must match!");return this._vertBuffer=this._gl.createBuffer(),this._vertBufferFloats=new Float32Array(this._vertices),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertBufferFloats,this._gl.STATIC_DRAW),null!==this._texVerts&&(this._texBuffer=this._gl.createBuffer(),this._texVBufferFloats=new Float32Array(this._texVerts),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._texBuffer),this._gl.bufferData(this._gl.ARRAY_BUFFER,this._texVBufferFloats,this._gl.STATIC_DRAW)),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)},e.prototype.setPhysicsVertices=function(e){return this._psyxVertices=param.required(e),null!==this._body?(this.destroyPhysicsBody(),this.createPhysicsBody(this._mass,this._friction,this._elasticity)):void 0},e.prototype.attachTexture=function(t,n,r,i,s,o){var u,f;if(param.required(t),param.required(n),param.required(r),this.attachedTextureAnchor.x=param.optional(i,0),this.attachedTextureAnchor.y=param.optional(s,0),this.attachedTextureAnchor.angle=param.optional(o,0),!AWGLRenderer.hasTexture(t))throw new Error("No such texture loaded: "+t);return null!==this._attachedTexture&&this.removeAttachment(),f=n/2,u=r/2,this._attachedTexture=new e([-f,-u,-f,u,f,u,f,-u,-f,-u],[0,0,1,0,1,1,0,1,0,0]),this._attachedTexture.setTexture(t),this._attachedTexture},e.prototype.removeAttachment=function(){var e,t,n,r,i;if(null===this._attachedTexture)return!1;for(i=AWGLRenderer.actors,t=n=0,r=i.length;r>n;t=++n)if(e=i[t],e.getId()===this._attachedTexture.getId())return e.destroyPhysicsBody(),AWGLRenderer.actors.splice(t,1),this._attachedTexture=null,!0;return!1},e.prototype.setAttachmentVisibility=function(e){return param.required(e),null===this._attachedTexture?!1:(this._attachedTexture.visible=e,!0)},e.prototype.hasAttachment=function(){return null!==this._attachedTexture},e.prototype.getAttachment=function(){return this._attachedTexture},e.prototype.updatePosition=function(){return null!==this._body?(this._position=AWGLRenderer.worldToScreen(this._body.getPos()),this._rotation=this._body.a):void 0},e.prototype.draw=function(e){var t;if(param.required(e),this.visible){if(this.updatePosition(),this._modelM=Matrix.I(4),this._transV.elements[0]=this._position.x-AWGLRenderer.camPos.x,this._transV.elements[1]=this._position.y-AWGLRenderer.camPos.y,this._modelM=this._modelM.x(Matrix.Translation(this._transV).ensure4x4()),this._modelM=this._modelM.x(Matrix.Rotation(this._rotation,this._rotV).ensure4x4()),t=new Float32Array(this._modelM.flatten()),e.bindBuffer(e.ARRAY_BUFFER,this._vertBuffer),e.vertexAttribPointer(this._sh_position,2,e.FLOAT,!1,0,0),e.uniform4f(this._sh_color,this._colArray[0],this._colArray[1],this._colArray[2],1),e.uniformMatrix4fv(this._sh_modelview,!1,t),"texture"===this._material&&(e.bindBuffer(e.ARRAY_BUFFER,this._texBuffer),e.vertexAttribPointer(this._sh_texture,2,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture),e.uniform1i(this._sh_sampler,0)),1===this._renderMode)return e.drawArrays(e.TRIANGLE_STRIP,0,this._vertices.length/2);if(2===this._renderMode)return e.drawArrays(e.TRIANGLE_FAN,0,this._vertices.length/2);throw new Error("Invalid render mode! "+this._renderMode)}},e.prototype.setRenderMode=function(e){return this._renderMode=param.required(e,[1,2])},e.prototype.setPosition=function(e){return param.required(e),null===this._shape?this._position=e instanceof cp.v?e:new cp.v(Number(e.x),Number(e.y)):null!==this._body?this._body.setPos(AWGLRenderer.screenToWorld(e)):void 0},e.prototype.setRotation=function(e,t){return param.required(e),t=param.optional(t,!1),t===!1&&(e=.0174532925*Number(e)),null===this._shape?this._rotation=e:null!==this._body?this._body.SetAngle(this._rotation):void 0},e.prototype.getPosition=function(){return this._position},e.prototype.getRotation=function(e){return e=param.optional(e,!1),e===!1?57.2957795*this._rotation:this._rotation},e.prototype.getVertices=function(){return this._vertices},e.prototype.getId=function(){return this._id},e.prototype.getColor=function(){return new AWGLColor3(this._color)},e.prototype.setColor=function(e,t,n){return param.required(e),(void 0===this._color||null===this._color)&&(this._color=new AWGLColor3),e instanceof AWGLColor3?(this._color=e,this._colArray=[e.getR(!0),e.getG(!0),e.getB(!0)]):(param.required(t),param.required(n),this._color.setR(Number(e)),this._color.setG(Number(t)),this._color.setB(Number(n)),this._colArray=[this._color.getR(!0),this._color.getG(!0),this._color.getB(!0)])},e}(),AWGLColor3=function(){function e(t,n,r){t=param.optional(t,0),n=param.optional(n,0),r=param.optional(r,0),t instanceof e?(this._r=t.getR(),this._g=t.getG(),this._b=t.getB()):(this.setR(t),this.setG(n),this.setB(r))}return e.prototype.getR=function(e){return e!==!0?this._r:this._r/255},e.prototype.getG=function(e){return e!==!0?this._g:this._g/255},e.prototype.getB=function(e){return e!==!0?this._b:this._b/255},e.prototype.setR=function(e){return e=Number(e),0>e&&(e=0),e>255&&(e=255),this._r=e},e.prototype.setG=function(e){return e=Number(e),0>e&&(e=0),e>255&&(e=255),this._g=e},e.prototype.setB=function(e){return e=Number(e),0>e&&(e=0),e>255&&(e=255),this._b=e},e.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"},e}(),AWGLShader=function(){function e(e,t,n,r){var i;if(this._vertSrc=e,this._fragSrc=t,this._gl=n,param.required(this._vertSrc),param.required(this._fragSrc),param.required(this._gl),r=param.optional(r,!1),this.errors=[],this._prog=null,this._vertShader=null,this._fragShader=null,this._handles=null,r===!0&&(i=this.build(this._gl),i===!1))throw new Error("Failed to build shader! "+JSON.stringify(this.errors))}return e.prototype.build=function(e){var t;if(this._gl=e,param.required(this._gl),t=this._gl,this.errors=[],void 0===t||null===t)throw new Error("Need a valid gl object to build a shader!");return this._vertShader=t.createShader(t.VERTEX_SHADER),this._fragShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(this._vertShader,this._vertSrc),t.shaderSource(this._fragShader,this._fragSrc),t.compileShader(this._vertShader),t.compileShader(this._fragShader),t.getShaderParameter(this._vertShader,t.COMPILE_STATUS)||this.errors.push(t.getShaderInfoLog(this._vertShader)),t.getShaderParameter(this._fragShader,t.COMPILE_STATUS)||this.errors.push(t.getShaderInfoLog(this._fragShader)),this._prog=t.createProgram(),t.attachShader(this._prog,this._vertShader),t.attachShader(this._prog,this._fragShader),t.linkProgram(this._prog),t.getProgramParameter(this._prog,t.LINK_STATUS)||this.errors.push("Failed to link!"),this.errors.length>0?!1:!0},e.prototype.generateHandles=function(){var e,t,n,r,i,s,o,u,a;if(null===this._prog)return AWGLEngine.getLog().error("Build program before generating handles"),!1;if(null!==this._handles)return AWGLEngine.getLog().warn("Refusing to re-generate handles!"),!1;for(this._handles={},u=function(e,t,n){var r,i;if(e=e.split(" "),r=e[e.length-1].replace(";",""),1===t){if(i={n:r,h:n._gl.getUniformLocation(n._prog,r)},"object"!=typeof i.h)throw new Error("Failed to get handle for uniform "+r+" ["+i.h+"]");return i}if(2===t)return i={n:r,h:n._gl.getAttribLocation(n._prog,r)};throw new Error("Type not 1 or 2, WTF, internal error")},a=[this._vertSrc,this._fragSrc],r=0,s=a.length;s>r;r++)for(n=a[r],n=n.split(";"),i=0,o=n.length;o>i&&(t=n[i],-1===t.indexOf("main()"));i++)-1!==t.indexOf("attribute")?(e=u(t,2,this),this._handles[e.n]=e.h):-1!==t.indexOf("uniform")&&(e=u(t,1,this),this._handles[e.n]=e.h);return!0},e.prototype.getHandles=function(){return this._handles},e.prototype.getProgram=function(){return this._prog},e}(),AWGLRenderer=function(){function e(t,n,r){var i,s,o,u,f,l;if(this._width=n,this._height=r,t=param.optional(t,""),this._defaultShader=null,this._canvas=null,this._ctx=null,this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,this.initError=void 0,0===t.length&&(t=void 0),null!==e.me)throw new Error("Only one instance of AWGLRenderer can be created!");if(e.me=this,o=null,this._width=param.optional(this._width,800),this._height=param.optional(this._height,600),this._width<=1||this._height<=1)throw new Error("Canvas must be at least 2x2 in size");return l=function(t,n,r,i){var s;return s=e.me._canvas=document.createElement("canvas"),s.width=r,s.height=i,s.id="awgl_canvas","body"===t?document.getElementsByTagName(t)[0].appendChild(s):document.getElementById(t).appendChild(s)},void 0===t||null===t?(l("body","awgl_canvas",this._width,this._height),AWGLLog.info("Creating canvas #awgl_canvas ["+this._width+"x"+this._height+"]")):(this._canvas=document.getElementById(t),null===this._canvas?(l("body",t,this._width,this._height),AWGLLog.info("Creating canvas #"+t+" ["+this._width+"x"+this._height+"]")):"canvas"===this._canvas.nodeName.toLowerCase()?(AWGLLog.warn("Canvas exists, ignoring supplied dimensions"),this._width=this._canvas.width,this._height=this._canvas.height,AWGLLog.info("Using canvas #"+t+" ["+this._width+"x"+this._height+"]")):(l(t,"awgl_canvas",this._width,this._height),AWGLLog.info("Creating canvas #awgl_canvas ["+this._width+"x"+this._height+"]"))),o=this._canvas.getContext("webgl"),null===o&&(AWGLLog.warn("Continuing with experimental webgl support"),o=this._canvas.getContext("experimental-webgl")),null===o?(alert("Your browser does not support WebGL!"),this.initError="Your browser does not support WebGL!",void 0):(e._gl=o,this._ctx=this._canvas.getContext("2d"),AWGLLog.info("Created WebGL context"),o.enable(o.DEPTH_TEST),o.enable(o.BLEND),o.depthFunc(o.LEQUAL),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),AWGLLog.info("Renderer initialized"),u="attribute vec2 Position;\n\nuniform mat4 Projection;\nuniform mat4 ModelView;\n\nvoid main() {\n  mat4 mvp = Projection * ModelView;\n  gl_Position = mvp * vec4(Position, 1, 1);\n}\n",i="precision mediump float;\nuniform vec4 Color;\n\nvoid main() {\n  gl_FragColor = Color;\n}\n",f="attribute vec2 Position;\nattribute vec2 aTexCoord;\n\nuniform mat4 Projection;\nuniform mat4 ModelView;\n\nvarying highp vec2 vTexCoord;\n\nvoid main() {\n  gl_Position = Projection * ModelView * vec4(Position, 1, 1);\n  vTexCoord = aTexCoord;\n}\n",s="precision highp float;\n\nvarying highp vec2 vTexCoord;\nuniform sampler2D uSampler;\n\nvoid main() {\n  gl_FragColor = texture2D(uSampler, vTexCoord);\n}\n",this._defaultShader=new AWGLShader(u,i,o,!0),this._defaultShader.generateHandles(),this._texShader=new AWGLShader(f,s,o,!0),this._texShader.generateHandles(),AWGLLog.info("Initialized shaders"),this.switchMaterial("flat"),this.setClearColor(0,0,0),void 0)}return e._nextID=0,e._gl=null,e._PPM=128,e.getPPM=function(){return e._PPM},e.getMPP=function(){return 1/e._PPM},e.screenToWorld=function(t){var n;return n=new cp.v,n.x=t.x/e._PPM,n.y=t.y/e._PPM,n},e.worldToScreen=function(t){var n;return n=new cp.v,n.x=t.x*e._PPM,n.y=t.y*e._PPM,n},e.actors=[],e.textures=[],e.me=null,e._currentMaterial="none",e.camPos={x:0,y:0},e.getMe=function(){return e.me},e.prototype.getDefaultShader=function(){return this._defaultShader},e.prototype.getTextureShader=function(){return this._texShader},e.prototype.getCanvas=function(){return this._canvas},e.prototype.getContext=function(){return this._ctx},e.getGL=function(){return e._gl},e.prototype.getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e.prototype.getClearColor=function(){return this._clearColor},e.prototype.setClearColor=function(t,n,r){return void 0===this._clearColor&&(this._clearColor=new AWGLColor3),t instanceof AWGLColor3?this._clearColor=t:((void 0===t||null===t)&&(t=0),(void 0===n||null===n)&&(n=0),(void 0===r||null===r)&&(r=0),this._clearColor.setR(t),this._clearColor.setG(n),this._clearColor.setB(r)),t=this._clearColor.getR(!0),n=this._clearColor.getG(!0),r=this._clearColor.getB(!0),null!==e._gl&&void 0!==e._gl?e._gl.clearColor(t,n,r,1):AWGLLog.error("Can't set clear color, AWGLRenderer._gl not valid!")},e.prototype.requestPickingRender=function(e,t){return param.required(e),param.required(t),this._pickRenderRequested?(AWGLLog.warn("Pick render already requested! No request queue"),void 0):(this._pickRenderBuff=e,this._pickRenderCB=t,this._pickRenderRequested=!0)},e.prototype.render=function(){var t,n,r,i,s,o,u,f,l,c;if(n=e._gl,void 0!==n&&null!==n){for(this._pickRenderRequested&&n.bindFramebuffer(n.FRAMEBUFFER,this._pickRenderBuff),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),l=e.actors,s=0,f=l.length;f>s;s++)t=l[s],this._pickRenderRequested?(c=t.getColor(),o=t.getId()-255*Math.floor(t.getId()/255),u=Math.floor(t.getId()/255),this.switchMaterial("flat"),t.setColor(o,u,248),t.draw(n),t.setColor(c)):(t.hasAttachment()&&t.getAttachment().visible&&(t.updatePosition(),r=t.getPosition(),i=t.getRotation(),r.x+=t.attachedTextureAnchor.x,r.y+=t.attachedTextureAnchor.y,i+=t.attachedTextureAnchor.angle,t=t.getAttachment(),t.setPosition(r),t.setRotation(i)),t.getMaterial()!==e._currentMaterial&&this.switchMaterial(t.getMaterial()),t.draw(n));return this._pickRenderRequested?(this._pickRenderCB(),this._pickRenderRequested=!1,this._pickRenderBuff=null,this._pickRenderCB=null,n.bindFramebuffer(n.FRAMEBUFFER,null),this.render()):void 0}},e.getNextId=function(){return e._nextID++},e.addActor=function(t,n){var r;return param.required(t),n=param.optional(n,t.layer),t.layer!==n&&(t.layer=n),r=_.sortedIndex(e.actors,t,"layer"),e.actors.splice(r,0,t),t},e.removeActor=function(t){var n,r,i,s,o;for(param.required(t),t instanceof AWGLActor&&(t=t.getId()),o=e.actors,r=i=0,s=o.length;s>i;r=++i)if(n=o[r],n.getId()===t)return e.actors.splice(r,1),!0;return!1},e.prototype.switchMaterial=function(t){var n,r,i;if(param.required(t),i=makeOrtho(0,this._width,0,this._height,-10,10).flatten(),n=e._gl,t!==e._currentMaterial){if("flat"===t)return n.useProgram(this._defaultShader.getProgram()),r=this._defaultShader.getHandles(),n.uniformMatrix4fv(r.Projection,!1,i),n.enableVertexAttribArray(r.Position),n.enableVertexAttribArray(r.Color),e._currentMaterial="flat";if("texture"===t)return n.useProgram(this._texShader.getProgram()),r=this._texShader.getHandles(),n.uniformMatrix4fv(r.Projection,!1,i),n.enableVertexAttribArray(r.Position),n.enableVertexAttribArray(r.aTexCoord),e._currentMaterial="texture";throw new Error("Unknown material "+t)}},e.hasTexture=function(t){var n,r,i,s;for(s=e.textures,r=0,i=s.length;i>r;r++)if(n=s[r],n.name===t)return!0;return!1},e.getTexture=function(t){var n,r,i,s;for(s=e.textures,r=0,i=s.length;i>r;r++)if(n=s[r],n.name===t)return n.texture;return null},e.addTexture=function(t){return param.required(t.name),param.required(t.texture),e.textures.push(t)},e}(),AWGLPhysics=function(){function e(){throw new Error("Physics constructor called")}return e.velIterations=6,e.posIterations=2,e.frameTime=1/60,e._gravity=new cp.v(0,-1),e._stepIntervalId=null,e._world=null,e._densityRatio=1e-4,e.bodyCount=0,e.startStepping=function(){var e;if(null===this._stepIntervalId)return this._world=new cp.Space,this._world.gravity=this._gravity,this._world.iterations=60,this._world.collisionSlop=.5,this._world.sleepTimeThreshold=.5,e=this,AWGLLog.info("Starting world update loop"),this._stepIntervalId=setInterval(function(){return e._world.step(e.frameTime)},this.frameTime)},e.stopStepping=function(){return null!==this._stepIntervalId?(AWGLLog.info("Halting world update loop"),clearInterval(this._stepIntervalId),this._stepIntervalId=null,this._world=null):void 0},e.getWorld=function(){return this._world},e.getDensityRatio=function(){return this._densityRatio},e.getGravity=function(){return this._gravity},e.setGravity=function(e){if(!(e instanceof cp.Vect))throw new Error("You need to set space gravity using cp.v!");return this._gravity=e,null!==this._world&&void 0!==this._world?this._world.gravity=e:void 0},e}(),AWGLLog=function(){function e(){}return e.tags=["","[Error]> ","[Warning]> ","[Debug]> ","[Info]> "],e.level=4,e.w=function(t,n){var r;return r=e,t>r.level||0===t||0===r.level?void 0:1===t&&void 0!==console.error?(console.error(""+r.tags[t]+n),void 0):2===t&&void 0!==console.warn?(console.warn(""+r.tags[t]+n),void 0):3===t&&void 0!==console.debug?(console.debug(""+r.tags[t]+n),void 0):4===t&&void 0!==console.info?(console.info(""+r.tags[t]+n),void 0):(t>4&&void 0!==r.tags[t]?console.log(""+r.tags[t]+n):console.log(n),void 0)},e.error=function(e){return this.w(1,e)},e.warn=function(e){return this.w(2,e)},e.debug=function(e){return this.w(3,e)},e.info=function(e){return this.w(4,e)},e}(),AWGLAjax=function(){function e(){this.busy=!1,this.queue=[]}return e.prototype.r=function(e,t){var n;if(param.required(e),n=this,this.busy)return this.queue.push({url:e,cb:t}),!1;if(0===this.queue.length)return this.busy=!0,this._callMjax(e,t),!0;throw new Error("[AWGLAjax] Queue length non-zero and busy flag not set!")},e.prototype._callMjax=function(e,t){var n;return n=this,window.microAjax(e,function(e){var r;return n.queue.length>0?(r=n.queue.pop(),n._callMjax(r.url,r.cb)):n.busy=!1,"function"==typeof t?t(e):void 0})},e}(),AWGLBezAnimation=function(){function e(e,t,n){this.actor=e,n=param.optional(n,!1),this.options=param.required(t),this._duration=param.required(t.duration),param.required(t.endVal),this._property=param.required(t.property),t.controlPoints=param.optional(t.controlPoints,[]),this._fps=param.optional(t.fps,30),n?(param.optional(this.actor),param.required(t.startVal)):param.required(this.actor),this._animated=!1,this.bezOpt={},t.controlPoints.length>0?(this.bezOpt.degree=t.controlPoints.length,this.bezOpt.degree>0&&(param.required(t.controlPoints[0].x),param.required(t.controlPoints[0].y),2===this.bezOpt.degree&&(param.required(t.controlPoints[1].x),param.required(t.controlPoints[1].y))),this.bezOpt.ctrl=t.controlPoints):this.bezOpt.degree=0,this.bezOpt.endPos=param.required(t.endVal),this.tIncr=1/(this._duration*(this._fps/1e3)),n?this.bezOpt.startPos=t.startVal:("rotation"===this._property&&(this.bezOpt.startPos=this.actor.getRotation()),"position"===this._property[0]&&("x"===this._property[1]?this.bezOpt.startPos=this.actor.getPosition().x:"y"===this._property[1]&&(this.bezOpt.startPos=this.actor.getPosition().y)),"color"===this._property[0]&&("r"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getR():"g"===this._property[1]?this.bezOpt.startPos=this.actor.getColor().getG():"b"===this._property[1]&&(this.bezOpt.startPos=this.actor.getColor().getB())))}return e.prototype._update=function(e,t){var n,r,i,s,o,u;if(param.required(e),t=param.optional(t,!0),e>1||0>e)throw new Error("t out of bounds! "+e);if(0===this.bezOpt.degree)n=this.bezOpt.startPos+(this.bezOpt.endPos-this.bezOpt.startPos)*e;else if(1===this.bezOpt.degree)r=1-e,i=r*r,o=e*e,n=i*this.bezOpt.startPos+2*r*e*this.bezOpt.ctrl[0].y+o*this.bezOpt.endPos;else{if(2!==this.bezOpt.degree)throw new Error("Invalid degree, can't evaluate ("+this.bezOpt.degree+")");r=1-e,i=r*r,s=i*r,o=e*e,u=o*e,n=s*this.bezOpt.startPos+3*i*e*this.bezOpt.ctrl[0].y+3*r*o*this.bezOpt.ctrl[1].y+u*this.bezOpt.endPos}return t&&(this._applyValue(n),void 0!==this.options.cbStep&&this.options.cbStep(n)),n},e.prototype.preCalculate=function(){var e,t;for(t=0,e={stepTime:this._duration*this.tIncr},e.values=[];1>=t;){if(t+=this.tIncr,t>1&&t<1+this.tIncr)t=1;else if(t>1)break;e.values.push(this._update(t,!1))}return e},e.prototype._applyValue=function(e){var t,n,r,i;if("rotation"===this._property&&this.actor.setRotation(e),"position"===this._property[0]&&("x"===this._property[1]?(t=new cp.v(e,this.actor.getPosition().y),this.actor.setPosition(t)):"y"===this._property[1]&&(t=new cp.v(this.actor.getPosition().x,e),this.actor.setPosition(t))),"color"===this._property[0]){if("r"===this._property[1])return i=e,r=this.actor.getColor().getG(),n=this.actor.getColor().getB(),this.actor.setColor(i,r,n);if("g"===this._property[1])return i=this.actor.getColor().getR(),r=e,n=this.actor.getColor().getB(),this.actor.setColor(i,r,n);if("b"===this._property[1])return i=this.actor.getColor().getR(),r=this.actor.getColor().getG(),n=e,this.actor.setColor(i,r,n)}},e.prototype.animate=function(){var e,t=this;if(!this._animated)return this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),e=-this.tIncr,this._intervalID=setInterval(function(){if(e+=t.tIncr,e>1){if(clearInterval(t._intervalID),void 0!==t.options.cbEnd)return t.options.cbEnd()}else if(t._update(e),void 0!==t.options.cbStep)return t.options.cbStep()},1e3/this._fps)},e}(),AWGLVertAnimation=function(){function e(e,t){return this.actor=e,this.options=t,param.required(this.actor),param.required(this.options),param.required(this.options.delays),param.required(this.options.deltas),this.options.delays.length!==this.options.deltas.length?(AWGLLog.warn("Vert animation delay count != delta set count! Bailing."),this._animated=!0,void 0):(this._animated=!1,void 0)}return e.prototype._setTimeout=function(e,t,n,r){var i=this;return param.required(e),param.required(t),n=param.optional(n,null),setTimeout(function(){return i._applyDeltas(e,n),r&&void 0!==i.options.cbEnd?i.options.cbEnd():void 0},t)},e.prototype._applyDeltas=function(e,t){var n,r,i,s,o,u,a;for(param.required(e),void 0!==this.options.cbStep&&this.options.cbStep(t),r=this.actor.getVertices(),s=-1!==e.join("_").indexOf("...")?!0:!1,i=u=0,a=e.length;a>=0?a>u:u>a;i=a>=0?++u:--u){if(n=e[i],i>=r.length){if(s)break;o=void 0}else o=r[i];if("number"==typeof n)o=n;else{if("string"!=typeof n)return AWGLLog.warn("Unknown delta type, can't apply deltas! "+n+" "+typeof n),void 0;if(void 0===o)return AWGLLog.warn("Vertex does not exist, yet delta is relative!"),void 0;if("|"===n.charAt(0))break;if("-"===n.charAt(0))o-=Number(n.slice(1));else if("+"===n.charAt(0))o+=Number(n.slice(1));else if("..."===n)i=0;else if("."!==n.charAt(0))return AWGLLog.warn("Unknown delta action, "+n+", can't apply deltas."),void 0}if(i>r.length)return AWGLLog.warn("Vertex gap, can't push new vert! "+o+":"+n+":"+i),void 0;i===r.length?r.push(o):r[i]=o}return this.actor.updateVertices(r)},e.prototype.animate=function(){var e,t,n,r,i,s;if(!this._animated){for(this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),s=[],e=r=0,i=this.options.deltas.length;i>=0?i>r:r>i;e=i>=0?++r:--r)n=null,void 0!==this.options.udata&&(this.options.udata instanceof Array?e<this.options.udata.length&&(n=this.options.udata[e]):n=this.options.udata),t=e===this.options.deltas.length-1?!0:!1,s.push(this._setTimeout(this.options.deltas[e],this.options.delays[e],n,t));return s}},e}(),AWGLPsyxAnimation=function(){function e(e,t){this.actor=e,this.options=t,param.required(this.actor),param.required(this.options.mass),param.required(this.options.friction),param.required(this.options.elasticity),param.required(this.options.timeout),this._animated=!1}return e.prototype.animate=function(){var e=this;if(!this._animated)return this._animated=!0,void 0!==this.options.cbStart&&this.options.cbStart(),setTimeout(function(){return e.actor.createPhysicsBody(e.options.mass,e.options.friction,e.options.elasticity),void 0!==e.options.cbEnd?e.options.cbEnd():void 0},this.options.timeout)},e}(),AWGLActorInterface=function(){function e(){}return e.prototype._findActor=function(e){var t,n,r,i;for(param.required(e),i=AWGLRenderer.actors,n=0,r=i.length;r>n;n++)if(t=i[n],t.getId()===e)return t;return null},e.prototype.createActor=function(e,t){var n;return param.required(e),void 0!==t&&(t=JSON.parse(t)),e=JSON.parse(e),n=new AWGLActor(e,t),n.getId()},e.prototype.attachTexture=function(e,t,n,r,i,s,o){var u;return param.required(o),param.required(e),param.required(t),param.required(n),r=param.optional(r,0),i=param.optional(i,0),s=param.optional(s,0),null!==(u=this._findActor(o))?(u.attachTexture(e,t,n,r,i,s),!0):!1},e.prototype.setActorLayer=function(e,t){var n;return param.required(t),param.required(e),null!==(n=this._findActor(t))?(n.setLayer(e),!0):!1},e.prototype.setActorPhysicsLayer=function(e,t){var n;return param.required(t),param.required(e),null!==(n=this._findActor(t))?(n.setPhysicsLayer(e),!0):!1},e.prototype.removeAttachment=function(e){var t;return param.required(e),null!==(t=this._findActor(e))?(t.removeAttachment(),!0):!1},e.prototype.setAttachmentVisiblity=function(e,t){var n;return param.required(e),null!==(n=this._findActor(t))?n.setAttachmentVisibility(e):!1},e.prototype.updateVertices=function(e,t){var n;return param.required(e),param.required(t),null!==(n=this._findActor(t))?(n.updateVertices(JSON.parse(e)),!0):!1},e.prototype.getVertices=function(e){var t;return param.required(e),null!==(t=this._findActor(e))?JSON.stringify(t.getVertices()):null},e.prototype.destroyActor=function(e){var t,n,r,i,s;for(param.required(e),s=AWGLRenderer.actors,n=r=0,i=s.length;i>r;n=++r)if(t=s[n],t.getId()===e)return t.destroyPhysicsBody(),AWGLRenderer.actors.splice(n,1),t=void 0,!0;return!1},e.prototype.setPhysicsVertices=function(e,t){var n;return param.required(e),param.required(t),null!==(n=this._findActor(t))?(n.setPhysicsVertices(JSON.parse(e)),!0):!1},e.prototype.setRenderMode=function(e,t){var n;return e=param.required(e,[1,2]),param.required(t),null!==(n=this._findActor(t))?(n.setRenderMode(e),!0):!1},e.prototype.setActorPosition=function(e,t,n){var r;return param.required(e),param.required(t),param.required(n),null!==(r=this._findActor(n))?(r.setPosition(new cp.v(e,t)),!0):!1},e.prototype.getActorPosition=function(e){var t,n;return param.required(e),null!==(t=this._findActor(e))?(n=t.getPosition(),JSON.stringify({x:n.x,y:n.y})):null},e.prototype.setActorRotation=function(e,t,n){var r;return param.required(e),param.required(t),n=param.optional(n,!1),null!==(r=this._findActor(t))?(r.setRotation(e,n),!0):!1},e.prototype.getActorRotation=function(e,t){var n;return param.required(e),t=param.optional(t,!1),null!==(n=this._findActor(e))?n.getRotation(t):1e-6},e.prototype.setActorColor=function(e,t,n,r){var i;return param.required(e),param.required(t),param.required(n),param.required(r),null!==(i=this._findActor(r))?(i.setColor(new AWGLColor3(e,t,n)),!0):!1},e.prototype.setTexture=function(e,t){var n;return param.required(e),null!==(n=this._findActor(t))?(n.setTexture(e),!0):void 0},e.prototype.getActorColor=function(e){var t;return param.required(e),null!==(t=this._findActor(e))?JSON.stringify({r:t.getColor().getR(),g:t.getColor().getG(),b:t.getColor().getB()}):null},e.prototype.enableActorPhysics=function(e,t,n,r){var i;return param.required(r),param.required(e),param.required(t),param.required(n),null!==(i=this._findActor(r))?(i.createPhysicsBody(e,t,n),!0):!1},e.prototype.destroyPhysicsBody=function(e){var t;return param.required(e),null!==(t=this._findActor(e))&&t.destroyPhysicsBody(),!1},e.prototype.setActorTexture=function(e,t){var n;return param.required(e),param.required(t),null!==(n=this._findActor(t))&&n.setTexture(e),!1},e}(),AWGLEngineInterface=function(){function e(){}return e.prototype.initialize=function(e,t,n,r,i){var s;return param.required(e),param.required(t),param.required(n),r=param.optional(r,4),param.optional(i),void 0!==this._engine?(AWGLLog.warn("Engine already initialized, bailing"),void 0):(window.ajax=microAjax,s=this,new AWGLEngine(null,r,function(t){return s._engine=t,t.startRendering(),e(t)},i,t,n))},e.prototype.setClearColor=function(e,t,n){return param.required(e),param.required(t),param.required(n),void 0!==this._engine?AWGLRenderer.me.setClearColor(e,t,n):void 0},e.prototype.getClearColor=function(){var e;return void 0===this._engine?null:(e=AWGLRenderer.me.getClearColor(),JSON.stringify({r:e.getR(),g:e.getG(),b:e.getB()}))},e.prototype.setLogLevel=function(e){return param.required(e,[0,1,2,3,4]),AWGLLog.level=e},e.prototype.setCameraPosition=function(e,t){return AWGLRenderer.camPos.x=param.optional(e,AWGLRenderer.camPos.x),AWGLRenderer.camPos.y=param.optional(t,AWGLRenderer.camPos.y)},e.prototype.getCameraPosition=function(){return JSON.stringify(AWGLRenderer.camPos)},e.prototype.loadManifest=function(e,t){var n,r,i,s,o,u,a,f,l;if(param.required(e),s=JSON.parse(e),r=AWGLRenderer._gl,n=0,i=function(e,i){var o,u;return u=r.createTexture(),o=new Image,o.onload=function(){return r.bindTexture(r.TEXTURE_2D,u),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST),r.generateMipmap(r.TEXTURE_2D),r.bindTexture(r.TEXTURE_2D,null),AWGLRenderer.addTexture({name:e,texture:u}),n++,n===s.textures.length?t():void 0},o.src=i},void 0===s.textures||0===s.textures.length)return t(),void 0;for(f=s.textures,l=[],u=0,a=f.length;a>u;u++){if(o=f[u],void 0!==o.compression&&"none"!==o.compression)throw new Error("Only un-compressed textures are supported!");if("image"!==o.type)throw new Error("Only image textures are supported!");l.push(i(o.name,o.path))}return l},e}(),AWGLAnimationInterface=function(){function e(){}return e._animationMap={position:AWGLBezAnimation,color:AWGLBezAnimation,rotation:AWGLBezAnimation,mass:AWGLPsyxAnimation,friction:AWGLPsyxAnimation,elasticity:AWGLPsyxAnimation,physics:AWGLPsyxAnimation,vertices:AWGLVertAnimation},e.prototype.canAnimate=function(t){return void 0===e._animationMap[t]?!1:!0},e.prototype.getAnimationName=function(t){var n;return void 0===e._animationMap[t]?!1:(n=e._animationMap[t],n===AWGLBezAnimation?"bezier":n===AWGLPsyxAnimation?"psyx":n===AWGLVertAnimation?"vert":void 0)},e.prototype.animate=function(t,n,r){var i,s,o,u,f,l,c;for(param.required(t),n=JSON.parse(param.required(n)),r=JSON.parse(param.required(r)),r.start=param.optional(r.start,0),s=null,l=AWGLRenderer.actors,u=0,f=l.length;f>u;u++)if(i=l[u],i.getId()===t){s=i;break}if(null===s)throw new Error("Actor not found, can't animate! "+actorId);return o=n[0],void 0===r.property&&(r.property=n),c=function(t,n,r){return e._animationMap[t]===AWGLBezAnimation?(new AWGLBezAnimation(n,r)).animate():e._animationMap[t]===AWGLPsyxAnimation?(new AWGLPsyxAnimation(n,r)).animate():e._animationMap[t]===AWGLVertAnimation?(new AWGLVertAnimation(n,r)).animate():AWGLLog.warn("Unrecognized property: "+t)},r.start>0?setTimeout(function(){return c(o,s,r)},r.start):c(o,s,r)},e.prototype.preCalculateBez=function(e){var t;return e=JSON.parse(param.required(e)),param.required(e.startVal),param.required(e.endVal),param.required(e.duration),e.controlPoints=param.required(e.controlPoints,[]),e.fps=param.required(e.fps,30),t=(new AWGLBezAnimation(null,e,!0)).preCalculate(),JSON.stringify(t)},e}(),AWGLInterface=function(){function e(){this._Actors=new AWGLActorInterface,this._Engine=new AWGLEngineInterface,this._Animations=new AWGLAnimationInterface}return e.prototype.Actors=function(){return this._Actors},e.prototype.Engine=function(){return this._Engine},e.prototype.Animations=function(){return this._Animations},e}(),AWGLEngine=function(){function e(e,t,n,r,i,s){var o;return this.url=e,null===this.url&&(this.url=void 0),this.url=param.optional(this.url,""),t=param.optional(t,4),r=param.optional(r,""),this["package"]=null,this.ajax=null,this._renderer=null,this._renderIntervalId=null,this._framerate=1/60,this.initError=void 0,AWGLLog.level=t,null===window.ajax||void 0===window.ajax?(AWGLLog.error("Ajax library is not present!"),this.initSuccess="Ajax library is not present!",void 0):null===window._||void 0===window._?(AWGLLog.error("Underscore.js is not present!"),this.initSuccess="Underscore.js is not present!",void 0):void 0===window.cp||null===window.cp?(AWGLLog.error("Chipmunk-js is not present!"),this.initSuccess="Chipmunk-js is not present!",void 0):(this.url.length>0?(this.ajax=new AWGLAjax,o=this,this.ajax.r(""+this.url+"/package.json",function(e){var t;return AWGLLog.info("...fetched package.json"),o["package"]=JSON.parse(e),(t=o.verifyPackage(o["package"],function(){return AWGLLog.info("...downloaded. Creating Renderer"),o._renderer=new AWGLRenderer(r,i,s),o.startRendering(),AWGLPhysics.startStepping(),null!==n&&void 0!==n?n(this):void 0}))?AWGLLog.info("package.json valid, downloading assets..."):(AWGLLog.error("Invalid package.json"),this.initSuccess="Invalid package.json",void 0)}),AWGLLog.info("Engine initialized, awaiting package.json...")):void 0!==n?(this._renderer=new AWGLRenderer(r,i,s),AWGLLog.info("Engine initialized, executing cb"),n(this)):AWGLLog.error("Engine can't initialize, no url or cb was passed in!"),void 0)}return e.prototype.verifyPackage=function(e,t){var n,r,i,s,o,u,a,f;u={company:"",apikey:"",load:"",scenes:{}};for(n in u)if(void 0===e[n])return AWGLLog.error("package.json invalid, missing key "+n),!1;if(0===e.scenes.length)return AWGLLog.warning(".json does not specify any scenes, can't continue"),!1;i={load:null,scenes:{}},o=1+_.size(e.scenes),r=this,f=function(e,n){return"load"===e?i.load=n:i.scenes[e]=n,o--,0===o?t(i):void 0},a=function(e,t){return r.ajax.r(""+r.url+t,function(t){return f(e,t)})},this.ajax.r(""+this.url+e.load,function(e){return f("load",e)});for(s in e.scenes)a(s,e.scenes[s]);return!0},e.prototype.setFPS=function(e){return this._framerate=1/e},e.prototype.startRendering=function(){var e;if(null===this._renderIntervalId)return e=this,AWGLLog.info("Starting render loop"),this._renderIntervalId=setInterval(function(){return e._renderer.render()},this._framerate)},e.prototype.stopRendering=function(){return null!==this._renderIntervalId?(AWGLLog.info("Halting render loop"),clearInterval(this._renderIntervalId),this._renderIntervalId=null):void 0},e.prototype.setClearColor=function(e,t,n){return e=param.optional(e,0),t=param.optional(t,0),n=param.optional(n,0),this._renderer instanceof AWGLRenderer?this._renderer.setClearColor(e,t,n):void 0},e.prototype.getClearColor=function(){return this._renderer instanceof AWGLRenderer?this._renderer.getClearColor():null},e.prototype.getWidth=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getWidth()},e.prototype.getHeight=function(){return null===this._renderer||void 0===this._renderer?-1:this._renderer.getHeight()},e.prototype.requestPickingRender=function(e,t){return null===this._renderer||void 0===this._renderer?AWGLLog.warn("Can't request a pick render, renderer not instantiated!"):this._renderer.requestPickingRender(e,t)},e.prototype.getGL=function(){return null===AWGLRenderer._gl?(AWGLLog.warn("No gl object to get, render not instantiated!"),null):AWGLRenderer._gl},e}(),window.AdefyGLI=new AWGLInterface;var AJS,AJSBaseActor,AJSColor3,AJSPolygon,AJSRectangle,AJSTriangle,AJSUtilParam,AJSVector2,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t){if(__hasProp.call(t,n))e[n]=t[n]}r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e};AJSUtilParam=function(){function e(){}e.required=function(e,t){var n,r,i,s;if(e===void 0){throw new Error("Required argument missing!")}if(t instanceof Array){n=false;for(i=0,s=t.length;i<s;i++){r=t[i];if(e===r){n=true;break}}if(!n){throw new error("Required argument is not of a valid value!")}}return e};e.optional=function(e,t,n){var r,i,s,o;if(e===void 0){e=t}if(n instanceof Array){r=false;for(s=0,o=n.length;s<o;s++){i=n[s];if(e===i){r=true;break}}if(!r){throw new error("Required argument is not of a valid value!")}}return e};return e}();if(window.param===void 0){window.param=AJSUtilParam}AJSVector2=function(){function e(e,t){this.x=e||0;this.y=t||0}e.prototype.negative=function(){return new e(-this.x,-this.y)};e.prototype.add=function(t){if(t instanceof e){return new e(this.x+t.x,this.y+t.y)}else{return new e(this.x+t,this.y+t)}};e.prototype.subtract=function(t){if(t instanceof e){return new e(this.x-t.x,this.y-t.y)}else{return new e(this.x-t,this.y-t)}};e.prototype.multiply=function(t){if(t instanceof e){return new e(this.x*t.x,this.y*t.y)}else{return new e(this.x*t,this.y*t)}};e.prototype.divide=function(t){if(t instanceof e){return new e(this.x/t.x,this.y/t.y)}else{return new e(this.x/t,this.y/t)}};e.prototype.equals=function(e){return this.x===e.x&&this.y===e.y};e.prototype.dot=function(e){return this.x*e.x+this.y*e.y};e.prototype.cross=function(e){return this.x*e.y-this.y*e.x};e.prototype.ortho=function(){return new e(this.y,-this.x)};e.prototype.length=function(){return Math.sqrt(this.dot(this))};e.prototype.normalize=function(){return this.divide(this.length())};e.prototype.toString=function(){return"("+this.x+", "+this.y+")"};return e}();AJSBaseActor=function(){function e(e,t,n,r){var i;this._verts=e;param.required(this._verts);this._m=param.optional(t,0);this._f=param.optional(n,.2);this._e=param.optional(r,.3);if(t<0){t=0}if(this._verts.length<6){throw"At least three vertices must be provided"}this._psyx=false;if(this._texverts===void 0){i=void 0}else{i=JSON.stringify(this._texverts)}this._id=window.AdefyGLI.Actors().createActor(JSON.stringify(this._verts),i);if(this._id===-1){throw"Failed to create actor!"}this.setPosition(new AJSVector2);this.setRotation(0);this.setColor(new AJSColor3(255,255,255))}e.prototype.destroy=function(){return window.AdefyGLI.Actors().destroyActor(this._id)};e.prototype.setLayer=function(e){window.AdefyGLI.Actors().setActorLayer(param.required(e),this._id);return this};e.prototype.setPhysicsLayer=function(e){window.AdefyGLI.Actors().setActorPhysicsLayer(param.required(e),this._id);return this};e.prototype._setPhysicsVertices=function(e){param.required(e);return window.AdefyGLI.Actors().setPhysicsVertices(JSON.stringify(e),this._id)};e.prototype._setRenderMode=function(e){return window.AdefyGLI.Actors().setRenderMode(param.required(e,[1,2]),this._id)};e.prototype._updateVertices=function(){return window.AdefyGLI.Actors().updateVertices(JSON.stringify(this._verts),this._id)};e.prototype._fetchVertices=function(){return this._verts=JSON.parse(window.AdefyGLI.Actors().getVertices(this._id))};e.prototype.getId=function(){return this._id};e.prototype.setPosition=function(e){this._position=e;window.AdefyGLI.Actors().setActorPosition(e.x,e.y,this._id);return this};e.prototype.setRotation=function(e,t){if(t!==true){t=false}this._rotation=e;window.AdefyGLI.Actors().setActorRotation(e,this._id,t);return this};e.prototype.getPosition=function(){var e;e=JSON.parse(window.AdefyGLI.Actors().getActorPosition(this._id));return new AJSVector2(e.x,e.y)};e.prototype.getRotation=function(e){if(e!==true){e=false}return window.AdefyGLI.Actors().getActorRotation(this._id,e)};e.prototype.setColor=function(e){window.AdefyGLI.Actors().setActorColor(e._r,e._g,e._b,this._id);return this};e.prototype.setTexture=function(e){window.AdefyGLI.Actors().setTexture(e,this._id);return this};e.prototype.getColor=function(){var e;e=JSON.parse(window.AdefyGLI.Actors().getActorColor(this._id));return new AJSColor3(e.r,e.g,e.b)};e.prototype.hasPsyx=function(){return this._psyx};e.prototype.enablePsyx=function(e,t,n){this._m=param.optional(e,this._m);this._f=param.optional(t,this._f);this._e=param.optional(n,this._e);this._psyx=window.AdefyGLI.Actors().enableActorPhysics(this._m,this._f,this._e,this._id);return this};e.prototype.disablePsyx=function(){if(window.AdefyGLI.Actors().destroyPhysicsBody(this._id)){this._psyx=false}return this};e.prototype.attachTexture=function(e,t,n,r,i,s){param.required(e);param.required(t);param.required(n);r=param.optional(r,0);i=param.optional(i,0);s=param.optional(s,0);return window.AdefyGLI.Actors().attachTexture(e,t,n,r,i,s,this._id)};e.prototype.removeAttachment=function(){return window.AdefyGLI.Actors().removeAttachment(this._id)};e.prototype.setAttachmentVisible=function(e){param.required(e);return window.AdefyGLI.Actors().setAttachmentVisible(e,this._id)};e.prototype.mapAnimation=function(e,t){return null};e.prototype.canMapAnimation=function(e){return false};e.prototype.absoluteMapping=function(e){return false};e.prototype.rotate=function(e,t,n,r){param.required(e);if(t===void 0){this.setRotation(e);return this}else{if(n===void 0){n=0}if(r===void 0){r=[]}AJS.animate(this,[["rotation"]],[{endVal:e,controlPoints:r,duration:t,property:"rotation",start:n}]);return this}};e.prototype.move=function(e,t,n,r,i){if(n===void 0){if(e===null||e===void 0){e=this.getPosition().x}if(t===null||t===void 0){t=this.getPosition().y}this.setPosition({x:e,y:t});return this}else{if(r===void 0){r=0}if(i===void 0){i=[]}if(e!==null){AJS.animate(this,[["position","x"]],[{endVal:e,controlPoints:i,duration:n,start:r}])}if(t!==null){AJS.animate(this,[["position","y"]],[{endVal:t,controlPoints:i,duration:n,start:r}])}return this}};e.prototype.colorTo=function(e,t,n,r,i,s){if(r===void 0){if(e===null||e===void 0){e=this.getColor().r}if(t===null||t===void 0){t=this.getColor().g}if(n===null||n===void 0){n=this.getColor().b}this.setColor({_r:e,_g:t,_b:n});return this}else{if(i===void 0){i=0}if(s===void 0){s=[]}if(e!==null){AJS.animate(this,[["color","r"]],[{endVal:e,controlPoints:s,duration:r,start:i}])}if(t!==null){AJS.animate(this,[["color","g"]],[{endVal:t,controlPoints:s,duration:r,start:i}])}if(n!==null){AJS.animate(this,[["color","b"]],[{endVal:n,controlPoints:s,duration:r,start:i}])}return this}};return e}();AJSColor3=function(){function e(e,t,n){this._r=param.optional(e,0);this._g=param.optional(t,0);this._b=param.optional(n,0)}e.prototype.getR=function(e){if(e!==true){return this._r}if(this._r===0){if(e){return 0}else{return 0}}return this._r/255};e.prototype.getG=function(e){if(e!==true){return this._g}if(this._g===0){if(e){return 0}else{return 0}}return this._g/255};e.prototype.getB=function(e){if(e!==true){return this._b}if(this._b===0){if(e){return 0}else{return 0}}return this._b/255};e.prototype.setR=function(e){if(e<0){e=0}if(e>255){e=255}return this._r=e};e.prototype.setG=function(e){if(e<0){e=0}if(e>255){e=255}return this._g=e};e.prototype.setB=function(e){if(e<0){e=0}if(e>255){e=255}return this._b=e};e.prototype.toString=function(){return"("+this._r+", "+this._g+", "+this._b+")"};return e}();AJSRectangle=function(e){function t(e){e=param.required(e);this._w=param.required(e.w);this._h=param.required(e.h);if(this._w<=0){throw"Width must be greater than 0"}if(this._h<=0){throw"Height must be greater than 0"}this._texverts=[0,0,1,0,1,1,0,1,0,0];this._rebuildVerts();t.__super__.constructor.call(this,this._verts,e.mass,e.friction,e.elasticity);if(e.color instanceof AJSColor3){this.setColor(e.color)}else if(e.color!==void 0&&e.color.r!==void 0){this.setColor(new AJSColor3(e.color.r,e.color.g,e.color.b))}if(e.position instanceof AJSVector2){this.setPosition(e.position)}else if(e.position!==void 0&&e.position.x!==void 0){this.setPosition(new AJSVector2(e.position.x,e.position.y))}if(typeof e.rotation==="number"){this.setRotation(e.rotation)}if(e.psyx){this.enablePsyx()}}__extends(t,e);t.prototype.getWidth=function(){this._fetchVertices();return this._w=this._verts[4]*2};t.prototype.getHeight=function(){this._fetchVertices();return this._h=this._verts[3]*2};t.prototype._rebuildVerts=function(){var e,t;t=this._w/2;e=this._h/2;this._verts=[];this._verts.push(-t);this._verts.push(-e);this._verts.push(-t);this._verts.push(e);this._verts.push(t);this._verts.push(e);this._verts.push(t);this._verts.push(-e);this._verts.push(-t);return this._verts.push(-e)};t.prototype.setHeight=function(e){param.required(e);if(e<=0){throw new Error("New height must be >0 !")}this._h=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.setWidth=function(e){param.required(e);if(e<=0){throw new Error("New width must be >0 !")}this._w=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.mapAnimation=function(e,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m=this;param.required(e);param.required(n);i={};u=function(e){if(e===0){e="."}else if(e>=0){e="+"+e}else{e=""+e}return e};if(e[0]==="width"){n.startVal/=2;n.endVal/=2;r=JSON.stringify(n);s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];a=Number(s.values[0]);d=s.values;for(l=0,h=d.length;l<h;l++){f=d[l];f=Number(f);f-=a;a+=f;o+=Number(s.stepTime);if(f!==0){n.deltas.push([u(-f),".",u(-f),".",u(f),".",u(f),".",u(-f),"."]);n.udata.push(f*2);n.delays.push(o)}}n.cbStep=function(e){return m._w+=e*2};i.property=["vertices"];i.options=n}else if(e[0]==="height"){n.startVal/=2;n.endVal/=2;r=JSON.stringify(n);s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];a=Number(s.values[0]);v=s.values;for(c=0,p=v.length;c<p;c++){f=v[c];f=Number(f);f-=a;a+=f;o+=Number(s.stepTime);if(f!==0){n.deltas.push([".",u(-f),".",u(f),".",u(f),".",u(-f),".",u(-f)]);n.udata.push(f);n.delays.push(o)}}n.cbStep=function(e){return m._h+=e*2};i.property=["vertices"];i.options=n}else{return t.__super__.mapAnimation.call(this,e,n)}return i};t.prototype.canMapAnimation=function(e){if(e[0]==="height"||e[0]==="width"){return true}else{return false}};t.prototype.absoluteMapping=function(e){return false};t.prototype.setTexture=function(e){param.required(e);window.AdefyGLI.Actors().setActorTexture(e,this._id);return this};t.prototype.resize=function(e,t,n,r,i,s,o){var u,a;e=param.optional(e,null);t=param.optional(t,null);if(i===void 0){if(e!==null){this.setWidth(e)}if(t!==null){this.setHeight(t)}return this}else{if(s===void 0){s=0}if(o===void 0){o=[]}a=[];u=[];if(e!==null){param.required(n);a.push(["width"]);u.push({endVal:e,startVal:n,controlPoints:o,duration:i,start:s,property:"width"})}if(t!==null){param.required(r);a.push(["height"]);u.push({endVal:t,startVal:r,controlPoints:o,duration:i,start:s,property:"height"})}if(a.length>0){AJS.animate(this,a,u)}return this}};return t}(AJSBaseActor);AJSTriangle=function(e){function t(e){e=param.required(e);this._base=param.required(e.base);this._height=param.required(e.height);if(this._base<=0){throw"Base must be wider than 0"}if(this._height<=0){throw"Height must be greater than 0"}this._rebuildVerts();t.__super__.constructor.call(this,this._verts,e.mass,e.friction,e.elasticity);if(e.color instanceof AJSColor3){this.setColor(e.color)}else if(e.color!==void 0&&e.color.r!==void 0){this.setColor(new AJSColor3(e.color.r,e.color.g,e.color.b))}if(e.position instanceof AJSVector2){this.setPosition(e.position)}else if(e.position!==void 0&&e.position.x!==void 0){this.setPosition(new AJSVector2(e.position.x,e.position.y))}if(typeof e.rotation==="number"){this.setRotation(e.rotation)}if(e.psyx){this.enablePsyx()}}__extends(t,e);t.prototype.getBase=function(){this._fetchVertices();return this._base=this._verts[4]*2};t.prototype.getHeight=function(){this._fetchVertices();return this._height=this._verts[3]*2};t.prototype._rebuildVerts=function(){var e,t;e=this._base/2;t=this._height/2;this._verts=[8];this._verts[0]=-e;this._verts[1]=-t;this._verts[2]=0;this._verts[3]=t;this._verts[4]=e;this._verts[5]=-t;this._verts[6]=-e;return this._verts[7]=-t};t.prototype.setHeight=function(e){param.required(e);if(e<=0){throw new Error("New height must be >0 !")}this._height=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.setBase=function(e){param.required(e);if(e<=0){throw new Error("New base must be >0 !")}this._base=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.mapAnimation=function(e,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m=this;param.required(e);param.required(n);i={};u=function(e){if(e===0){e="."}else if(e>=0){e="+"+e}else{e=""+e}return e};if(e[0]==="height"){n.startVal/=2;n.endVal/=2;r=JSON.stringify(n);s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];a=Number(s.values[0]);d=s.values;for(l=0,h=d.length;l<h;l++){f=d[l];f=Number(f);f-=a;a+=f;o+=Number(s.stepTime);if(f!==0){n.deltas.push([".",u(-f),".",u(f),".",u(-f),".",u(-f)]);n.udata.push(f);n.delays.push(o)}}n.cbStep=function(e){return m._height+=e*2};i.property=["vertices"];i.options=n}else if(e[0]==="base"){n.startVal/=2;n.endVal/=2;r=JSON.stringify(n);s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];a=Number(s.values[0]);v=s.values;for(c=0,p=v.length;c<p;c++){f=v[c];f=Number(f);f-=a;a+=f;o+=Number(s.stepTime);if(f!==0){n.deltas.push([u(-f),".",".",".",u(f),".",u(-f),"."]);n.udata.push(f);n.delays.push(o)}}n.cbStep=function(e){return m._base+=e*2};i.property=["vertices"];i.options=n}else{return t.__super__.mapAnimation.call(this,e,n)}return i};t.prototype.canMapAnimation=function(e){if(e[0]==="base"||e[0]==="height"){return true}else{return false}};t.prototype.absoluteMapping=function(e){return false};t.prototype.resize=function(e,t,n,r,i,s,o){var u,a;e=param.optional(e,null);t=param.optional(t,null);if(i===void 0){if(e!==null){this.setBase(e)}if(t!==null){this.setHeight(t)}return this}else{if(s===void 0){s=0}if(o===void 0){o=[]}a=[];u=[];if(e!==null){param.required(n);a.push(["base"]);u.push({endVal:e,startVal:n,controlPoints:o,duration:i,start:s,property:"base"})}if(t!==null){param.required(r);a.push(["height"]);u.push({endVal:t,startVal:r,controlPoints:o,duration:i,start:s,property:"height"})}if(a.length>0){AJS.animate(this,a,u)}return this}};return t}(AJSBaseActor);AJSPolygon=function(e){function t(e){param.required(e);this._radius=param.required(e.radius);this._segments=param.required(e.segments);e.psyx=param.optional(e.psyx,false);if(this._radius<=0){throw"Radius must be larger than 0"}if(this._segments<3){throw"Shape must consist of at least 3 segments"}this._rebuildVerts(true);t.__super__.constructor.call(this,this._verts,e.mass,e.friction,e.elasticity);if(e.color instanceof AJSColor3){this.setColor(e.color)}else if(e.color!==void 0&&e.color.r!==void 0){this.setColor(new AJSColor3(e.color.r,e.color.g,e.color.b))}if(e.position instanceof AJSVector2){this.setPosition(e.position)}else if(e.position!==void 0&&e.position.x!==void 0){this.setPosition(new AJSVector2(e.position.x,e.position.y))}if(typeof e.rotation==="number"){this.setRotation(e.rotation)}if(e.psyx){this.enablePsyx()}this._setPhysicsVertices(this._verts.slice(0,this._verts.length-2));this._setRenderMode(2)}__extends(t,e);t.prototype._rebuildVerts=function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;e=param.optional(e,false);t=param.optional(t,false);n=param.optional(n,this._segments);r=param.optional(r,this._radius);h=r;p=0;a=2*3.1415926/n;u=Math.tan(a);o=Math.cos(a);c=[];for(i=d=0;0<=n?d<n:d>n;i=0<=n?++d:--d){s=i*2;c[s]=h;c[s+1]=p;f=-p;l=h;h+=f*u;p+=l*u;h*=o;p*=o}c.push(c[0]);c.push(c[1]);g=[];for(i=v=0,m=c.length;v<m;i=v+=2){y=c[c.length-2-i];b=c[c.length-1-i];if(t){g.push("`"+y)}else{g.push(y)}if(t){g.push("`"+b)}else{g.push(b)}}c=g;if(!e&&!t){this._setPhysicsVertices(c)}if(t){c.push("`0")}else{c.push(0)}if(t){c.push("`0")}else{c.push(0)}if(t){return c}else{return this._verts=c}};t.prototype.setRadius=function(e){param.required(e);if(e<=0){throw new Error("New radius must be >0 !")}this._radius=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.setSegments=function(e){param.required(e);if(e<3){throw new Error("New segment count must be >=3 !")}this._segments=e;this._rebuildVerts();this._updateVertices();return this};t.prototype.getRadius=function(){return this._radius};t.prototype.getSegments=function(){return this._segments};t.prototype.mapAnimation=function(e,n){var r,i,s,o,u,a,f,l,c,h,p,d,v=this;param.required(e);param.required(n);i={};this._fetchVertices();u=function(e){if(e===0){e="."}else if(e>=0){e="+"+e}else{e=""+e}return e};r=JSON.stringify(n);if(e[0]==="radius"){s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];p=s.values;for(f=0,c=p.length;f<c;f++){a=p[f];a=Number(a);o+=Number(s.stepTime);if(a!==0){n.udata.push(a);n.deltas.push(this._rebuildVerts(true,true,this._segments,a));n.delays.push(o)}}n.cbStep=function(e){return v._radius=e};i.property=["vertices"];i.options=n}else if(e[0]==="sides"){s=window.AdefyGLI.Animations().preCalculateBez(r);s=JSON.parse(s);o=0;n.deltas=[];n.delays=[];n.udata=[];d=s.values;for(l=0,h=d.length;l<h;l++){a=d[l];a=Number(a);o+=Number(s.stepTime);if(a!==0){n.udata.push(a);n.deltas.push(this._rebuildVerts(true,true,a,this._radius));n.delays.push(o)}}n.cbStep=function(e){return v._segments=e};i.property=["vertices"];i.options=n}else{return t.__super__.mapAnimation.call(this,e,n)}return i};t.prototype.canMapAnimation=function(e){if(e[0]==="sides"||e[0]==="radius"){return true}else{return false}};t.prototype.absoluteMapping=function(e){return true};return t}(AJSBaseActor);AJS=function(){function e(){throw new Error("AJS shouldn't be instantiated!")}e._engine=null;e._initialized=false;e.init=function(t,n,r){param.required(t);param.required(n);param.required(r);if(e._initialized){throw new Error("AJS can only be initialized once");return}else{e._initialized=true}this._engine=window.AdefyGLI.Engine();return this._engine.initialize(function(e){return t(e)},n,r,1,"")};e.setCameraPosition=function(e,t){return window.AdefyGLI.Engine().setCameraPosition(e,t)};e.getCameraPosition=function(){return JSON.parse(window.AdefyGLI.Engine().getCameraPosition())};e.setClearColor=function(e,t,n){param.required(e);param.required(t);param.required(n);return window.AdefyGLI.Engine().setClearColor(e,t,n)};e.getClearColor=function(){var e;e=JSON.parse(window.AdefyGLI.Engine().getClearColor());return new AJSColor3(e.r,e.g,e.b)};e.setLogLevel=function(e){param.required(e,[0,1,2,3,4]);return window.AdefyGLI.Engine().setLogLevel(e)};e._syntheticMap={width:""};e.animate=function(t,n,r,i,s){var o,u,a,f,l,c,h,p;param.required(t);param.required(n);param.required(r);i=param.optional(i,0);s=param.optional(s,30);o=window.AdefyGLI.Animations();h=function(t,n,r,i){return setTimeout(function(){var i;i=e.mapAnimation(t,n,r);n=JSON.stringify(i.property);r=JSON.stringify(i.options);return o.animate(t.getId(),n,r)},i)};p=[];for(u=l=0,c=n.length;0<=c?l<c:l>c;u=0<=c?++l:--l){if(r[u].fps===void 0){r[u].fps=s}if(r[u].start===void 0){r[u].start=i}if(!o.canAnimate(n[u][0])){if(!t.canMapAnimation(n[u])){throw new Error("Unrecognized property! "+n[u])}if(t.absoluteMapping(n[u])){f=r[u].start;r[u].start=-1;p.push(h(t,n[u],r[u],f))}else{a=e.mapAnimation(t,n[u],r[u]);n[u]=JSON.stringify(a.property);r[u]=JSON.stringify(a.options);p.push(o.animate(t.getId(),n[u],r[u]))}}else{r[u]=JSON.stringify(r[u]);n[u]=JSON.stringify(n[u]);p.push(o.animate(t.getId(),n[u],r[u]))}}return p};e.mapAnimation=function(e,t,n){param.required(e);param.required(t);param.required(n);return e.mapAnimation(t,n)};e.loadManifest=function(e,t){param.required(e);t=param.optional(t,function(){});return window.AdefyGLI.Engine().loadManifest(e,t)};e.createRectangleActor=function(e,t,n,r,i,s,o){param.required(e);param.required(t);param.required(n);param.required(r);return new AJSRectangle({position:{x:e,y:t},color:{r:i,g:s,b:o},w:n,h:r})};e.createSquareActor=function(t,n,r,i,s,o){return e.createRectangleActor(t,n,r,r,i,s,o)};e.createCircleActor=function(e,t,n,r,i,s){param.required(e);param.required(t);param.required(n);return new AJSPolygon({position:{x:e,y:t},color:{r:r,g:i,b:s},radius:n,segments:32})};e.createTriangleActor=function(e,t,n,r,i,s,o){param.required(e);param.required(t);param.required(n);param.required(r);if(i===void 0){i=Math.floor(Math.random()*255)}if(s===void 0){s=Math.floor(Math.random()*255)}if(o===void 0){o=Math.floor(Math.random()*255)}return new AJSTriangle({position:{x:e,y:t},color:{r:i,g:s,b:o},base:n,height:r})};return e}()
